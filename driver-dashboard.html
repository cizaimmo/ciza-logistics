<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Outil Chauffeur | Ciza Logistics</title>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:Arial,Helvetica,sans-serif;background:#f4f6f9;color:#111;}
.container{width:95%;max-width:1200px;margin:auto;}

header{background:#000;color:#fff;padding:18px 0;text-align:center;}
header img{height:70px;}
header h1{font-size:18px;margin-top:8px;color:#D4AF37;}

.top-info{
margin-top:15px;
background:#000;
color:#fff;
padding:15px;
border-radius:14px;
display:flex;
justify-content:space-between;
align-items:center;
flex-wrap:wrap;
gap:10px;
}

.badge{
padding:6px 12px;
border-radius:999px;
font-size:12px;
font-weight:900;
background:#2e7d32;
}

.logout-btn{
background:#D4AF37;
color:#000;
border:none;
padding:8px 14px;
border-radius:10px;
font-weight:900;
cursor:pointer;
}

.section{
margin-top:20px;
background:#fff;
padding:20px;
border-radius:16px;
box-shadow:0 10px 25px rgba(0,0,0,0.05);
}

.section h2{
font-size:16px;
margin-bottom:15px;
color:#D4AF37;
}

input,button{
width:100%;
padding:14px;
border-radius:12px;
border:1px solid #ddd;
font-size:15px;
margin-top:8px;
}

button{
background:#000;
color:#fff;
font-weight:900;
cursor:pointer;
}

button.gold{
background:#D4AF37;
color:#000;
}

video{
width:100%;
border-radius:12px;
margin-top:10px;
}

canvas{
border:1px solid #ccc;
border-radius:12px;
width:100%;
height:150px;
margin-top:10px;
}

footer{
background:#000;
color:#bbb;
padding:50px 0;
margin-top:60px;
border-top:1px solid rgba(212,175,55,0.3);
text-align:center;
font-size:12px;
}
</style>
</head>

<body>

<header>
<img src="https://raw.githubusercontent.com/cizaimmo/ciza-logistics/4b1ea6a2d3697e3982880984ee31dca42d8c52fc/logo.png">
<h1>Outil Chauffeur</h1>
</header>

<div class="container">

<div class="top-info">
<div>
<div id="driverName">Chargement...</div>
<div class="badge">Validé</div>
</div>
<button class="logout-btn" id="logoutBtn">Déconnexion</button>
</div>

<div class="section">
<h2>Scanner Colis</h2>
<video id="video" autoplay playsinline></video>
<button onclick="startScanner()">Démarrer Scanner</button>
<button onclick="stopScanner()">Arrêter Scanner</button>
</div>

<div class="section" id="deliverySection" style="display:none;">
<h2>Finaliser Livraison</h2>
<input type="text" id="otpInput" placeholder="Entrer OTP client">
<input type="file" accept="image/*" capture="environment" id="photoInput">
<canvas id="signatureCanvas"></canvas>
<button class="gold" onclick="clearSignature()">Effacer signature</button>
<button class="gold" onclick="completeDelivery()">Confirmer Livraison</button>
</div>

</div>

<footer>
<img src="https://raw.githubusercontent.com/cizaimmo/ciza-logistics/4b1ea6a2d3697e3982880984ee31dca42d8c52fc/logo.png" style="height:50px;margin-bottom:15px;">
<div style="font-weight:900;color:#D4AF37;margin-bottom:8px;">
Ciza Logistics
</div>
<div>
Division officielle de <strong style="color:#fff;">Ciza Group</strong>
</div>
<div style="margin-top:20px;font-size:11px;color:#666;">
Plateforme interne sécurisée destinée exclusivement aux chauffeurs autorisés.
</div>
<div style="margin-top:15px;font-size:11px;color:#555;">
© 2026 Ciza Logistics – Tous droits réservés.
</div>
</footer>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig={
apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
authDomain:"ciza-logistics.firebaseapp.com",
projectId:"ciza-logistics"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);
const storage=getStorage(app);

let currentShipment=null;
let currentUser=null;

onAuthStateChanged(auth,async(user)=>{
if(!user){location.href="login.html";return;}
currentUser=user;
const snap=await getDoc(doc(db,"users",user.uid));
const data=snap.data();
if(data.role!=="driver"||data.accountStatus!=="approved"){
alert("Accès refusé.");
signOut(auth);
return;
}
document.getElementById("driverName").innerText=data.fullName;
});

document.getElementById("logoutBtn").addEventListener("click",async ()=>{
if(confirm("Confirmer la déconnexion ?")){
await signOut(auth);
location.href="login.html";
}
});

let codeReader;
let stream;

window.startScanner = async function(){
const video=document.getElementById("video");
codeReader = new ZXing.BrowserMultiFormatReader();
stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
video.srcObject=stream;

codeReader.decodeFromVideoElement(video,(result)=>{
if(result){
stopScanner();
handleScan(result.text);
}
});
};

window.stopScanner = function(){
if(codeReader) codeReader.reset();
if(stream) stream.getTracks().forEach(track=>track.stop());
};

async function handleScan(code){
const snap=await getDoc(doc(db,"shipments",code));
if(!snap.exists()){alert("Colis introuvable");return;}
const data=snap.data();
if(data.assignedDriverId!==currentUser.uid){
alert("Colis non assigné à vous");
return;
}
currentShipment=code;
document.getElementById("deliverySection").style.display="block";
}

/* SIGNATURE */
const canvas=document.getElementById("signatureCanvas");
const ctx=canvas.getContext("2d");
canvas.width=canvas.offsetWidth;
canvas.height=150;
let drawing=false;

function getPos(e){
const rect=canvas.getBoundingClientRect();
return e.touches ?
{x:e.touches[0].clientX-rect.left,y:e.touches[0].clientY-rect.top} :
{x:e.clientX-rect.left,y:e.clientY-rect.top};
}

canvas.addEventListener("mousedown",()=>drawing=true);
canvas.addEventListener("mouseup",()=>drawing=false);
canvas.addEventListener("mousemove",(e)=>{
if(!drawing)return;
const p=getPos(e);
ctx.lineWidth=2;
ctx.lineTo(p.x,p.y);
ctx.stroke();
});

canvas.addEventListener("touchstart",(e)=>{drawing=true;e.preventDefault();});
canvas.addEventListener("touchend",()=>drawing=false);
canvas.addEventListener("touchmove",(e)=>{
if(!drawing)return;
const p=getPos(e);
ctx.lineWidth=2;
ctx.lineTo(p.x,p.y);
ctx.stroke();
e.preventDefault();
});

window.clearSignature=function(){
ctx.clearRect(0,0,canvas.width,canvas.height);
};

window.completeDelivery=async function(){
const snap=await getDoc(doc(db,"shipments",currentShipment));
const data=snap.data();

if(document.getElementById("otpInput").value!==data.deliveryOTP){
alert("OTP incorrect");
return;
}

const photoFile=document.getElementById("photoInput").files[0];
if(!photoFile){alert("Photo obligatoire");return;}

const photoRef=ref(storage,"deliveries/"+currentShipment+"/photo.jpg");
await uploadBytes(photoRef,photoFile);
const photoURL=await getDownloadURL(photoRef);

const blob=await (await fetch(canvas.toDataURL("image/png"))).blob();
const sigRef=ref(storage,"deliveries/"+currentShipment+"/signature.png");
await uploadBytes(sigRef,blob);
const sigURL=await getDownloadURL(sigRef);

await updateDoc(doc(db,"shipments",currentShipment),{
status:"delivered",
deliveryPhoto:photoURL,
receiverSignature:sigURL,
deliveredAt:serverTimestamp()
});

alert("Livraison confirmée");
document.getElementById("deliverySection").style.display="none";
};

</script>

</body>
</html>
