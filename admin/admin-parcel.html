<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Ciza Group | Division Logistics ERP</title>

<link rel="manifest" href="../manifest.json" />
<meta name="theme-color" content="#000000" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
:root{
  --gold:#D4AF37;
  --black:#000000;
  --bg:#0f1115;
  --panel:#0b0b0c;
  --soft:#f4f6f9;
  --card:#ffffff;
  --muted:#6b7280;
  --border:rgba(212,175,55,.28);
  --radius:16px;
  --footerH:64px;
  --sidebarW:290px;
  --safeB: env(safe-area-inset-bottom, 0px);
  --safeT: env(safe-area-inset-top, 0px);
}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{
  font-family:Inter,Arial;
  background:var(--bg);
  color:#111;
  min-height:100vh;
  padding-bottom: calc(var(--safeB) + 8px);
}
a{color:inherit}
button, input, select, textarea{font-family:inherit}

/* APP SHELL */
.app{display:flex;min-height:100vh}

/* HAMBURGER */
.hamburger{
  display:none;
  position:fixed;
  top: calc(14px + var(--safeT));
  left:14px;
  background:#000;
  border:1px solid rgba(212,175,55,.35);
  padding:10px 12px;
  border-radius:12px;
  cursor:pointer;
  z-index:2500;
  box-shadow:0 14px 40px rgba(0,0,0,.35);
}
.hamburger span{display:block;width:22px;height:2px;background:var(--gold);margin:4px 0;border-radius:3px}

/* OVERLAY */
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.65);
  opacity:0;pointer-events:none;transition:.25s;z-index:2400;
}
.menu-open .overlay{opacity:1;pointer-events:auto}

/* SIDEBAR */
.sidebar{
  width:var(--sidebarW);
  background:#000;
  color:#fff;
  display:flex;
  flex-direction:column;
  padding:18px 16px;
  position:fixed;
  top:0;left:0;
  height:100vh;
  z-index:2450;
  box-shadow:6px 0 30px rgba(0,0,0,.45);
  transition:.25s;
  overflow:auto;
  overscroll-behavior:contain;
}
.brand{
  display:flex;
  align-items:center;
  gap:12px;
  padding:8px 8px 16px;
  border-bottom:1px solid rgba(255,255,255,.08);
  margin-bottom:12px;
}
.brand img{
  width:62px;height:62px;border-radius:16px;
  border:1px solid rgba(212,175,55,.35);
  box-shadow:0 18px 50px rgba(0,0,0,.35);
  background:#0b0b0c;object-fit:cover;
}
.brand .t1{font-weight:900;color:var(--gold);font-size:14px;letter-spacing:.3px;line-height:1.1}
.brand .t2{font-size:11px;color:rgba(255,255,255,.78);margin-top:4px;letter-spacing:.4px}
.brand .t3{font-size:11px;color:rgba(255,255,255,.60);margin-top:6px;font-weight:800}

.nav{padding:6px 0}
.nav button{
  all:unset;
  display:flex;align-items:center;gap:10px;
  width:100%;
  padding:12px 14px;
  border-radius:14px;
  cursor:pointer;
  font-weight:900;
  font-size:13px;
  letter-spacing:.2px;
  color:#fff;
  border:1px solid rgba(255,255,255,.06);
  background:rgba(255,255,255,.03);
  margin-bottom:10px;
}
.nav button:hover{border-color:rgba(212,175,55,.25);background:rgba(212,175,55,.10);color:var(--gold)}
.nav button.active{background:var(--gold);color:#000;border-color:rgba(212,175,55,.55)}
.nav small{display:block;font-weight:800;color:rgba(255,255,255,.65);font-size:11px;margin:8px 2px 10px}

.sidebar-bottom{
  margin-top:auto;
  padding-top:12px;
  border-top:1px solid rgba(255,255,255,.08);
  display:flex;
  flex-direction:column;
  gap:10px;
}
.userchip{
  border:1px solid rgba(212,175,55,.22);
  background:rgba(255,255,255,.04);
  padding:10px 12px;border-radius:14px;
  font-size:12px;line-height:1.5;
}
.userchip b{color:var(--gold)}
.logout-btn{
  background:var(--gold);
  border:none;
  padding:12px 14px;
  border-radius:14px;
  font-weight:900;
  cursor:pointer;
}
.logout-btn:active{transform:scale(.99)}

/* MAIN */
.main{
  margin-left:var(--sidebarW);
  flex:1;
  background:var(--soft);
  min-height:100vh;
  padding:18px 18px calc(var(--footerH) + var(--safeB) + 90px);
  transition:.25s;
  width:calc(100% - var(--sidebarW));
  overflow-x:hidden; /* anti d√©bordement horizontal */
}
.topline{
  display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap;
  margin-bottom:12px;
}
.header-title{font-size:22px;font-weight:900;color:#0b0b0c}
.header-sub{font-size:12px;color:#4b5563;margin-top:6px;font-weight:700}
.clock{
  background:#000;color:var(--gold);
  border:1px solid rgba(212,175,55,.35);
  padding:10px 12px;border-radius:14px;
  font-weight:900;font-size:12px;letter-spacing:.3px;
  min-width:170px;text-align:center;
}

/* KPI */
.kpi-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
  gap:12px;
  margin:12px 0 14px;
}
.kpi{
  background:linear-gradient(135deg,#000,#101012);
  color:var(--gold);
  padding:16px;
  border-radius:18px;
  text-align:center;
  font-weight:900;
  border:1px solid rgba(212,175,55,.25);
  box-shadow:0 18px 50px rgba(0,0,0,.12);
}
.kpi small{display:block;color:rgba(255,255,255,.85);opacity:.95;margin-top:6px;font-size:11px;font-weight:800}

/* TOOLBAR */
.toolbar{
  display:flex;gap:10px;flex-wrap:wrap;align-items:center;
  background:#fff;border:1px solid rgba(0,0,0,.06);
  border-radius:18px;padding:12px;
  box-shadow:0 10px 28px rgba(0,0,0,.06);
  margin-bottom:14px;
}
.toolbar input,.toolbar select{
  padding:11px 12px;border-radius:14px;border:1px solid rgba(0,0,0,.12);
  font-weight:700;font-size:12px;background:#fff;outline:none;
  max-width:100%;
}
.toolbar input{flex:1;min-width:230px}
.toolbar .btn{
  background:#000;color:var(--gold);
  border:1px solid rgba(212,175,55,.35);
  padding:11px 12px;border-radius:14px;
  font-weight:900;font-size:12px;cursor:pointer;
  white-space:nowrap;
}
.toolbar .btn:active{transform:scale(.99)}
.toolbar .btn.secondary{background:#fff;color:#000;border:1px solid rgba(0,0,0,.12)}

/* CARDS */
.grid-cards{display:grid;grid-template-columns:1fr;gap:12px}
.card{
  background:#fff;
  border-radius:18px;
  padding:16px;
  border:1px solid rgba(0,0,0,.06);
  box-shadow:0 12px 36px rgba(0,0,0,.08);
  overflow:hidden;
  min-width:0;
}
.card-head{
  display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;
}
.tracking{font-weight:900;font-size:14px;color:#000;word-break:break-word}
.route{font-size:12px;color:#4b5563;margin-top:4px;font-weight:700;word-break:break-word}
.badge{
  display:inline-block;
  padding:7px 12px;
  border-radius:999px;
  font-size:11px;
  font-weight:900;
  letter-spacing:.4px;
  text-transform:uppercase;
  color:#fff;
}
.meta-wrap{
  display:grid;
  grid-template-columns:1fr;
  gap:10px;
  margin-top:12px;
  min-width:0;
}
@media(min-width:980px){
  .grid-cards{grid-template-columns:1fr 1fr}
  .meta-wrap{grid-template-columns:1.15fr 1fr}
}
.meta{
  font-size:12px;
  line-height:1.55;
  color:#111827;
  word-break:break-word;
  min-width:0;
}
.meta b{color:#000}
.hr{height:1px;background:rgba(0,0,0,.08);margin:12px 0}
.controls{
  display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;
  padding-bottom:6px; /* √©vite bouton coll√© au footer */
}
.controls button,.controls select{
  padding:10px 12px;border-radius:14px;font-weight:900;font-size:12px;cursor:pointer;border:none;
  max-width:100%;
}
.controls button.primary{background:var(--gold);color:#000}
.controls button.dark{background:#000;color:var(--gold);border:1px solid rgba(212,175,55,.35)}
.controls button.ghost{background:#fff;color:#111;border:1px solid rgba(0,0,0,.12)}
.controls button:disabled{opacity:.55;cursor:not-allowed}
.controls button:active{transform:scale(.99)}
.controls select{
  border:1px solid rgba(0,0,0,.14);background:#fff;color:#111;
  min-width:220px;
}

/* VIEWS */
.view{display:none}
.view.active{display:block}

/* MAP */
#map{
  height:420px;
  border-radius:18px;
  border:1px solid rgba(0,0,0,.08);
  overflow:hidden;
  background:#e5e7eb;
}
.mapbar{
  display:flex;gap:10px;flex-wrap:wrap;align-items:center;
  margin-top:12px;
}
.mapbar .chip{
  background:#000;color:var(--gold);
  border:1px solid rgba(212,175,55,.35);
  padding:10px 12px;border-radius:14px;
  font-weight:900;font-size:12px;
}
.mapbar .chip.light{
  background:#fff;color:#000;border:1px solid rgba(0,0,0,.12);
}
.mapbar .btn{
  background:#000;color:var(--gold);
  border:1px solid rgba(212,175,55,.35);
  padding:11px 12px;border-radius:14px;
  font-weight:900;font-size:12px;cursor:pointer;
}
.mapbar .btn.secondary{background:#fff;color:#000;border:1px solid rgba(0,0,0,.12)}
.mapbar select{
  padding:11px 12px;border-radius:14px;border:1px solid rgba(0,0,0,.12);
  font-weight:800;font-size:12px;background:#fff;outline:none;
  min-width:260px;max-width:100%;
}

/* FORMS */
.form-grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:900px){.form-grid{grid-template-columns:1fr 1fr}}
.field label{
  display:block;font-size:11px;font-weight:900;letter-spacing:.6px;
  text-transform:uppercase;color:#111;margin-bottom:6px
}
.field input,.field textarea,.field select{
  width:100%;
  padding:12px 12px;border-radius:14px;
  border:1px solid rgba(0,0,0,.14);
  font-weight:700;font-size:12px;outline:none;
}
.field textarea{min-height:92px;resize:none}
.note{
  font-size:12px;color:#4b5563;line-height:1.55;background:rgba(212,175,55,.10);
  border:1px solid rgba(212,175,55,.22);
  padding:12px;border-radius:16px;
}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.pill{
  background:rgba(0,0,0,.06);
  border:1px solid rgba(0,0,0,.08);
  padding:8px 10px;border-radius:999px;
  font-weight:900;font-size:12px;
}

/* UPLOAD UI */
.uploader{
  border:1px dashed rgba(0,0,0,.18);
  border-radius:16px;
  padding:12px;
  background:rgba(0,0,0,.02);
}
.uploader .row{
  justify-content:space-between;
}
.progress{
  width:100%;
  height:10px;
  border-radius:999px;
  background:rgba(0,0,0,.08);
  overflow:hidden;
  border:1px solid rgba(0,0,0,.10);
}
.progress > div{
  height:100%;
  width:0%;
  background:linear-gradient(90deg, #000, var(--gold));
  transition:width .15s ease;
}

/* MODAL */
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.65);
  display:none;align-items:center;justify-content:center;
  z-index:4000;padding:18px;
}
.modal.open{display:flex}
.modal-card{
  width:100%;
  max-width:920px;
  background:#fff;border-radius:22px;
  border:1px solid rgba(212,175,55,.22);
  box-shadow:0 40px 120px rgba(0,0,0,.35);
  overflow:hidden;
}
.modal-top{
  background:#000;color:#fff;
  padding:16px 16px;
  display:flex;align-items:center;justify-content:space-between;gap:10px;
}
.modal-top .ttl{font-weight:900;color:var(--gold);letter-spacing:.3px}
.modal-close{
  width:42px;height:42px;border-radius:14px;
  border:1px solid rgba(255,255,255,.15);
  background:transparent;color:#fff;font-size:20px;cursor:pointer;
}
.modal-body{padding:16px}
.modal-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.modal-actions button{
  padding:12px 14px;border-radius:14px;font-weight:900;font-size:12px;cursor:pointer;border:none;
}
.modal-actions .save{background:var(--gold);color:#000}
.modal-actions .dark{background:#000;color:var(--gold);border:1px solid rgba(212,175,55,.35)}
.modal-actions .ghost{background:#fff;border:1px solid rgba(0,0,0,.14)}
.modal-actions button:disabled{opacity:.55;cursor:not-allowed}

.preview{
  display:grid;
  grid-template-columns:1fr;
  gap:10px;
}
@media(min-width:900px){.preview{grid-template-columns:1fr 1fr}}
.preview img{
  width:100%;
  border-radius:16px;
  border:1px solid rgba(0,0,0,.10);
  background:#f3f4f6;
  object-fit:contain;
  max-height:340px;
}

/* FOOTER */
.footer{
  position:fixed;
  left:var(--sidebarW);right:0;bottom:0;
  height:calc(var(--footerH) + var(--safeB));
  background:#000;color:#fff;
  border-top:1px solid rgba(212,175,55,.22);
  padding:0 14px calc(var(--safeB) + 8px);
  font-size:11px;
  display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
  z-index:2000;
}
.footer b{color:var(--gold)}
.footer .mini{opacity:.85}
.footer .pill2{
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);
  padding:7px 10px;border-radius:999px;font-weight:900;letter-spacing:.2px
}

/* MOBILE */
@media(max-width:900px){
  .sidebar{transform:translateX(-100%)}
  .menu-open .sidebar{transform:translateX(0)}
  .main{margin-left:0;width:100%;padding:72px 14px calc(var(--footerH) + var(--safeB) + 110px)}
  .hamburger{display:block}
  .footer{left:0}
}
</style>
</head>

<body>

<div class="hamburger" id="hamburgerBtn" aria-label="Menu">
  <span></span><span></span><span></span>
</div>
<div class="overlay" id="overlay"></div>

<div class="app">

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="brand">
    <!-- LOGO HEADER -->
    <img src="https://raw.githubusercontent.com/cizaimmo/ciza-logistics/1c3925b21a4fc0ad51cb5ef0b61006b6b51127fe/admin/1DC0144B-C385-4C62-B3BF-179B3931AE3A.png" alt="Ciza Group Logistics" />
    <div>
      <div class="t1">CIZA GROUP</div>
      <div class="t2">Division Logistics ‚Ä¢ Back Office</div>
      <div class="t3" id="envLabel">ERP ‚Ä¢ Admin</div>
    </div>
  </div>

  <div class="nav" id="nav">
    <small>Modules</small>
    <button type="button" class="active" data-view="colis">üì¶ Colis</button>
    <button type="button" data-view="commandes">üó∫ Commandes (GPS)</button>
    <button type="button" data-view="chauffeurs">üöö Chauffeurs (Dossier)</button>
    <button type="button" data-view="paiements">üí∞ Paiements Chauffeurs</button>
    <button type="button" data-view="messagerie">üí¨ Messagerie</button>
    <button type="button" data-view="planning">üìÖ Planning</button>
    <button type="button" data-view="bureau">üè¢ Bureau</button>
    <button type="button" data-view="entreprise">üè≠ Entreprise</button>
  </div>

  <div class="sidebar-bottom">
    <div class="userchip">
      Connect√© : <b id="userName">‚Äî</b><br />
      R√¥le : <b id="userRole">‚Äî</b>
    </div>
    <button class="logout-btn" id="logoutBtn">D√©connexion</button>
  </div>
</aside>

<!-- MAIN -->
<main class="main">

  <div class="topline">
    <div>
      <div class="header-title" id="pageTitle">Gestion des Colis</div>
      <div class="header-sub" id="pageSub">Recherche ‚Ä¢ D√©tails ‚Ä¢ Paiement ‚Ä¢ Assignation ‚Ä¢ Impression</div>
    </div>
    <div class="clock" id="clock">‚Äî</div>
  </div>

  <!-- ==================== VUE COLIS ==================== -->
  <section id="view-colis" class="view active">

    <div class="kpi-grid">
      <div class="kpi"><div id="kpiPayment">0</div><small>En attente paiement</small></div>
      <div class="kpi"><div id="kpiReady">0</div><small>Pr√™t enl√®vement</small></div>
      <div class="kpi"><div id="kpiAssigned">0</div><small>Assign√©</small></div>
      <div class="kpi"><div id="kpiTransit">0</div><small>En transit</small></div>
      <div class="kpi"><div id="kpiDelivered">0</div><small>Livr√©</small></div>
      <div class="kpi"><div id="kpiRevenue">0</div><small>Chiffre d‚Äôaffaires</small></div>
    </div>

    <div class="toolbar">
      <input id="searchInput" placeholder="Recherche tracking / nom / t√©l√©phone / province / quartier" />
      <select id="statusFilter">
        <option value="">Tous statuts</option>
        <option value="payment_under_review">En attente paiement</option>
        <option value="ready_for_pickup">Pr√™t enl√®vement</option>
        <option value="assigned">Assign√©</option>
        <option value="in_transit">En transit</option>
        <option value="delivered">Livr√©</option>
      </select>
      <button class="btn secondary" type="button" id="clearBtn">Effacer</button>
      <button class="btn" type="button" id="refreshBtn">Rafra√Æchir</button>
    </div>

    <div class="grid-cards" id="parcelList"></div>

  </section>

  <!-- ==================== COMMANDES / GPS ==================== -->
  <section id="view-commandes" class="view">
    <div class="card">
      <div class="card-head">
        <div>
          <div class="tracking">Suivi GPS (Uber-like)</div>
          <div class="route">Carte + itin√©raire + ETA</div>
        </div>
        <span class="badge" style="background:#000">LIVE</span>
      </div>

      <div class="hr"></div>

      <div class="mapbar">
        <select id="trackShipmentSelect">
          <option value="">Choisir un colis √† suivre (si coordonn√©es disponibles)</option>
        </select>

        <button class="btn secondary" type="button" id="locateMeBtn">üìç Ma position</button>
        <button class="btn" type="button" id="recenterBtn">üéØ Recentrer</button>

        <div class="chip light" id="routeInfoChip">Distance: ‚Äî ‚Ä¢ ETA: ‚Äî</div>
        <div class="chip" id="gpsChip">GPS: ‚Äî</div>
      </div>

      <div class="hr"></div>

      <div id="map"></div>

      <div class="hr"></div>

      <div class="note" id="gpsHelpNote">
        Le suivi ‚ÄúUber-like‚Äù fonctionne automatiquement quand le colis poss√®de des coordonn√©es (d√©part/destination) et qu‚Äôun chauffeur remonte sa position live.
      </div>
    </div>
  </section>

  <!-- ==================== CHAUFFEURS ==================== -->
  <section id="view-chauffeurs" class="view">
    <div class="card">
      <div class="card-head">
        <div>
          <div class="tracking">Dossiers Chauffeurs</div>
          <div class="route">Fiche compl√®te ‚Ä¢ Documents ‚Ä¢ Acc√®s rapide</div>
        </div>
        <span class="badge" style="background:#000">ERP</span>
      </div>

      <div class="hr"></div>

      <div class="toolbar" style="margin-bottom:0">
        <input id="driverSearch" placeholder="Recherche chauffeur: nom / t√©l√©phone / province / email" />
        <button class="btn secondary" type="button" id="driverClear">Effacer</button>
      </div>

      <div class="hr"></div>

      <div class="grid-cards" id="driversList"></div>
    </div>
  </section>

  <!-- ==================== PAIEMENTS ==================== -->
  <section id="view-paiements" class="view">
    <div class="card">
      <div class="card-head">
        <div>
          <div class="tracking">Paiements Chauffeurs</div>
          <div class="route">Calcul automatique</div>
        </div>
        <span class="badge" style="background:#000">FINANCE</span>
      </div>

      <div class="hr"></div>

      <div class="kpi-grid" style="margin:0 0 10px">
        <div class="kpi"><div id="payRate">0</div><small>Taux / colis</small></div>
        <div class="kpi"><div id="payDelivered">0</div><small>Colis livr√©s</small></div>
        <div class="kpi"><div id="payTotalDue">0</div><small>Total d√ª chauffeurs</small></div>
        <div class="kpi"><div id="payNet">0</div><small>Net entreprise</small></div>
      </div>

      <div class="grid-cards" id="paymentsList"></div>
    </div>
  </section>

  <!-- ==================== MESSAGERIE (INBOX) ==================== -->
  <section id="view-messagerie" class="view">
    <div class="card">
      <div class="card-head">
        <div>
          <div class="tracking">Messagerie interne</div>
          <div class="route">Bo√Æte de r√©ception ‚Ä¢ Envoy√©s</div>
        </div>
        <span class="badge" style="background:#000">INBOX</span>
      </div>

      <div class="hr"></div>

      <div class="toolbar" style="margin-bottom:0">
        <select id="msgBox">
          <option value="inbox">Bo√Æte de r√©ception</option>
          <option value="sent">Envoy√©s</option>
          <option value="all">Tout</option>
        </select>
        <input id="msgSearch" placeholder="Rechercher dans messages (objet/texte/exp√©diteur)" />
        <button class="btn secondary" type="button" id="msgClear">Effacer</button>
      </div>

      <div class="hr"></div>

      <div class="form-grid">
        <div class="field">
          <label>Destinataire</label>
          <input id="msgTo" placeholder="Ex: uid / email / bureau / admin / superadmin" />
        </div>
        <div class="field">
          <label>Objet</label>
          <input id="msgSubject" placeholder="Ex: Suivi colis / Paiement chauffeur" />
        </div>
        <div class="field" style="grid-column:1/-1">
          <label>Message</label>
          <textarea id="msgBody" placeholder="√âcris ton message ici..."></textarea>
        </div>
      </div>

      <div class="modal-actions">
        <button class="save" type="button" id="sendMsgBtn">Envoyer</button>
        <button class="ghost" type="button" id="refreshMsgBtn">Rafra√Æchir</button>
      </div>

      <div class="hr"></div>

      <div class="grid-cards" id="messagesList"></div>
    </div>
  </section>

  <!-- ==================== PLANNING ==================== -->
  <section id="view-planning" class="view">
    <div class="card">
      <div class="card-head">
        <div>
          <div class="tracking">Planning</div>
          <div class="route">Rendez-vous internes</div>
        </div>
        <span class="badge" style="background:#000">CAL</span>
      </div>

      <div class="hr"></div>

      <div class="form-grid">
        <div class="field">
          <label>Titre</label>
          <input id="calTitle" placeholder="Ex: R√©union chauffeurs" />
        </div>
        <div class="field">
          <label>Date & Heure</label>
          <input id="calWhen" type="datetime-local" />
        </div>
        <div class="field">
          <label>Lieu</label>
          <input id="calWhere" placeholder="Ex: Bureau Gitega" />
        </div>
        <div class="field">
          <label>Assign√© √†</label>
          <input id="calTo" placeholder="Ex: uid / email / bureau" />
        </div>
        <div class="field" style="grid-column:1/-1">
          <label>Notes</label>
          <textarea id="calNotes" placeholder="D√©tails..."></textarea>
        </div>
      </div>

      <div class="modal-actions">
        <button class="save" type="button" id="calSaveBtn">Ajouter</button>
        <button class="ghost" type="button" id="calRefreshBtn">Rafra√Æchir</button>
      </div>

      <div class="hr"></div>

      <div class="grid-cards" id="calendarList"></div>
    </div>
  </section>

  <!-- ==================== BUREAU ==================== -->
  <section id="view-bureau" class="view">
    <div class="card">
      <div class="card-head">
        <div>
          <div class="tracking">Bureau</div>
          <div class="route">Suivi appels ‚Ä¢ Notes</div>
        </div>
        <span class="badge" style="background:#000">OFFICE</span>
      </div>

      <div class="hr"></div>

      <div class="form-grid">
        <div class="field">
          <label>Client / Contact</label>
          <input id="officeName" placeholder="Nom / entreprise" />
        </div>
        <div class="field">
          <label>T√©l√©phone</label>
          <input id="officePhone" placeholder="+257..." />
        </div>
        <div class="field">
          <label>Objet</label>
          <input id="officeTopic" placeholder="Ex: r√©clamation, contrat, suivi" />
        </div>
        <div class="field">
          <label>Priorit√©</label>
          <select id="officePriority">
            <option value="normal">Normal</option>
            <option value="urgent">Urgent</option>
          </select>
        </div>
        <div class="field" style="grid-column:1/-1">
          <label>Notes</label>
          <textarea id="officeNotes" placeholder="√âl√©ments importants..."></textarea>
        </div>
      </div>

      <div class="modal-actions">
        <button class="save" type="button" id="officeSaveBtn">Enregistrer</button>
        <button class="ghost" type="button" id="officeRefreshBtn">Rafra√Æchir</button>
      </div>

      <div class="hr"></div>

      <div class="grid-cards" id="officeList"></div>
    </div>
  </section>

  <!-- ==================== ENTREPRISE ==================== -->
  <section id="view-entreprise" class="view">
    <div class="card">
      <div class="card-head">
        <div>
          <div class="tracking">Entreprise</div>
          <div class="route">Param√®tres</div>
        </div>
        <span class="badge" style="background:#000">HQ</span>
      </div>

      <div class="hr"></div>

      <div class="form-grid">
        <div class="field">
          <label>Paiement chauffeur / colis (BIF)</label>
          <input id="entDriverPay" placeholder="Chargement..." inputmode="numeric" />
        </div>
        <div class="field">
          <label>Mode</label>
          <input id="entMode" placeholder="‚Äî" disabled />
        </div>
        <div class="field">
          <label>Version Cache</label>
          <input id="entCache" placeholder="‚Äî" disabled />
        </div>
        <div class="field">
          <label>Scope</label>
          <input id="entScope" placeholder="‚Äî" disabled />
        </div>
        <div class="field" style="grid-column:1/-1">
          <label>Informations</label>
          <textarea id="entInfo" disabled></textarea>
        </div>
      </div>

      <div class="modal-actions">
        <button class="save" type="button" id="entSaveBtn">Enregistrer</button>
        <button class="ghost" type="button" id="entRefreshBtn">Rafra√Æchir</button>
      </div>

      <div class="hr"></div>

      <div class="note" id="enterpriseHint">
        Gestion s√©curis√©e des param√®tres. Certains champs peuvent √™tre en lecture seule selon ton r√¥le.
      </div>
    </div>
  </section>

</main>

</div>

<footer class="footer">
  <div><b>Ciza Group</b> ‚Ä¢ Division Logistics Back Office</div>
  <div class="mini">¬© 2026 ‚Ä¢ Admin</div>
  <div class="pill2" id="pwaMode">Mode: ‚Äî</div>
</footer>

<!-- MODAL DRIVER DOSSIER -->
<div class="modal" id="driverModal">
  <div class="modal-card">
    <div class="modal-top">
      <div class="ttl" id="driverModalTitle">Dossier Chauffeur</div>
      <button class="modal-close" id="driverModalClose" type="button">√ó</button>
    </div>
    <div class="modal-body">

      <div class="form-grid">
        <div class="field">
          <label>Nom complet</label>
          <input id="dmFullName" placeholder="‚Äî" disabled />
        </div>
        <div class="field">
          <label>T√©l√©phone</label>
          <input id="dmPhone" placeholder="‚Äî" disabled />
        </div>
        <div class="field">
          <label>Province</label>
          <input id="dmProvince" placeholder="‚Äî" disabled />
        </div>
        <div class="field">
          <label>Email</label>
          <input id="dmEmail" placeholder="‚Äî" disabled />
        </div>

        <div class="field" style="grid-column:1/-1">
          <label>Lien pi√®ce / dossier (optionnel)</label>
          <input id="dmDocUrl" placeholder="Lien URL (optionnel)" />
        </div>

        <div class="field" style="grid-column:1/-1">
          <div class="uploader">
            <div class="row" style="margin-bottom:10px">
              <div class="pill">Upload pi√®ce/dossier (max 10MB)</div>
              <div class="pill" id="dmDocUploadState">‚Äî</div>
            </div>
            <input type="file" id="dmDocFile" accept=".pdf,.jpg,.jpeg,.png,.webp" />
            <div class="hr"></div>
            <div class="progress"><div id="dmDocProgress"></div></div>
            <div class="modal-actions" style="margin-top:10px">
              <button class="dark" type="button" id="dmDocUploadBtn">T√©l√©verser</button>
              <button class="ghost" type="button" id="dmDocOpenBtn" disabled>Ouvrir</button>
            </div>
          </div>
        </div>

        <div class="field" style="grid-column:1/-1">
          <label>Lien contrat / facture (optionnel)</label>
          <input id="dmInvoiceUrl" placeholder="Lien URL (optionnel)" />
        </div>

        <div class="field" style="grid-column:1/-1">
          <div class="uploader">
            <div class="row" style="margin-bottom:10px">
              <div class="pill">Upload contrat/facture (max 10MB)</div>
              <div class="pill" id="dmInvoiceUploadState">‚Äî</div>
            </div>
            <input type="file" id="dmInvoiceFile" accept=".pdf,.jpg,.jpeg,.png,.webp" />
            <div class="hr"></div>
            <div class="progress"><div id="dmInvoiceProgress"></div></div>
            <div class="modal-actions" style="margin-top:10px">
              <button class="dark" type="button" id="dmInvoiceUploadBtn">T√©l√©verser</button>
              <button class="ghost" type="button" id="dmInvoiceOpenBtn" disabled>Ouvrir</button>
            </div>
          </div>
        </div>

        <div class="field" style="grid-column:1/-1">
          <label>Notes admin</label>
          <textarea id="dmNotes" placeholder="Observations..."></textarea>
        </div>
      </div>

      <div class="modal-actions">
        <button class="save" type="button" id="driverModalSave">Enregistrer</button>
        <button class="dark" type="button" id="driverModalCall">Appeler</button>
        <button class="ghost" type="button" id="driverModalClose2">Fermer</button>
      </div>

    </div>
  </div>
</div>

<!-- MODAL PREUVE LIVRAISON -->
<div class="modal" id="proofModal">
  <div class="modal-card">
    <div class="modal-top">
      <div class="ttl" id="proofModalTitle">Preuve de livraison</div>
      <button class="modal-close" id="proofModalClose" type="button">√ó</button>
    </div>
    <div class="modal-body">

      <div class="note" id="proofInfoNote">
        Ajoute une photo (et/ou une signature) comme preuve de livraison. Maximum 10MB par fichier.
      </div>

      <div class="hr"></div>

      <div class="preview">
        <div>
          <div class="pill" style="margin-bottom:10px">Photo</div>
          <img id="proofPhotoPreview" alt="Photo preuve" />
          <div class="hr"></div>
          <div class="uploader">
            <div class="row" style="margin-bottom:10px">
              <div class="pill">Upload photo (max 10MB)</div>
              <div class="pill" id="proofPhotoState">‚Äî</div>
            </div>
            <input type="file" id="proofPhotoFile" accept=".jpg,.jpeg,.png,.webp" />
            <div class="hr"></div>
            <div class="progress"><div id="proofPhotoProgress"></div></div>
            <div class="modal-actions" style="margin-top:10px">
              <button class="dark" type="button" id="proofPhotoUploadBtn">T√©l√©verser</button>
              <button class="ghost" type="button" id="proofPhotoOpenBtn" disabled>Ouvrir</button>
            </div>
          </div>
        </div>

        <div>
          <div class="pill" style="margin-bottom:10px">Signature</div>
          <img id="proofSignPreview" alt="Signature preuve" />
          <div class="hr"></div>
          <div class="uploader">
            <div class="row" style="margin-bottom:10px">
              <div class="pill">Upload signature (max 10MB)</div>
              <div class="pill" id="proofSignState">‚Äî</div>
            </div>
            <input type="file" id="proofSignFile" accept=".jpg,.jpeg,.png,.webp" />
            <div class="hr"></div>
            <div class="progress"><div id="proofSignProgress"></div></div>
            <div class="modal-actions" style="margin-top:10px">
              <button class="dark" type="button" id="proofSignUploadBtn">T√©l√©verser</button>
              <button class="ghost" type="button" id="proofSignOpenBtn" disabled>Ouvrir</button>
            </div>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="form-grid">
        <div class="field">
          <label>Code de confirmation (optionnel)</label>
          <input id="proofOtp" placeholder="Ex: 1234" />
        </div>
        <div class="field">
          <label>Commentaire (optionnel)</label>
          <input id="proofNote" placeholder="Ex: livr√© au gardien" />
        </div>
      </div>

      <div class="modal-actions">
        <button class="save" type="button" id="proofSaveBtn">Enregistrer</button>
        <button class="ghost" type="button" id="proofCloseBtn">Fermer</button>
      </div>

    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, query, where, onSnapshot, doc, getDoc, getDocs,
  updateDoc, setDoc, addDoc, serverTimestamp, orderBy, limit
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
  getAuth, onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getStorage, ref as sRef, uploadBytesResumable, getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

/* ================= FIREBASE ================= */
const app = initializeApp({
  apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
  authDomain:"ciza-logistics.firebaseapp.com",
  projectId:"ciza-logistics",
  storageBucket:"ciza-logistics.appspot.com"
});
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

let currentUser=null;
let currentRole=null;
let currentEmail=null;

/* ================= UI REFS ================= */
const hamburgerBtn = document.getElementById("hamburgerBtn");
const overlay = document.getElementById("overlay");
const nav = document.getElementById("nav");
const pageTitle = document.getElementById("pageTitle");
const pageSub = document.getElementById("pageSub");

const envLabel = document.getElementById("envLabel");

const userName = document.getElementById("userName");
const userRole = document.getElementById("userRole");
const logoutBtn = document.getElementById("logoutBtn");

const searchInput = document.getElementById("searchInput");
const statusFilter = document.getElementById("statusFilter");
const clearBtn = document.getElementById("clearBtn");
const refreshBtn = document.getElementById("refreshBtn");
const parcelList = document.getElementById("parcelList");

const driverSearch = document.getElementById("driverSearch");
const driverClear = document.getElementById("driverClear");
const driversList = document.getElementById("driversList");

const paymentsList = document.getElementById("paymentsList");

const messagesList = document.getElementById("messagesList");
const msgTo = document.getElementById("msgTo");
const msgSubject = document.getElementById("msgSubject");
const msgBody = document.getElementById("msgBody");
const sendMsgBtn = document.getElementById("sendMsgBtn");
const refreshMsgBtn = document.getElementById("refreshMsgBtn");
const msgBox = document.getElementById("msgBox");
const msgSearch = document.getElementById("msgSearch");
const msgClear = document.getElementById("msgClear");

const calendarList = document.getElementById("calendarList");
const calTitle = document.getElementById("calTitle");
const calWhen = document.getElementById("calWhen");
const calWhere = document.getElementById("calWhere");
const calTo = document.getElementById("calTo");
const calNotes = document.getElementById("calNotes");
const calSaveBtn = document.getElementById("calSaveBtn");
const calRefreshBtn = document.getElementById("calRefreshBtn");

const officeList = document.getElementById("officeList");
const officeName = document.getElementById("officeName");
const officePhone = document.getElementById("officePhone");
const officeTopic = document.getElementById("officeTopic");
const officePriority = document.getElementById("officePriority");
const officeNotes = document.getElementById("officeNotes");
const officeSaveBtn = document.getElementById("officeSaveBtn");
const officeRefreshBtn = document.getElementById("officeRefreshBtn");

const entDriverPay = document.getElementById("entDriverPay");
const entMode = document.getElementById("entMode");
const entCache = document.getElementById("entCache");
const entScope = document.getElementById("entScope");
const entInfo = document.getElementById("entInfo");
const entSaveBtn = document.getElementById("entSaveBtn");
const entRefreshBtn = document.getElementById("entRefreshBtn");

const kpiPayment = document.getElementById("kpiPayment");
const kpiReady = document.getElementById("kpiReady");
const kpiAssigned = document.getElementById("kpiAssigned");
const kpiTransit = document.getElementById("kpiTransit");
const kpiDelivered = document.getElementById("kpiDelivered");
const kpiRevenue = document.getElementById("kpiRevenue");

const payRate = document.getElementById("payRate");
const payDelivered = document.getElementById("payDelivered");
const payTotalDue = document.getElementById("payTotalDue");
const payNet = document.getElementById("payNet");

const clockEl = document.getElementById("clock");
const pwaMode = document.getElementById("pwaMode");

/* GPS UI */
const trackShipmentSelect = document.getElementById("trackShipmentSelect");
const routeInfoChip = document.getElementById("routeInfoChip");
const gpsChip = document.getElementById("gpsChip");
const locateMeBtn = document.getElementById("locateMeBtn");
const recenterBtn = document.getElementById("recenterBtn");

/* DRIVER MODAL UI */
const driverModal = document.getElementById("driverModal");
const driverModalClose = document.getElementById("driverModalClose");
const driverModalClose2 = document.getElementById("driverModalClose2");
const driverModalTitle = document.getElementById("driverModalTitle");

const dmFullName = document.getElementById("dmFullName");
const dmPhone = document.getElementById("dmPhone");
const dmProvince = document.getElementById("dmProvince");
const dmEmail = document.getElementById("dmEmail");
const dmDocUrl = document.getElementById("dmDocUrl");
const dmInvoiceUrl = document.getElementById("dmInvoiceUrl");
const dmNotes = document.getElementById("dmNotes");

const dmDocFile = document.getElementById("dmDocFile");
const dmDocProgress = document.getElementById("dmDocProgress");
const dmDocUploadBtn = document.getElementById("dmDocUploadBtn");
const dmDocUploadState = document.getElementById("dmDocUploadState");
const dmDocOpenBtn = document.getElementById("dmDocOpenBtn");

const dmInvoiceFile = document.getElementById("dmInvoiceFile");
const dmInvoiceProgress = document.getElementById("dmInvoiceProgress");
const dmInvoiceUploadBtn = document.getElementById("dmInvoiceUploadBtn");
const dmInvoiceUploadState = document.getElementById("dmInvoiceUploadState");
const dmInvoiceOpenBtn = document.getElementById("dmInvoiceOpenBtn");

const driverModalSave = document.getElementById("driverModalSave");
const driverModalCall = document.getElementById("driverModalCall");

/* PROOF MODAL UI */
const proofModal = document.getElementById("proofModal");
const proofModalTitle = document.getElementById("proofModalTitle");
const proofModalClose = document.getElementById("proofModalClose");
const proofCloseBtn = document.getElementById("proofCloseBtn");
const proofSaveBtn = document.getElementById("proofSaveBtn");
const proofPhotoPreview = document.getElementById("proofPhotoPreview");
const proofSignPreview = document.getElementById("proofSignPreview");

const proofPhotoFile = document.getElementById("proofPhotoFile");
const proofPhotoProgress = document.getElementById("proofPhotoProgress");
const proofPhotoUploadBtn = document.getElementById("proofPhotoUploadBtn");
const proofPhotoState = document.getElementById("proofPhotoState");
const proofPhotoOpenBtn = document.getElementById("proofPhotoOpenBtn");

const proofSignFile = document.getElementById("proofSignFile");
const proofSignProgress = document.getElementById("proofSignProgress");
const proofSignUploadBtn = document.getElementById("proofSignUploadBtn");
const proofSignState = document.getElementById("proofSignState");
const proofSignOpenBtn = document.getElementById("proofSignOpenBtn");

const proofOtp = document.getElementById("proofOtp");
const proofNote = document.getElementById("proofNote");

/* ================= MENU MOBILE ================= */
function openMenu(){ document.body.classList.add("menu-open"); }
function closeMenu(){ document.body.classList.remove("menu-open"); }
hamburgerBtn.addEventListener("click", ()=>{
  document.body.classList.contains("menu-open") ? closeMenu() : openMenu();
});
overlay.addEventListener("click", closeMenu);

/* ================= CLOCK ================= */
function tick(){
  const d = new Date();
  const pad = (n)=>String(n).padStart(2,"0");
  clockEl.textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
setInterval(tick,1000); tick();

/* ================= PWA MODE CHIP ================= */
(function(){
  const isStandalone = window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone;
  pwaMode.textContent = "Mode: " + (isStandalone ? "App" : "Browser");
  entMode.value = isStandalone ? "PWA (standalone)" : "Browser";
  entScope.value = location.origin + "/ciza-logistics/";
})();

/* ================= VIEW TITLES ================= */
const VIEW_META = {
  colis:{t:"Gestion des Colis", s:"Recherche ‚Ä¢ D√©tails ‚Ä¢ Paiement ‚Ä¢ Assignation ‚Ä¢ Impression"},
  commandes:{t:"Commandes (GPS)", s:"Suivi live + itin√©raire + ETA"},
  chauffeurs:{t:"Chauffeurs (Dossier)", s:"Fiches compl√®tes ‚Ä¢ Documents ‚Ä¢ Acc√®s rapide"},
  paiements:{t:"Paiements Chauffeurs", s:"Calcul automatique"},
  messagerie:{t:"Messagerie", s:"Bo√Æte de r√©ception + Envoy√©s"},
  planning:{t:"Planning", s:"Rendez-vous internes"},
  bureau:{t:"Bureau", s:"Suivi appels ‚Ä¢ Notes"},
  entreprise:{t:"Entreprise", s:"Param√®tres"}
};

/* ================= NAVIGATION ================= */
function showView(view){
  document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
  const target = document.getElementById("view-"+view);
  if(target) target.classList.add("active");

  document.querySelectorAll("#nav button").forEach(b=>b.classList.remove("active"));
  const btn = document.querySelector(`#nav button[data-view="${view}"]`);
  if(btn) btn.classList.add("active");

  pageTitle.textContent = (VIEW_META[view]?.t || "ERP");
  pageSub.textContent = (VIEW_META[view]?.s || "");

  closeMenu();

  if(view==="commandes"){ setTimeout(()=>initMapOnce(), 200); }
  if(view==="chauffeurs"){ renderDrivers(); }
  if(view==="paiements"){ renderPayments(); }
  if(view==="messagerie"){ startMessages(); }
  if(view==="planning"){ startCalendar(); }
  if(view==="bureau"){ startOffice(); }
  if(view==="entreprise"){ loadEnterprise(); }
}
nav.addEventListener("click", (e)=>{
  const btn = e.target.closest("button[data-view]");
  if(!btn) return;
  showView(btn.getAttribute("data-view"));
});

/* ================= HELPERS ================= */
function safe(v){ return (v===undefined || v===null || String(v).trim()==="") ? "‚Äî" : String(v); }
function num(v,def=0){ const n=Number(v); return Number.isFinite(n)?n:def; }
function money(v){ return num(v,0).toLocaleString("fr-FR")+" BIF"; }
function normalize(s){ return String(s||"").trim().toLowerCase(); }
function clampText(s, max=120){
  const t = String(s||"");
  return t.length>max ? (t.slice(0,max-1)+"‚Ä¶") : t;
}

/* Status */
function statusColor(status){
  if(status==="payment_under_review") return "#e67e22";
  if(status==="ready_for_pickup") return "#f39c12";
  if(status==="assigned") return "#2980b9";
  if(status==="in_transit") return "#8e44ad";
  if(status==="delivered") return "#27ae60";
  return "#000";
}
function statusLabel(status){
  if(status==="payment_under_review") return "En attente paiement";
  if(status==="ready_for_pickup") return "Pr√™t enl√®vement";
  if(status==="assigned") return "Assign√©";
  if(status==="in_transit") return "En transit";
  if(status==="delivered") return "Livr√©";
  return safe(status);
}

/* ================= AUTH GUARD ================= */
onAuthStateChanged(auth, async(user)=>{
  if(!user){
    location.href = "../login.html";
    return;
  }
  currentUser = user;
  currentEmail = user.email || null;

  const snap = await getDoc(doc(db,"users",user.uid));
  if(!snap.exists()){
    await signOut(auth);
    location.href="../login.html";
    return;
  }

  const u = snap.data();
  currentRole = u.role || "";

  const nm = (u.fullName || u.name || user.email || "Admin");
  userName.textContent = nm;
  userRole.textContent = currentRole || "‚Äî";
  envLabel.textContent = "ERP ‚Ä¢ " + (currentRole || "admin");

  if(currentRole!=="admin" && currentRole!=="superadmin"){
    await signOut(auth);
    location.href="../login.html";
    return;
  }

  startRealtime();
});

/* ================= LOGOUT ================= */
logoutBtn.addEventListener("click", async()=>{
  await signOut(auth);
  location.href="../login.html";
});

/* ================= DRIVER PAY SETTINGS ================= */
let driverRateBI = 0;
async function loadDriverRate(){
  try{
    const snap = await getDoc(doc(db,"settings","driverPay"));
    if(snap.exists()){
      driverRateBI = num(snap.data().perDeliveredParcelBI, 0);
    }else{
      driverRateBI = 0;
    }
  }catch(e){
    driverRateBI = 0;
  }
  payRate.textContent = money(driverRateBI);
}

/* ================= DATA STORES ================= */
let allShipments = [];
let allDrivers = [];
let shipmentById = new Map();

/* ================= REALTIME START ================= */
let started=false;
function startRealtime(){
  if(started) return;
  started=true;

  loadDriverRate();

  // Drivers realtime
  const dq = query(collection(db,"users"), where("role","==","driver"));
  onSnapshot(dq,(snap)=>{
    allDrivers = [];
    snap.forEach(ds=> allDrivers.push({ id: ds.id, ...ds.data() }));
    if(document.getElementById("view-chauffeurs").classList.contains("active")) renderDrivers();
  });

  // Shipments realtime
  const sq = query(collection(db,"shipments"));
  onSnapshot(sq,(snap)=>{
    allShipments = [];
    shipmentById = new Map();
    snap.forEach(ds=>{
      const item = { id: ds.id, ...ds.data() };
      allShipments.push(item);
      shipmentById.set(item.id, item);
    });

    renderShipments();
    updateTrackShipmentSelect();
    if(document.getElementById("view-paiements").classList.contains("active")) renderPayments();
  });
}

/* ================= SHIPMENTS UI ================= */
function matchesSearch(s, q){
  if(!q) return true;
  const t = q.toLowerCase();

  const from = `${safe(s.fromProvince)} ${safe(s.fromQuartier)} ${safe(s.fromLandmark)}`.toLowerCase();
  const to = `${safe(s.toProvince)} ${safe(s.toQuartier)} ${safe(s.toLandmark)}`.toLowerCase();

  return (
    (safe(s.id)).toLowerCase().includes(t) ||
    (safe(s.trackingCode)).toLowerCase().includes(t) ||
    (safe(s.senderName)).toLowerCase().includes(t) ||
    (safe(s.receiverName)).toLowerCase().includes(t) ||
    (safe(s.senderPhone)).toLowerCase().includes(t) ||
    (safe(s.receiverPhone)).toLowerCase().includes(t) ||
    from.includes(t) ||
    to.includes(t) ||
    (safe(s.content)).toLowerCase().includes(t)
  );
}

function hasCoords(s){
  const a = Number(s?.toLat ?? s?.to?.lat);
  const b = Number(s?.toLng ?? s?.to?.lng);
  const c = Number(s?.fromLat ?? s?.from?.lat);
  const d = Number(s?.fromLng ?? s?.from?.lng);
  const hasTo = Number.isFinite(a) && Number.isFinite(b);
  const hasFrom = Number.isFinite(c) && Number.isFinite(d);
  return { hasTo, hasFrom, toLat:a, toLng:b, fromLat:c, fromLng:d };
}

function renderShipments(){
  const q = (searchInput.value || "").trim();
  const st = statusFilter.value || "";

  let payment=0, ready=0, assigned=0, transit=0, delivered=0, revenue=0;

  const items = allShipments
    .filter(s=>{
      const okSearch = matchesSearch(s,q);
      const okStatus = st ? (s.status===st) : true;
      return okSearch && okStatus;
    })
    .sort((a,b)=>{
      const aa = a.createdAt?.seconds || 0;
      const bb = b.createdAt?.seconds || 0;
      return bb - aa;
    });

  parcelList.innerHTML = "";

  items.forEach(s=>{
    if(s.status==="payment_under_review") payment++;
    if(s.status==="ready_for_pickup") ready++;
    if(s.status==="assigned") assigned++;
    if(s.status==="in_transit") transit++;
    if(s.status==="delivered") delivered++;
    revenue += num(s.finalPrice,0);

    const card = document.createElement("div");
    card.className="card";

    const from = `${safe(s.fromProvince)}${s.fromQuartier ? " ‚Ä¢ "+safe(s.fromQuartier) : ""}`;
    const to = `${safe(s.toProvince)}${s.toQuartier ? " ‚Ä¢ "+safe(s.toQuartier) : ""}`;

    const driverNet = (s.status==="delivered") ? driverRateBI : 0;
    const companyNet = (s.status==="delivered") ? Math.max(0, num(s.finalPrice,0) - driverRateBI) : 0;

    const assignedName = safe(s.assignedDriverName || s.assignedDriverId);
    const shortDesc = clampText(safe(s.content), 120);

    card.innerHTML = `
      <div class="card-head">
        <div>
          <div class="tracking">${safe(s.id)}</div>
          <div class="route">${from} ‚Üí ${to}</div>
        </div>
        <span class="badge" style="background:${statusColor(s.status)}">${statusLabel(s.status)}</span>
      </div>

      <div class="meta-wrap">
        <div class="meta">
          <b>Exp√©diteur :</b> ${safe(s.senderName)}<br>
          <b>T√©l√©phone :</b> ${safe(s.senderPhone)}<br>
          <b>Destinataire :</b> ${safe(s.receiverName)}<br>
          <b>T√©l√©phone :</b> ${safe(s.receiverPhone)}<br>
          <b>Contenu :</b> ${shortDesc}<br>
          <b>Valeur :</b> ${money(num(s.declaredValue,0))}<br>
          <b>Rep√®re d√©part :</b> ${safe(s.fromLandmark)}<br>
          <b>Rep√®re destination :</b> ${safe(s.toLandmark)}
        </div>

        <div class="meta">
          <b>Service :</b> ${safe(s.serviceLabel || s.service)}<br>
          <b>Poids/Qt√© :</b> ${safe(s.weightOrQty)}<br>
          <b>Paiement :</b> ${safe(s.paymentMethod)}<br>
          <b>Statut paiement :</b> ${safe(s.paymentStatus)}<br>
          <b>Prix :</b> ${money(num(s.finalPrice,0))}<br>
          <div class="hr"></div>
          <b>Chauffeur :</b> ${assignedName}<br>
          ${s.status==="delivered"
            ? `<b>Pay chauffeur :</b> ${money(driverNet)}<br><b>Net entreprise :</b> ${money(companyNet)}`
            : `<span style="color:#6b7280;font-weight:800">Pay chauffeur / net : apr√®s livraison</span>`
          }
        </div>
      </div>

      <div class="controls">
        <button class="dark" type="button" data-print="${safe(s.id)}">üñ® Imprimer</button>

        ${s.status==="payment_under_review" ? `<button class="primary" type="button" data-validate="${safe(s.id)}">Valider paiement</button>` : ""}

        ${s.status==="ready_for_pickup" ? `
          <select data-driver-select="${safe(s.id)}">
            <option value="">Assigner chauffeur</option>
          </select>
          <button class="primary" type="button" data-assign="${safe(s.id)}">Assigner</button>
        ` : ""}

        ${s.status==="assigned" ? `<button class="primary" type="button" data-transit="${safe(s.id)}">Marquer en transit</button>` : ""}

        ${s.status==="in_transit" ? `<button class="primary" type="button" data-delivered="${safe(s.id)}">Confirmer livraison</button>` : ""}

        <button class="ghost" type="button" data-open-driver="${safe(s.assignedDriverId || "")}" ${s.assignedDriverId ? "" : "disabled"}>Dossier chauffeur</button>

        ${s.status==="delivered" ? `<button class="ghost" type="button" data-proof="${safe(s.id)}">üìé Preuve livraison</button>` : ""}
      </div>
    `;

    parcelList.appendChild(card);

    // fill driver select
    if(s.status==="ready_for_pickup"){
      const sel = card.querySelector(`select[data-driver-select="${CSS.escape(s.id)}"]`);
      if(sel){
        const filtered = filterDriversForShipment(s);
        const pool = filtered.length ? filtered : allDrivers;
        pool.forEach(dr=>{
          const nm = dr.fullName || dr.name || dr.email || dr.id;
          const opt = document.createElement("option");
          opt.value = dr.id;
          opt.textContent = nm + (dr.province ? " ‚Ä¢ " + dr.province : "");
          sel.appendChild(opt);
        });
      }
    }
  });

  kpiPayment.textContent = payment;
  kpiReady.textContent = ready;
  kpiAssigned.textContent = assigned;
  kpiTransit.textContent = transit;
  kpiDelivered.textContent = delivered;
  kpiRevenue.textContent = money(revenue);
}

/* ================= DRIVER FILTER (DESTINATION) ================= */
function driverMatchesShipment(driver, shipment){
  const destP = normalize(shipment.toProvince);
  const destQ = normalize(shipment.toQuartier);

  const baseP = normalize(driver.province);
  if(baseP && baseP===destP) return true;

  const provinces = Array.isArray(driver.provinces) ? driver.provinces.map(normalize) : [];
  if(provinces.includes(destP)) return true;

  const quartiers = Array.isArray(driver.quartiers) ? driver.quartiers.map(normalize) : [];
  if(destQ && quartiers.includes(destQ)) return true;

  const areas = Array.isArray(driver.serviceAreas) ? driver.serviceAreas : [];
  for(const a of areas){
    const ap = normalize(a?.province);
    const aq = normalize(a?.quartier);
    if(ap && ap===destP){
      if(!destQ) return true;
      if(aq && aq===destQ) return true;
      if(!aq) return true;
    }
  }

  return false;
}
function filterDriversForShipment(shipment){
  return allDrivers.filter(d=>driverMatchesShipment(d, shipment));
}

/* ================= ACTIONS (EVENT DELEGATION) ================= */
parcelList.addEventListener("click", async(e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;

  const idPrint = btn.getAttribute("data-print");
  if(idPrint){
    window.open(`../print-label.html?tracking=${encodeURIComponent(idPrint)}`, "_blank");
    return;
  }

  const idValidate = btn.getAttribute("data-validate");
  if(idValidate){
    await validatePayment(idValidate);
    return;
  }

  const idAssign = btn.getAttribute("data-assign");
  if(idAssign){
    const sel = document.querySelector(`select[data-driver-select="${CSS.escape(idAssign)}"]`);
    const driverId = sel ? sel.value : "";
    if(!driverId){ alert("Choisir un chauffeur."); return; }
    await assignDriver(idAssign, driverId);
    return;
  }

  const idTransit = btn.getAttribute("data-transit");
  if(idTransit){
    await markTransit(idTransit);
    return;
  }

  const idDelivered = btn.getAttribute("data-delivered");
  if(idDelivered){
    await markDelivered(idDelivered);
    return;
  }

  const openDriverId = btn.getAttribute("data-open-driver");
  if(openDriverId){
    openDriverModal(openDriverId);
    return;
  }

  const proofId = btn.getAttribute("data-proof");
  if(proofId){
    openProofModal(proofId);
    return;
  }
});

/* ================= WORKFLOW ACTIONS ================= */
async function validatePayment(id){
  await updateDoc(doc(db,"shipments",id),{
    status:"ready_for_pickup",
    paymentStatus:"verified",
    paymentValidatedAt: serverTimestamp()
  });
  alert("Paiement valid√©.");
}
async function assignDriver(id, driverId){
  const d = allDrivers.find(x=>x.id===driverId) || null;
  await updateDoc(doc(db,"shipments",id),{
    status:"assigned",
    assignedDriverId: driverId,
    assignedDriverName: d ? (d.fullName || d.name || d.email || driverId) : driverId,
    assignedAt: serverTimestamp()
  });
  alert("Chauffeur assign√©.");
}
async function markTransit(id){
  await updateDoc(doc(db,"shipments",id),{
    status:"in_transit",
    inTransitAt: serverTimestamp()
  });
  alert("Colis en transit.");
}
async function markDelivered(id){
  await updateDoc(doc(db,"shipments",id),{
    status:"delivered",
    deliveredAt: serverTimestamp()
  });
  alert("Livraison confirm√©e.");
}

/* ================= SEARCH / FILTER ================= */
searchInput.addEventListener("input", renderShipments);
statusFilter.addEventListener("change", renderShipments);
clearBtn.addEventListener("click", ()=>{
  searchInput.value="";
  statusFilter.value="";
  renderShipments();
});
refreshBtn.addEventListener("click", ()=>renderShipments());

/* ================= DRIVERS MODULE ================= */
driverSearch.addEventListener("input", renderDrivers);
driverClear.addEventListener("click", ()=>{
  driverSearch.value="";
  renderDrivers();
});
function driverMatch(d, q){
  if(!q) return true;
  const t = q.toLowerCase();
  return (
    safe(d.fullName||d.name||"").toLowerCase().includes(t) ||
    safe(d.phone||"").toLowerCase().includes(t) ||
    safe(d.province||"").toLowerCase().includes(t) ||
    safe(d.email||"").toLowerCase().includes(t)
  );
}
function renderDrivers(){
  const q = (driverSearch.value||"").trim();
  driversList.innerHTML="";

  const list = allDrivers
    .filter(d=>driverMatch(d,q))
    .sort((a,b)=>safe(a.fullName||a.name||"").localeCompare(safe(b.fullName||b.name||""), "fr"));

  list.forEach(d=>{
    const card = document.createElement("div");
    card.className="card";
    const nm = d.fullName || d.name || d.email || d.id;

    card.innerHTML = `
      <div class="card-head">
        <div>
          <div class="tracking">${safe(nm)}</div>
          <div class="route">${safe(d.province)} ‚Ä¢ ${safe(d.phone)} ‚Ä¢ ${safe(d.email)}</div>
        </div>
        <span class="badge" style="background:#000">DRIVER</span>
      </div>
      <div class="hr"></div>
      <div class="meta">
        <b>UID:</b> ${safe(d.id)}<br>
        <b>Zones:</b> ${Array.isArray(d.provinces) ? d.provinces.join(", ") : safe(d.province)}<br>
        <b>Quartiers:</b> ${Array.isArray(d.quartiers) ? d.quartiers.join(", ") : "‚Äî"}<br>
        <b>Doc:</b> ${d.adminDocUrl ? "Disponible" : "‚Äî"}<br>
        <b>Contrat:</b> ${d.adminInvoiceUrl ? "Disponible" : "‚Äî"}<br>
        <b>Notes:</b> ${safe(clampText(d.adminNotes, 120))}
      </div>
      <div class="controls">
        <button class="primary" type="button" data-open="${safe(d.id)}">Ouvrir dossier</button>
        <button class="dark" type="button" data-call="${safe(d.phone)}">Appeler</button>
      </div>
    `;
    driversList.appendChild(card);

    card.querySelector('button[data-open]')?.addEventListener("click", ()=>openDriverModal(d.id));
    card.querySelector('button[data-call]')?.addEventListener("click", ()=>{
      const p = (d.phone||"").trim();
      if(!p){ alert("T√©l√©phone non disponible."); return; }
      location.href = "tel:" + p;
    });
  });
}

/* ================= DRIVER MODAL ================= */
let modalDriverId=null;
let modalDriverData=null;

function closeDriverModal(){
  driverModal.classList.remove("open");
  modalDriverId=null;
  modalDriverData=null;
  dmDocProgress.style.width="0%";
  dmInvoiceProgress.style.width="0%";
  dmDocUploadState.textContent="‚Äî";
  dmInvoiceUploadState.textContent="‚Äî";
}
driverModalClose.addEventListener("click", closeDriverModal);
driverModalClose2.addEventListener("click", closeDriverModal);
driverModal.addEventListener("click", (e)=>{ if(e.target===driverModal) closeDriverModal(); });

function setOpenBtn(btn, url){
  if(url){
    btn.disabled=false;
    btn.onclick=()=>window.open(url, "_blank");
  }else{
    btn.disabled=true;
    btn.onclick=null;
  }
}

async function openDriverModal(driverId){
  if(!driverId){ alert("Chauffeur non assign√©."); return; }
  modalDriverId = driverId;

  const snap = await getDoc(doc(db,"users",driverId));
  if(!snap.exists()){
    alert("Chauffeur introuvable.");
    return;
  }
  const d = snap.data();
  modalDriverData = d;

  const nm = d.fullName || d.name || d.email || driverId;
  driverModalTitle.textContent = "Dossier Chauffeur ‚Ä¢ " + nm;

  dmFullName.value = d.fullName || d.name || "";
  dmPhone.value = d.phone || "";
  dmProvince.value = d.province || "";
  dmEmail.value = d.email || "";

  dmDocUrl.value = d.adminDocUrl || "";
  dmInvoiceUrl.value = d.adminInvoiceUrl || "";
  dmNotes.value = d.adminNotes || "";

  setOpenBtn(dmDocOpenBtn, d.adminDocUrl || "");
  setOpenBtn(dmInvoiceOpenBtn, d.adminInvoiceUrl || "");

  driverModal.classList.add("open");
}

driverModalSave.addEventListener("click", async()=>{
  if(!modalDriverId) return;

  await updateDoc(doc(db,"users",modalDriverId),{
    adminDocUrl: (dmDocUrl.value||"").trim() || null,
    adminInvoiceUrl: (dmInvoiceUrl.value||"").trim() || null,
    adminNotes: (dmNotes.value||"").trim() || null,
    adminUpdatedAt: serverTimestamp()
  });

  alert("Dossier mis √† jour.");
  closeDriverModal();
  renderDrivers();
});

driverModalCall.addEventListener("click", ()=>{
  const p = (dmPhone.value||"").trim();
  if(!p){ alert("T√©l√©phone non disponible."); return; }
  location.href = "tel:" + p;
});

/* ================= STORAGE UPLOAD (10MB) ================= */
const MAX_UPLOAD = 10 * 1024 * 1024;

function extFromName(name){
  const n = String(name||"").toLowerCase();
  const i = n.lastIndexOf(".");
  return i>=0 ? n.slice(i+1) : "";
}
function safeFileName(name){
  return String(name||"file").replaceAll(/[^a-zA-Z0-9._-]/g, "_").slice(0,120);
}
function setProgress(barEl, pct){
  barEl.style.width = Math.max(0, Math.min(100, pct)) + "%";
}

async function uploadToStorage({file, path, progressBar, stateEl}){
  if(!file) throw new Error("Fichier manquant");
  if(file.size > MAX_UPLOAD) throw new Error("Fichier trop lourd (max 10MB).");

  stateEl.textContent = "Upload...";
  setProgress(progressBar, 0);

  const storageRef = sRef(storage, path);
  const task = uploadBytesResumable(storageRef, file, {
    contentType: file.type || undefined,
    customMetadata: {
      uploadedBy: currentUser?.uid || "unknown",
      originalName: file.name || "file"
    }
  });

  const url = await new Promise((resolve, reject)=>{
    task.on("state_changed",
      (snap)=>{
        const pct = (snap.totalBytes ? (snap.bytesTransferred / snap.totalBytes) * 100 : 0);
        setProgress(progressBar, pct);
      },
      (err)=>reject(err),
      async()=>{
        const dl = await getDownloadURL(task.snapshot.ref);
        resolve(dl);
      }
    );
  });

  stateEl.textContent = "OK ‚úÖ";
  setProgress(progressBar, 100);
  return url;
}

/* Driver doc upload */
dmDocUploadBtn.addEventListener("click", async()=>{
  if(!modalDriverId) return;
  const file = dmDocFile.files?.[0];
  if(!file){ alert("Choisir un fichier."); return; }

  dmDocUploadBtn.disabled = true;
  try{
    const path = `adminUploads/drivers/${modalDriverId}/doc_${Date.now()}_${safeFileName(file.name)}`;
    const url = await uploadToStorage({
      file,
      path,
      progressBar: dmDocProgress,
      stateEl: dmDocUploadState
    });
    dmDocUrl.value = url;
    setOpenBtn(dmDocOpenBtn, url);

    await updateDoc(doc(db,"users",modalDriverId),{
      adminDocUrl: url,
      adminUpdatedAt: serverTimestamp(),
      adminUpdatedBy: currentUser?.uid || null
    });

    alert("Document t√©l√©vers√©.");
  }catch(e){
    dmDocUploadState.textContent = "Erreur";
    alert("Upload impossible: " + (e?.message || e));
  }finally{
    dmDocUploadBtn.disabled = false;
  }
});

dmInvoiceUploadBtn.addEventListener("click", async()=>{
  if(!modalDriverId) return;
  const file = dmInvoiceFile.files?.[0];
  if(!file){ alert("Choisir un fichier."); return; }

  dmInvoiceUploadBtn.disabled = true;
  try{
    const path = `adminUploads/drivers/${modalDriverId}/invoice_${Date.now()}_${safeFileName(file.name)}`;
    const url = await uploadToStorage({
      file,
      path,
      progressBar: dmInvoiceProgress,
      stateEl: dmInvoiceUploadState
    });
    dmInvoiceUrl.value = url;
    setOpenBtn(dmInvoiceOpenBtn, url);

    await updateDoc(doc(db,"users",modalDriverId),{
      adminInvoiceUrl: url,
      adminUpdatedAt: serverTimestamp(),
      adminUpdatedBy: currentUser?.uid || null
    });

    alert("Contrat/facture t√©l√©vers√©.");
  }catch(e){
    dmInvoiceUploadState.textContent = "Erreur";
    alert("Upload impossible: " + (e?.message || e));
  }finally{
    dmInvoiceUploadBtn.disabled = false;
  }
});

/* ================= PROOF MODAL ================= */
let proofShipmentId=null;
let proofPhotoUrl=null;
let proofSignUrl=null;

function closeProofModal(){
  proofModal.classList.remove("open");
  proofShipmentId=null;
  proofPhotoUrl=null;
  proofSignUrl=null;

  proofPhotoPreview.removeAttribute("src");
  proofSignPreview.removeAttribute("src");

  proofPhotoProgress.style.width="0%";
  proofSignProgress.style.width="0%";
  proofPhotoState.textContent="‚Äî";
  proofSignState.textContent="‚Äî";
  proofPhotoOpenBtn.disabled=true;
  proofSignOpenBtn.disabled=true;

  proofOtp.value="";
  proofNote.value="";
}
proofModalClose.addEventListener("click", closeProofModal);
proofCloseBtn.addEventListener("click", closeProofModal);
proofModal.addEventListener("click", (e)=>{ if(e.target===proofModal) closeProofModal(); });

function setPreview(imgEl, url){
  if(url){
    imgEl.src = url;
  }else{
    imgEl.removeAttribute("src");
  }
}

async function openProofModal(shipmentId){
  const s = shipmentById.get(shipmentId);
  if(!s){ alert("Colis introuvable."); return; }

  proofShipmentId = shipmentId;
  proofModalTitle.textContent = "Preuve de livraison ‚Ä¢ " + shipmentId;

  proofPhotoUrl = s.proofPhotoUrl || null;
  proofSignUrl = s.proofSignUrl || null;

  setPreview(proofPhotoPreview, proofPhotoUrl);
  setPreview(proofSignPreview, proofSignUrl);

  if(proofPhotoUrl){
    proofPhotoOpenBtn.disabled=false;
    proofPhotoOpenBtn.onclick=()=>window.open(proofPhotoUrl, "_blank");
  }else{
    proofPhotoOpenBtn.disabled=true;
    proofPhotoOpenBtn.onclick=null;
  }

  if(proofSignUrl){
    proofSignOpenBtn.disabled=false;
    proofSignOpenBtn.onclick=()=>window.open(proofSignUrl, "_blank");
  }else{
    proofSignOpenBtn.disabled=true;
    proofSignOpenBtn.onclick=null;
  }

  proofOtp.value = s.proofOtp || "";
  proofNote.value = s.proofNote || "";

  proofModal.classList.add("open");
}

proofPhotoUploadBtn.addEventListener("click", async()=>{
  if(!proofShipmentId) return;
  const file = proofPhotoFile.files?.[0];
  if(!file){ alert("Choisir une photo."); return; }

  proofPhotoUploadBtn.disabled=true;
  try{
    const path = `adminUploads/shipments/${proofShipmentId}/proof_photo_${Date.now()}_${safeFileName(file.name)}`;
    const url = await uploadToStorage({
      file,
      path,
      progressBar: proofPhotoProgress,
      stateEl: proofPhotoState
    });
    proofPhotoUrl = url;
    setPreview(proofPhotoPreview, url);

    proofPhotoOpenBtn.disabled=false;
    proofPhotoOpenBtn.onclick=()=>window.open(url, "_blank");

    alert("Photo t√©l√©vers√©e.");
  }catch(e){
    proofPhotoState.textContent="Erreur";
    alert("Upload impossible: " + (e?.message || e));
  }finally{
    proofPhotoUploadBtn.disabled=false;
  }
});

proofSignUploadBtn.addEventListener("click", async()=>{
  if(!proofShipmentId) return;
  const file = proofSignFile.files?.[0];
  if(!file){ alert("Choisir une signature."); return; }

  proofSignUploadBtn.disabled=true;
  try{
    const path = `adminUploads/shipments/${proofShipmentId}/proof_sign_${Date.now()}_${safeFileName(file.name)}`;
    const url = await uploadToStorage({
      file,
      path,
      progressBar: proofSignProgress,
      stateEl: proofSignState
    });
    proofSignUrl = url;
    setPreview(proofSignPreview, url);

    proofSignOpenBtn.disabled=false;
    proofSignOpenBtn.onclick=()=>window.open(url, "_blank");

    alert("Signature t√©l√©vers√©e.");
  }catch(e){
    proofSignState.textContent="Erreur";
    alert("Upload impossible: " + (e?.message || e));
  }finally{
    proofSignUploadBtn.disabled=false;
  }
});

proofSaveBtn.addEventListener("click", async()=>{
  if(!proofShipmentId) return;

  const otp = (proofOtp.value||"").trim() || null;
  const note = (proofNote.value||"").trim() || null;

  await updateDoc(doc(db,"shipments", proofShipmentId),{
    proofPhotoUrl: proofPhotoUrl || null,
    proofSignUrl: proofSignUrl || null,
    proofOtp: otp,
    proofNote: note,
    proofUpdatedAt: serverTimestamp(),
    proofUpdatedBy: currentUser?.uid || null
  });

  alert("Preuve enregistr√©e.");
  closeProofModal();
});

/* ================= PAYMENTS MODULE ================= */
function renderPayments(){
  payRate.textContent = money(driverRateBI);

  const deliveredShipments = allShipments.filter(s=>s.status==="delivered");
  const deliveredCount = deliveredShipments.length;
  const totalDue = deliveredCount * driverRateBI;

  let revenueDelivered = 0;
  deliveredShipments.forEach(s=> revenueDelivered += num(s.finalPrice,0));
  const net = Math.max(0, revenueDelivered - totalDue);

  payDelivered.textContent = deliveredCount;
  payTotalDue.textContent = money(totalDue);
  payNet.textContent = money(net);

  paymentsList.innerHTML="";

  deliveredShipments
    .sort((a,b)=>{
      const aa = a.deliveredAt?.seconds || 0;
      const bb = b.deliveredAt?.seconds || 0;
      return bb - aa;
    })
    .slice(0, 70)
    .forEach(s=>{
      const card = document.createElement("div");
      card.className="card";

      const from = `${safe(s.fromProvince)}${s.fromQuartier ? " ‚Ä¢ "+safe(s.fromQuartier) : ""}`;
      const to = `${safe(s.toProvince)}${s.toQuartier ? " ‚Ä¢ "+safe(s.toQuartier) : ""}`;

      const compNet = Math.max(0, num(s.finalPrice,0) - driverRateBI);

      card.innerHTML = `
        <div class="card-head">
          <div>
            <div class="tracking">${safe(s.id)}</div>
            <div class="route">${from} ‚Üí ${to}</div>
          </div>
          <span class="badge" style="background:#27ae60">LIVR√â</span>
        </div>
        <div class="hr"></div>
        <div class="meta-wrap">
          <div class="meta">
            <b>Chauffeur:</b> ${safe(s.assignedDriverName || s.assignedDriverId)}<br>
            <b>Client:</b> ${safe(s.senderName)}<br>
            <b>Destinataire:</b> ${safe(s.receiverName)}
          </div>
          <div class="meta">
            <b>Prix:</b> ${money(num(s.finalPrice,0))}<br>
            <b>Pay chauffeur:</b> ${money(driverRateBI)}<br>
            <b>Net entreprise:</b> ${money(compNet)}
          </div>
        </div>
        <div class="controls">
          <button class="dark" type="button" data-print="${safe(s.id)}">üñ® Imprimer</button>
          <button class="ghost" type="button" data-proof="${safe(s.id)}">üìé Preuve</button>
        </div>
      `;
      paymentsList.appendChild(card);

      card.querySelector('button[data-print]')?.addEventListener("click", ()=>{
        window.open(`../print-label.html?tracking=${encodeURIComponent(s.id)}`, "_blank");
      });
      card.querySelector('button[data-proof]')?.addEventListener("click", ()=>{
        openProofModal(s.id);
      });
    });
}

/* ================= GPS LIVE (LEAFLET + ROUTING) ================= */
let mapInitialized=false;
let map=null;
let driverMarkers={};

let adminMarker=null;
let shipmentMarkerFrom=null;
let shipmentMarkerTo=null;
let routeLine=null;

let driversLiveCache = new Map();
let selectedShipmentId = null;

function resetRouteUI(){
  routeInfoChip.textContent = "Distance: ‚Äî ‚Ä¢ ETA: ‚Äî";
}

function setGPSChip(ok, text){
  gpsChip.textContent = "GPS: " + text;
  gpsChip.style.opacity = ok ? "1" : ".85";
}

function initMapOnce(){
  if(mapInitialized) return;

  map = L.map('map', { zoomControl:true }).setView([-3.3731, 29.9189], 8);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom: 19
  }).addTo(map);

  mapInitialized=true;

  
  // Drivers live (via users.liveLocation)
onSnapshot(
  query(collection(db,"users"), where("role","==","driver")),
  (snap)=>{
    const seen = new Set();

    snap.forEach(ds=>{
      const d = ds.data();
      const id = ds.id;

      const lat = Number(d.liveLocation?.lat);
      const lng = Number(d.liveLocation?.lng);

      if(!Number.isFinite(lat) || !Number.isFinite(lng)) return;

      seen.add(id);

      const nm = d.fullName || d.name || d.email || id;

      driversLiveCache.set(id, { lat, lng, fullName: nm });

      if(driverMarkers[id]){
        driverMarkers[id].setLatLng([lat,lng]);
      }else{
        driverMarkers[id] = L.marker([lat,lng])
          .addTo(map)
          .bindPopup(`üöö ${nm}`);
      }
    });

    Object.keys(driverMarkers).forEach(id=>{
      if(!seen.has(id)){
        map.removeLayer(driverMarkers[id]);
        delete driverMarkers[id];
        driversLiveCache.delete(id);
      }
    });

    if(selectedShipmentId){
      scheduleRouteRecompute("driversUpdate");
    }
  }
);
  // UI listeners
  trackShipmentSelect.addEventListener("change", ()=>{
    selectedShipmentId = trackShipmentSelect.value || null;
    drawSelectedShipmentMarkers();
    scheduleRouteRecompute("shipmentChange");
  });

  locateMeBtn.addEventListener("click", locateAdmin);
  recenterBtn.addEventListener("click", recenterMap);

  setGPSChip(true, "Pr√™t");
}

function updateTrackShipmentSelect(){
  // Keep selected value if still exists
  const prev = trackShipmentSelect.value || "";
  trackShipmentSelect.innerHTML = `<option value="">Choisir un colis √† suivre (si coordonn√©es disponibles)</option>`;

  // prefer active shipments
  const items = [...allShipments].sort((a,b)=>{
    const aa = a.createdAt?.seconds || 0;
    const bb = b.createdAt?.seconds || 0;
    return bb-aa;
  });

  items.forEach(s=>{
    const c = hasCoords(s);
    const tag = c.hasTo ? "üìç" : "‚Äî";
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = `${tag} ${s.id} ‚Ä¢ ${statusLabel(s.status)}`;
    trackShipmentSelect.appendChild(opt);
  });

  if(prev && [...trackShipmentSelect.options].some(o=>o.value===prev)){
    trackShipmentSelect.value = prev;
    selectedShipmentId = prev;
  }
}

function recenterMap(){
  if(!map) return;
  // if route exists, fit it
  const layers = [];
  if(routeLine) layers.push(routeLine);
  if(shipmentMarkerTo) layers.push(shipmentMarkerTo);
  if(shipmentMarkerFrom) layers.push(shipmentMarkerFrom);

  if(layers.length){
    const group = L.featureGroup(layers);
    map.fitBounds(group.getBounds().pad(0.25));
    return;
  }
  map.setView([-3.3731, 29.9189], 8);
}

function locateAdmin(){
  if(!navigator.geolocation){
    setGPSChip(false, "Non support√©");
    alert("G√©olocalisation non support√©e sur cet appareil.");
    return;
  }
  setGPSChip(true, "Recherche‚Ä¶");
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      if(adminMarker){
        adminMarker.setLatLng([lat,lng]);
      }else{
        adminMarker = L.marker([lat,lng]).addTo(map).bindPopup("üìç Vous");
      }
      map.setView([lat,lng], 14);
      setGPSChip(true, "OK");
    },
    ()=>{
      setGPSChip(false, "Refus√©");
      alert("Permission GPS refus√©e ou indisponible.");
    },
    { enableHighAccuracy:true, timeout:12000, maximumAge:10000 }
  );
}

function drawSelectedShipmentMarkers(){
  // clear previous
  if(shipmentMarkerFrom){ map.removeLayer(shipmentMarkerFrom); shipmentMarkerFrom=null; }
  if(shipmentMarkerTo){ map.removeLayer(shipmentMarkerTo); shipmentMarkerTo=null; }
  if(routeLine){ map.removeLayer(routeLine); routeLine=null; }
  resetRouteUI();

  if(!selectedShipmentId) return;
  const s = shipmentById.get(selectedShipmentId);
  if(!s) return;

  const c = hasCoords(s);
  const fromLat = c.hasFrom ? c.fromLat : null;
  const fromLng = c.hasFrom ? c.fromLng : null;
  const toLat = c.hasTo ? c.toLat : null;
  const toLng = c.hasTo ? c.toLng : null;

  if(c.hasFrom){
    shipmentMarkerFrom = L.marker([fromLat, fromLng]).addTo(map).bindPopup("üì¶ D√©part");
  }
  if(c.hasTo){
    shipmentMarkerTo = L.marker([toLat, toLng]).addTo(map).bindPopup("üèÅ Destination");
  }

  recenterMap();
}

/* Routing with OSRM public */
let routeTimer=null;
let lastRouteKey="";
let lastRouteAt=0;

function scheduleRouteRecompute(reason){
  if(!map || !selectedShipmentId) return;
  // throttle
  const now = Date.now();
  if(now - lastRouteAt < 800) return;

  clearTimeout(routeTimer);
  routeTimer = setTimeout(()=>computeRoute(reason), 350);
}

function haversineM(lat1, lon1, lat2, lon2){
  const R = 6371000;
  const toRad = (d)=>d*Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)*Math.sin(dLat/2) +
            Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) *
            Math.sin(dLon/2)*Math.sin(dLon/2);
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

function formatKm(m){
  if(!Number.isFinite(m)) return "‚Äî";
  const km = m/1000;
  return (km<10 ? km.toFixed(1) : km.toFixed(0)) + " km";
}
function formatETA(sec){
  if(!Number.isFinite(sec)) return "‚Äî";
  const m = Math.round(sec/60);
  if(m<60) return m + " min";
  const h = Math.floor(m/60);
  const r = m%60;
  return h + " h " + r + " min";
}

async function computeRoute(reason){
  if(!selectedShipmentId) return;
  const s = shipmentById.get(selectedShipmentId);
  if(!s) return;

  const c = hasCoords(s);
  if(!c.hasTo){
    routeInfoChip.textContent = "Distance: ‚Äî ‚Ä¢ ETA: ‚Äî";
    return;
  }

  // start point: prefer live driver, else fromCoords, else admin location
  let start = null;

  const driverId = s.assignedDriverId || null;
  if(driverId && driversLiveCache.has(driverId)){
    const d = driversLiveCache.get(driverId);
    start = { lat:d.lat, lng:d.lng, label:"Chauffeur" };
  }else if(c.hasFrom){
    start = { lat:c.fromLat, lng:c.fromLng, label:"D√©part" };
  }else if(adminMarker){
    const ll = adminMarker.getLatLng();
    start = { lat:ll.lat, lng:ll.lng, label:"Vous" };
  }

  if(!start){
    routeInfoChip.textContent = "Distance: ‚Äî ‚Ä¢ ETA: ‚Äî";
    return;
  }

  const end = { lat:c.toLat, lng:c.toLng, label:"Destination" };

  // Only recompute if moved enough
  const key = `${start.lat.toFixed(5)},${start.lng.toFixed(5)}->${end.lat.toFixed(5)},${end.lng.toFixed(5)}`;
  const now = Date.now();

  if(lastRouteKey){
    // if key identical, skip
    if(key === lastRouteKey && (now-lastRouteAt)<5000) return;
  }

  // if moved less than 30m from previous start, skip
  if(lastRouteKey){
    const [a,b] = lastRouteKey.split("->");
    const [psLat, psLng] = a.split(",").map(Number);
    if(Number.isFinite(psLat) && Number.isFinite(psLng)){
      const moved = haversineM(psLat, psLng, start.lat, start.lng);
      if(moved < 30 && (now-lastRouteAt)<8000) return;
    }
  }

  lastRouteKey = key;
  lastRouteAt = now;

  try{
    // OSRM expects lng,lat
    const url = `https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`;
    const res = await fetch(url, { method:"GET" });
    if(!res.ok) throw new Error("routing");
    const data = await res.json();
    const r = data?.routes?.[0];
    if(!r) throw new Error("routing");

    const dist = r.distance;
    const dur = r.duration;

    routeInfoChip.textContent = `Distance: ${formatKm(dist)} ‚Ä¢ ETA: ${formatETA(dur)}`;

    // draw polyline
    if(routeLine){ map.removeLayer(routeLine); routeLine=null; }
    const coords = r.geometry?.coordinates;
    if(Array.isArray(coords) && coords.length){
      const latlngs = coords.map(([lng,lat])=>[lat,lng]);
      routeLine = L.polyline(latlngs, { weight:5, opacity:0.9 }).addTo(map);
    }

    // ensure markers
    drawSelectedShipmentMarkers();

    // show start marker quickly (temporary popup on driver marker)
    if(driverId && driverMarkers[driverId]){
      // nothing to do
    }

  }catch(e){
    // fallback: direct distance estimation (not route)
    const direct = haversineM(start.lat, start.lng, end.lat, end.lng);
    const approxSec = (direct / 8000) * 3600; // ~8km/h conservative
    routeInfoChip.textContent = `Distance: ${formatKm(direct)} ‚Ä¢ ETA: ${formatETA(approxSec)}`;
  }
}

/* ================= MESSAGERIE ================= */
let messagesStarted=false;
let allMessages=[];

function isForMe(m){
  const to = String(m.to||"").trim().toLowerCase();
  const uid = (currentUser?.uid||"").toLowerCase();
  const mail = (currentEmail||"").toLowerCase();
  const role = (currentRole||"").toLowerCase();

  if(!to) return false;
  if(uid && to===uid) return true;
  if(mail && to===mail) return true;
  if(role && to===role) return true;

  if(role==="superadmin" && to==="admin") return true;
  return false;
}

function isFromMe(m){
  const fu = String(m.fromUid||"").toLowerCase();
  const uid = (currentUser?.uid||"").toLowerCase();
  return uid && fu===uid;
}

function startMessages(){
  if(messagesStarted) { renderMessages(); return; }
  messagesStarted=true;

  const q = query(collection(db,"internalMessages"), orderBy("createdAt","desc"), limit(200));
  onSnapshot(q,(snap)=>{
    allMessages = [];
    snap.forEach(ds=> allMessages.push({ id: ds.id, ...ds.data() }));
    renderMessages();
  });
}

function renderMessages(){
  const box = msgBox.value || "inbox";
  const s = (msgSearch.value||"").trim().toLowerCase();

  messagesList.innerHTML="";

  const filtered = allMessages.filter(m=>{
    const inbox = isForMe(m);
    const sent = isFromMe(m);

    if(box==="inbox" && !inbox) return false;
    if(box==="sent" && !sent) return false;
    if(box==="all" && !(inbox || sent)) return false;

    if(!s) return true;

    const blob = `${safe(m.subject)} ${safe(m.body)} ${safe(m.fromName)} ${safe(m.fromUid)} ${safe(m.to)}`.toLowerCase();
    return blob.includes(s);
  });

  if(filtered.length===0){
    const empty = document.createElement("div");
    empty.className="note";
    empty.textContent = "Aucun message pour l‚Äôinstant.";
    messagesList.appendChild(empty);
    return;
  }

  filtered.forEach(m=>{
    const card = document.createElement("div");
    card.className="card";

    const when =
      m.createdAt?.toDate ? m.createdAt.toDate().toLocaleString() :
      (m.createdAt?.seconds ? new Date(m.createdAt.seconds*1000).toLocaleString() : "‚Äî");

    card.innerHTML = `
      <div class="card-head">
        <div>
          <div class="tracking">${safe(m.subject || "Sans objet")}</div>
          <div class="route">${when} ‚Ä¢ De: ${safe(m.fromName || m.fromUid)} ‚Ä¢ √Ä: ${safe(m.to)}</div>
        </div>
        <span class="badge" style="background:#000">${isFromMe(m) ? "ENVOY√â" : "RE√áU"}</span>
      </div>
      <div class="hr"></div>
      <div class="meta">${safe(m.body)}</div>
    `;
    messagesList.appendChild(card);
  });
}

msgBox.addEventListener("change", renderMessages);
msgSearch.addEventListener("input", renderMessages);
msgClear.addEventListener("click", ()=>{
  msgSearch.value="";
  msgBox.value="inbox";
  renderMessages();
});

sendMsgBtn.addEventListener("click", async()=>{
  if(!currentUser) return;
  const to = (msgTo.value||"").trim();
  const subject = (msgSubject.value||"").trim();
  const body = (msgBody.value||"").trim();

  if(!to || !body){
    alert("Destinataire + message requis.");
    return;
  }

  await addDoc(collection(db,"internalMessages"),{
    fromUid: currentUser.uid,
    fromName: userName.textContent || currentUser.email || "Admin",
    to,
    subject: subject || null,
    body,
    createdAt: serverTimestamp()
  });

  msgSubject.value="";
  msgBody.value="";
  alert("Message envoy√©.");
});

refreshMsgBtn.addEventListener("click", startMessages);

/* ================= PLANNING ================= */
let calendarStarted=false;
function startCalendar(){
  if(calendarStarted) return;
  calendarStarted=true;

  const q = query(collection(db,"internalCalendar"), orderBy("createdAt","desc"), limit(40));
  onSnapshot(q,(snap)=>{
    calendarList.innerHTML="";
    snap.forEach(ds=>{
      const e = ds.data();
      const card = document.createElement("div");
      card.className="card";

      const whenText =
        e.whenText ||
        (e.when?.toDate ? e.when.toDate().toLocaleString() : "‚Äî");

      card.innerHTML=`
        <div class="card-head">
          <div>
            <div class="tracking">${safe(e.title)}</div>
            <div class="route">${safe(e.where)} ‚Ä¢ Assign√©: ${safe(e.to)} ‚Ä¢ ${safe(whenText)}</div>
          </div>
          <span class="badge" style="background:#000">RDV</span>
        </div>
        <div class="hr"></div>
        <div class="meta"><b>Notes:</b> ${safe(e.notes)}</div>
      `;
      calendarList.appendChild(card);
    });
  });
}

calSaveBtn.addEventListener("click", async()=>{
  const title = (calTitle.value||"").trim();
  const whenVal = (calWhen.value||"").trim();
  const whereTxt = (calWhere.value||"").trim();
  const to = (calTo.value||"").trim();
  const notes = (calNotes.value||"").trim();

  if(!title || !whenVal){
    alert("Titre + date/heure requis.");
    return;
  }

  await addDoc(collection(db,"internalCalendar"),{
    title,
    whenText: whenVal,
    where: whereTxt || null,
    to: to || null,
    notes: notes || null,
    createdAt: serverTimestamp(),
    createdBy: currentUser ? currentUser.uid : null
  });

  calTitle.value="";
  calWhen.value="";
  calWhere.value="";
  calTo.value="";
  calNotes.value="";
  alert("Rendez-vous ajout√©.");
});
calRefreshBtn.addEventListener("click", startCalendar);

/* ================= OFFICE ================= */
let officeStarted=false;
function startOffice(){
  if(officeStarted) return;
  officeStarted=true;

  const q = query(collection(db,"officeLog"), orderBy("createdAt","desc"), limit(40));
  onSnapshot(q,(snap)=>{
    officeList.innerHTML="";
    snap.forEach(ds=>{
      const o = ds.data();
      const card = document.createElement("div");
      card.className="card";

      const when =
        o.createdAt?.toDate ? o.createdAt.toDate().toLocaleString() :
        (o.createdAt?.seconds ? new Date(o.createdAt.seconds*1000).toLocaleString() : "‚Äî");

      card.innerHTML=`
        <div class="card-head">
          <div>
            <div class="tracking">${safe(o.name)} ‚Ä¢ ${safe(o.phone)}</div>
            <div class="route">${safe(o.topic)} ‚Ä¢ ${when}</div>
          </div>
          <span class="badge" style="background:${o.priority==="urgent" ? "#e11d48" : "#000"}">${safe(o.priority||"normal")}</span>
        </div>
        <div class="hr"></div>
        <div class="meta">${safe(o.notes)}</div>
      `;
      officeList.appendChild(card);
    });
  });
}

officeSaveBtn.addEventListener("click", async()=>{
  const name = (officeName.value||"").trim();
  const phone = (officePhone.value||"").trim();
  const topic = (officeTopic.value||"").trim();
  const priority = officePriority.value || "normal";
  const notes = (officeNotes.value||"").trim();

  if(!name || !phone || !topic){
    alert("Client + t√©l√©phone + objet requis.");
    return;
  }

  await addDoc(collection(db,"officeLog"),{
    name, phone, topic, priority,
    notes: notes || null,
    createdAt: serverTimestamp(),
    createdBy: currentUser ? currentUser.uid : null
  });

  officeName.value="";
  officePhone.value="";
  officeTopic.value="";
  officePriority.value="normal";
  officeNotes.value="";
  alert("Enregistr√©.");
});
officeRefreshBtn.addEventListener("click", startOffice);

/* ================= ENTREPRISE ================= */
async function loadEnterprise(){
  const isSuper = (currentRole==="superadmin");
  entSaveBtn.disabled = !isSuper;
  entSaveBtn.textContent = isSuper ? "Enregistrer" : "Lecture seule";

  entCache.value = "ciza-logistics-v1";

  // text safe (no backend secrets)
  entInfo.value = isSuper
    ? "Vous pouvez modifier le paiement chauffeur par colis."
    : "Lecture seule (droits insuffisants).";

  const snap = await getDoc(doc(db,"settings","driverPay"));
  if(snap.exists()){
    const d = snap.data();
    entDriverPay.value = String(num(d.perDeliveredParcelBI,0));
  }else{
    entDriverPay.value = "";
  }
}

entSaveBtn.addEventListener("click", async()=>{
  if(currentRole!=="superadmin"){
    alert("Lecture seule : r√©serv√© superadmin.");
    return;
  }
  const v = Number((entDriverPay.value||"").trim());
  if(!Number.isFinite(v) || v<0){
    alert("Valeur invalide.");
    return;
  }
  await setDoc(doc(db,"settings","driverPay"),{
    perDeliveredParcelBI: v,
    updatedAt: serverTimestamp(),
    updatedBy: currentUser ? currentUser.uid : null
  }, { merge:true });

  await loadDriverRate();
  alert("Param√®tre enregistr√©.");
});

entRefreshBtn.addEventListener("click", loadEnterprise);

/* ================= SERVICE WORKER ================= */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('../sw.js');
}

/* ================= DEFAULT VIEW ================= */
showView("colis");
</script>

</body>
</html>
