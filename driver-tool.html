<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="#000000">
<title>Ciza Driver</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{margin:0;font-family:Inter;background:#f3f4f6}
.header{background:#000;color:#fff;padding:14px;display:flex;justify-content:space-between;align-items:center}
.brand{color:#D4AF37;font-weight:900}
.badge{padding:6px 12px;border-radius:999px;font-weight:700}
.online{background:#16a34a}
.card{background:#fff;margin:16px;padding:16px;border-radius:16px}
#map{height:260px;border-radius:16px;margin-top:10px}
.btn{width:100%;padding:14px;border:none;border-radius:14px;font-weight:900;margin-top:10px}
.gold{background:#D4AF37}
.dark{background:#111;color:#fff}
input{width:100%;padding:12px;margin-top:10px;border-radius:12px;border:1px solid #ddd}
canvas{border:1px solid #ddd;margin-top:10px;border-radius:12px}
</style>
</head>

<body>

<div class="header">
  <div class="brand">ðŸšš Ciza Driver</div>
  <div>
    <span class="badge online">En ligne</span>
    <button id="logoutBtn" class="btn gold" style="width:auto;margin-left:10px;">DÃ©connexion</button>
  </div>
</div>

<div class="card">
  <h2>Livraison active</h2>
  <div id="activeShipmentInfo">Aucune</div>
  <div id="etaInfo"></div>
  <div id="map"></div>

  <!-- OTP + Signature -->
  <input id="otpInput" placeholder="Code OTP client">
  <canvas id="signaturePad" width="300" height="150"></canvas>
  <button id="clearSignature" class="btn dark">Effacer signature</button>

</div>

<div class="card">
  <button id="scanBtn" class="btn dark">ðŸ“· Scanner colis</button>
</div>

<div id="stickyAction" style="display:none;padding:16px;">
  <button id="mainActionBtn" class="btn gold">Action</button>
</div>

<div id="reader" style="width:100%;display:none;"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, updateDoc,
  collection, query, where, onSnapshot,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

import {
  getAuth, onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
  getStorage, ref, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const app = initializeApp({
  apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
  authDomain:"ciza-logistics.firebaseapp.com",
  projectId:"ciza-logistics",
  storageBucket:"ciza-logistics.appspot.com"
});

const db=getFirestore(app);
const auth=getAuth(app);
const storage=getStorage(app);

let currentUser=null;
let activeShipment=null;
let driverMarker=null;
let destinationMarker=null;
let driverSpeed=0;

let lastLat=null;
let lastLng=null;
let lastAccuracy=null;

let map=L.map('map').setView([-3.3731,29.9189],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

/* AUTH */

onAuthStateChanged(auth, async(user)=>{
  if(!user){ window.location.href="./login.html"; return; }

  const snap=await getDoc(doc(db,"users",user.uid));
  if(!snap.exists() || snap.data().role!=="driver"){
    await signOut(auth);
    window.location.href="./login.html";
    return;
  }

  currentUser=user;
  startGPS();
  startShipmentListener();
});

/* GPS */

function startGPS(){
  navigator.geolocation.watchPosition(async(pos)=>{

    lastLat = pos.coords.latitude;
    lastLng = pos.coords.longitude;
    lastAccuracy = pos.coords.accuracy;

    driverSpeed=pos.coords.speed||0;

    if(driverMarker){
      driverMarker.setLatLng([lastLat,lastLng]);
    }else{
      driverMarker=L.marker([lastLat,lastLng]).addTo(map);
    }

    updateETA();

  },{enableHighAccuracy:true});
}

/* DISTANCE CALC */

function calculateDistance(lat1, lon1, lat2, lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+
    Math.cos(lat1*Math.PI/180)*
    Math.cos(lat2*Math.PI/180)*
    Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* LISTENER */

function startShipmentListener(){
  const q=query(
    collection(db,"shipments"),
    where("assignedDriverId","==",currentUser.uid)
  );

  onSnapshot(q,(snapshot)=>{
    let found=false;

    snapshot.forEach(docSnap=>{
      const s={id:docSnap.id,...docSnap.data()};

      if(s.status==="assigned" || s.status==="in_transit"){
        activeShipment=s;
        found=true;

        document.getElementById("activeShipmentInfo").textContent=
          s.trackingCode||s.id;

        if(s.toLat && s.toLng){
          if(destinationMarker){
            destinationMarker.setLatLng([s.toLat,s.toLng]);
          }else{
            destinationMarker=L.marker([s.toLat,s.toLng]).addTo(map);
          }
        }

        document.getElementById("stickyAction").style.display="block";
        document.getElementById("mainActionBtn").textContent=
          s.status==="assigned"?
          "ðŸš€ DÃ©marrer livraison":
          "ðŸ“¦ Confirmer livraison";
      }
    });

    if(!found){
      document.getElementById("activeShipmentInfo").textContent="Aucune";
      document.getElementById("stickyAction").style.display="none";
      activeShipment=null;
    }
  });
}

/* SIGNATURE */

const canvas=document.getElementById("signaturePad");
const ctx=canvas.getContext("2d");
let drawing=false;

canvas.addEventListener("mousedown",()=>drawing=true);
canvas.addEventListener("mouseup",()=>drawing=false);
canvas.addEventListener("mousemove",(e)=>{
  if(!drawing) return;
  ctx.lineWidth=2;
  ctx.lineCap="round";
  ctx.strokeStyle="#000";
  ctx.lineTo(e.offsetX,e.offsetY);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(e.offsetX,e.offsetY);
});

document.getElementById("clearSignature").onclick=()=>{
  ctx.clearRect(0,0,canvas.width,canvas.height);
};

/* ACTION */

document.getElementById("mainActionBtn").onclick=async()=>{

  if(!activeShipment) return;

  if(activeShipment.status==="assigned"){
    await updateDoc(doc(db,"shipments",activeShipment.id),{
      status:"in_transit",
      inTransitAt:serverTimestamp()
    });
  }

  else if(activeShipment.status==="in_transit"){

    const otpInput=document.getElementById("otpInput").value.trim();
    if(otpInput!==activeShipment.deliveryOtp){
      alert("OTP incorrect.");
      return;
    }

    const signatureData=canvas.toDataURL();
    if(signatureData.length<1000){
      alert("Signature obligatoire.");
      return;
    }

    if(!lastLat || !activeShipment.toLat){
      alert("GPS non disponible.");
      return;
    }

    const distanceKm=calculateDistance(
      lastLat,lastLng,
      activeShipment.toLat,activeShipment.toLng
    );

    if(distanceKm*1000>100){
      alert("Vous Ãªtes trop loin du point de livraison.");
      return;
    }

    const file=await capturePhoto();
    if(!file){
      alert("Photo obligatoire.");
      return;
    }

    const storageRef=ref(storage,"proofs/"+activeShipment.id+"/photo.jpg");
    await uploadBytes(storageRef,file);
    const url=await getDownloadURL(storageRef);

    await updateDoc(doc(db,"shipments",activeShipment.id),{
      status:"delivered",
      deliveredAt:serverTimestamp(),
      proofPhoto:url,
      signature:signatureData,
      deliveryLocation:{
        lat:lastLat,
        lng:lastLng,
        accuracy:lastAccuracy
      }
    });

    alert("Livraison confirmÃ©e.");
  }
};

/* ETA */

function updateETA(){
  if(!activeShipment || !destinationMarker || !driverMarker) return;

  const lat1=driverMarker.getLatLng().lat;
  const lng1=driverMarker.getLatLng().lng;
  const lat2=destinationMarker.getLatLng().lat;
  const lng2=destinationMarker.getLatLng().lng;

  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lng2-lng1)*Math.PI/180;

  const a=Math.sin(dLat/2)**2+
    Math.cos(lat1*Math.PI/180)*
    Math.cos(lat2*Math.PI/180)*
    Math.sin(dLon/2)**2;

  const distance=R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  const speedKmh=(driverSpeed||10)*3.6;
  const eta=speedKmh>0?(distance/speedKmh)*60:0;

  document.getElementById("etaInfo").innerHTML=
    `ðŸ“ ${distance.toFixed(2)} km â€¢ â± ${eta.toFixed(0)} min`;
}

/* PHOTO */

function capturePhoto(){
  return new Promise(resolve=>{
    const input=document.createElement("input");
    input.type="file";
    input.accept="image/*";
    input.capture="environment";
    input.onchange=()=>resolve(input.files[0]);
    input.click();
  });
}

/* LOGOUT */

document.getElementById("logoutBtn").onclick=async()=>{
  await signOut(auth);
  window.location.href="./login.html";
};

</script>

</body>
</html>
