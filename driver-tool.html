<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="#000000">

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<title>Ciza Driver Tool</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
:root{
   --bg:#0f1115;
   --card:#1a1d24;
   --muted:#9ca3af;
   --ok:#22c55e;
   --warn:#facc15;
   --bad:#ef4444;
   --blue:#3b82f6;
   --purple:#8b5cf6;
   --gold:#D4AF37;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter, sans-serif;
  background:var(--bg);
  color:#eaeaea;
}
.header{
  background:rgba(0,0,0,0.96);
  color:#fff;
  padding:14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;
  top:0;
  z-index:10;
}

.brand{color:var(--gold);font-weight:900;font-size:16px;}
.driverName{font-size:12px;color:#e5e7eb;margin-top:4px;}

.header-right{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}

.badge{
  padding:6px 12px;
  border-radius:999px;
  font-weight:900;
  font-size:12px;
  background:var(--ok);
  color:#fff;
}

.badge.gold{background:var(--gold);color:#000;}
.badge.bad{background:var(--bad);color:#fff;}

.logout-btn{
  background:var(--gold);
  border:none;
  padding:7px 12px;
  border-radius:12px;
  font-weight:900;
  cursor:pointer;
}

.container{width:95%;max-width:1100px;margin:16px auto 80px auto;}

.card{
  background:var(--card);
  border-radius:16px;
  padding:18px;
  margin-bottom:15px;
  box-shadow:0 6px 25px rgba(0,0,0,0.5);
  border:1px solid rgba(255,255,255,0.05);
  transition:0.2s ease;
}

.card:hover{
  transform:translateY(-3px);
  box-shadow:0 10px 35px rgba(0,0,0,0.7);
}
.section-title{
  font-weight:900;
  margin-bottom:10px;
  display:flex;
  justify-content:space-between;
}

.actionsRow{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:10px;
}

.btn{
  border:none;
  border-radius:14px;
  padding:12px 14px;
  font-weight:900;
  cursor:pointer;
}

.btn.full{width:100%;}
.btn.dark{background:#111;color:#fff;}
.btn.gold{background:var(--gold);color:#000;}
.btn.red{background:var(--bad);color:#fff;}
.btn.restore{background:#2563eb;color:#fff;}

.btn.nav-ready{
  background:var(--gold);
  color:#000;
  animation:navPulse 1.6s infinite;
}

@keyframes navPulse{
  0%{box-shadow:0 0 0 0 rgba(212,175,55,0.7);}
  70%{box-shadow:0 0 0 12px rgba(212,175,55,0);}
  100%{box-shadow:0 0 0 0 rgba(212,175,55,0);}
}

input{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(0,0,0,0.12);
  margin-top:10px;
}

#map{height:280px;border-radius:16px;margin-top:10px;}

.small{font-size:12px;color:var(--muted);}
.videoWrap{border-radius:16px;overflow:hidden;background:#000;}
video{width:100%;display:block;}

canvas{
  border:1px solid rgba(0,0,0,0.15);
  border-radius:14px;
  width:100%;
  height:160px;
  margin-top:10px;
  touch-action:none;
  background:#fff;
}
</style>
</head>

  <div style="font-weight:900;color:#D4AF37;margin-bottom:25px;font-size:18px;">
    ğŸšš Menu Chauffeur
  </div>

  <button class="btn dark full" onclick="openArchived()">
    ğŸ“¦ ArchivÃ©s
  </button>

  <button class="btn dark full" onclick="openPrivacy()" style="margin-top:12px;">
    ğŸ”’ ConfidentialitÃ©
  </button>

  <button class="btn dark full" onclick="openAbout()" style="margin-top:12px;">
    â„¹ï¸ Ã€ propos
  </button>

  <button class="btn red full" id="logoutMenuBtn" style="margin-top:12px;">
    ğŸšª DÃ©connexion
  </button>

  <button class="btn dark full" id="deleteAccountBtn" style="margin-top:12px;">
    ğŸ—‘ Supprimer mon compte
  </button>

</div>
  
<body>

<!-- MENU OVERLAY -->
<div id="sideMenu" style="
position:fixed;
top:0;
right:-280px;
width:280px;
height:100%;
background:#111;
box-shadow:-5px 0 20px rgba(0,0,0,0.6);
transition:0.3s;
z-index:9999;
padding:20px;
display:flex;
flex-direction:column;
">
   
<div class="header">
  <div>
    <div class="brand">ğŸšš Ciza Driver Tool</div>
    <div class="driverName" id="driverName">Chargement...</div>
  </div>
  <div class="header-right">
    <span class="badge" id="connectionStatus">En ligne</span>
    <span class="badge gold" id="deliveryCounter">0</span>
  <button class="logout-btn" id="menuBtn">â˜°</button>
  </div>
</div>

<div class="container">

<!-- SCANNER -->
<div class="card">
  <div class="section-title">ğŸ“· Scanner colis</div>
  <div class="videoWrap">
    <video id="scanVideo" playsinline></video>
  </div>
  <div class="actionsRow">
    <button class="btn dark" id="startScanBtn">Scanner</button>
    <button class="btn gold" id="stopScanBtn">Stop</button>
  </div>
</div>

<!-- LISTES -->
<div class="card">
  <div class="section-title">ğŸŸ¡ Ã€ traiter</div>
  <div id="assignedList"></div>
</div>

<div class="card">
  <div class="section-title">ğŸ”µ En transit</div>
  <div id="transitList"></div>
</div>

<div class="card">
  <div class="section-title">ğŸŸ¢ LivrÃ©s aujourdâ€™hui</div>
  <div id="deliveredList"></div>
</div>

<!-- DETAILS -->
<div class="card">
  <div class="section-title">
    ğŸ“¦ DÃ©tails & Navigation
    <span id="selectedHint">SÃ©lectionne un colis</span>
  </div>

  <div id="shipmentDetails">Aucun colis sÃ©lectionnÃ©</div>
  <div id="map"></div>

  <div class="actionsRow">
    <button class="btn gold full" id="mainActionBtn" style="display:none;">Action</button>
    <button class="btn dark full" id="navBtn" style="display:none;">ğŸ§­ Navigation</button>
    <button class="btn red full" id="archiveBtn" style="display:none;">ğŸ“¦ Archiver</button>
  </div>
</div>

<!-- FINALISATION -->
<div class="card" id="deliverySecurity" style="display:none;">
  <div class="section-title">ğŸ” Finalisation livraison</div>
  <input type="text" id="otpInput" placeholder="Entrer OTP client">
  <input type="file" accept="image/*" capture="environment" id="photoInput">
  <canvas id="signatureCanvas"></canvas>
  <div class="actionsRow">
    <button class="btn gold" id="clearSignature">Effacer signature</button>
  </div>
</div>

</div><script type="module">

/* =========================
   FIREBASE INIT
========================= */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { 
  getFirestore, collection, query, where, onSnapshot,
  doc, getDoc, updateDoc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
  authDomain:"ciza-logistics.firebaseapp.com",
  projectId:"ciza-logistics",
  storageBucket:"ciza-logistics.appspot.com"
});

const db = getFirestore(app);
const auth = getAuth(app);

/* =========================
   GLOBAL STATE
========================= */

let currentUser = null;
let selectedShipment = null;
let selectedShipmentId = null;

let lastLat = null;
let lastLng = null;

let map = L.map('map').setView([-3.3731,29.9189],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

let driverMarker = null;

/* =========================
   AUTH
========================= */

onAuthStateChanged(auth, async(user)=>{
  if(!user){
    location.href="login.html";
    return;
  }

  const userSnap = await getDoc(doc(db,"users",user.uid));
  if(!userSnap.exists()){
    await signOut(auth);
    location.href="login.html";
    return;
  }

  const userData = userSnap.data();

  if(userData.role !== "driver" || userData.accountStatus !== "approved"){
    alert("AccÃ¨s refusÃ©.");
    await signOut(auth);
    location.href="login.html";
    return;
  }

  currentUser = user;
  document.getElementById("driverName").textContent = userData.fullName || "Driver";

  listenShipmentsMulti();
});

/* =========================
   GPS
========================= */

navigator.geolocation.watchPosition(pos=>{
  lastLat = pos.coords.latitude;
  lastLng = pos.coords.longitude;

  if(driverMarker){
    driverMarker.setLatLng([lastLat,lastLng]);
  }else{
    driverMarker = L.marker([lastLat,lastLng]).addTo(map);
    map.setView([lastLat,lastLng],13);
  }
});

/* =========================
   MULTI SHIPMENTS
========================= */

function listenShipmentsMulti(){

  const q = query(
    collection(db,"shipments"),
    where("assignedDriverId","==",currentUser.uid)
  );

  onSnapshot(q,(snap)=>{

    const assigned = [];
    const transit = [];
    const deliveredToday = [];
    const archived = [];

    snap.forEach(docSnap=>{

      const d = docSnap.data() || {};
      d.id = docSnap.id;

      if(d.archivedByDriver){
        archived.push(d);
        return;
      }

      const st = (d.status||"").toString();

      if(st==="assigned" || st==="picked_up") assigned.push(d);
      else if(st==="in_transit") transit.push(d);
      else if(st==="delivered") deliveredToday.push(d);
    });

    render("assignedList",assigned);
    render("transitList",transit);
    render("deliveredList",deliveredToday);
    renderArchived(archived);

    document.getElementById("deliveryCounter").textContent = deliveredToday.length;
    document.getElementById("countArchived").textContent = archived.length;
  });
}

/* =========================
   RENDER CARDS
========================= */

function render(id,list){
  const el = document.getElementById(id);
  if(!list.length){
    el.innerHTML = "<div class='small'>Aucun colis.</div>";
    return;
  }

  el.innerHTML = list.map(renderShipmentCard).join("");
}

function renderArchived(list){
  const el = document.getElementById("archivedList");
  if(!list.length){
    el.innerHTML = "<div class='small'>Aucun colis archivÃ©.</div>";
    return;
  }

  el.innerHTML = list.map(d=>`
    <div class="shipment-card">
      <b>${d.trackingCode||d.id}</b><br>
      ğŸ“ ${d.fromCity||""} â†’ ${d.toCity||""}
      <div class="actionsRow">
        <button class="btn restore" onclick="restoreShipment('${d.id}')">Restaurer</button>
      </div>
    </div>
  `).join("");
}

function renderShipmentCard(d){

  return `
  <div class="shipment-card">
    <b>${d.trackingCode||d.id}</b><br>
    ğŸ“ ${d.fromCity||""} â†’ ${d.toCity||""}
    <div class="actionsRow">
      <button class="btn dark" onclick="selectShipment('${d.id}')">Voir dÃ©tails</button>
    </div>
  </div>
  `;
}
/* =========================
   SELECT SHIPMENT
========================= */

window.selectShipment = function(id){
  selectShipmentInternal(id);
};

async function selectShipmentInternal(id){

  const snap = await getDoc(doc(db,"shipments",id));
  if(!snap.exists()) return;

  selectedShipmentId = id;
  selectedShipment = snap.data();

  const d = selectedShipment;
  const st = (d.status||"").toString();

  const navBtn = document.getElementById("navBtn");
  const archiveBtn = document.getElementById("archiveBtn");
  const securityPanel = document.getElementById("deliverySecurity");
  const mainBtn = document.getElementById("mainActionBtn");

  /* =========================
     RESET VISUAL STATE
  ========================= */

  navBtn.classList.remove("nav-ready");
  navBtn.style.display = "none";
  archiveBtn.style.display = "none";
  securityPanel.style.display = "none";
  mainBtn.style.display = "none";

  /* =========================
     HEADER
  ========================= */

  document.getElementById("selectedHint").textContent =
    "SÃ©lectionnÃ© : " + (d.trackingCode||id);

  /* =========================
     DÃ‰TAILS CHAUFFEUR COMPLETS
  ========================= */
document.getElementById("shipmentDetails").innerHTML = `
<div style="background:#16181d;border-radius:22px;padding:22px;border:1px solid rgba(212,175,55,0.35);box-shadow:0 12px 35px rgba(0,0,0,0.6);">

  <div style="font-size:20px;font-weight:900;color:var(--gold);margin-bottom:20px;">
    ğŸ“¦ ${d.trackingCode || id}
  </div>

  <!-- ğŸšš Chauffeur -->
  <div style="background:#1e222b;padding:16px;border-radius:16px;margin-bottom:16px;border:1px solid rgba(212,175,55,0.25);">
    <div style="font-weight:800;margin-bottom:10px;color:var(--gold);">
      ğŸšš Chauffeur
    </div>
    <div>ğŸ‘¤ <b>Nom :</b> ${d.driverName || "Non assignÃ©"}</div>
    <div>ğŸ“ <b>TÃ©lÃ©phone :</b> ${d.driverPhone || "â€”"}</div>
    <div>ğŸš— <b>Plaque :</b> ${d.driverPlate || "â€”"}</div>
  </div>

  <!-- ğŸ  DÃ©part -->
  <div style="background:#1e222b;padding:16px;border-radius:16px;margin-bottom:16px;border:1px solid rgba(212,175,55,0.25);">
    <div style="font-weight:800;margin-bottom:10px;color:var(--gold);">
      ğŸ  DÃ©part
    </div>

    <div>
      ${
        d.fromAddress ||
        d.pickupAddress ||
        (
          (d.fromProvince || "") +
          (d.fromCommune ? " / " + d.fromCommune : "") +
          (d.fromQuartier ? " / " + d.fromQuartier : "")
        ) ||
        "â€”"
      }
    </div>

    <div style="opacity:0.75;margin-top:6px;">
      ğŸ“ ${d.fromLandmark || d.repereDepart || "â€”"}
    </div>
  </div>

  <!-- ğŸ¯ Destination -->
  <div style="background:#1e222b;padding:16px;border-radius:16px;margin-bottom:16px;border:1px solid rgba(212,175,55,0.25);">
    <div style="font-weight:800;margin-bottom:10px;color:var(--gold);">
      ğŸ¯ Destination
    </div>

    <div>
      ${
        d.destinationAddress ||
        d.toAddress ||
        (
          (d.toProvince || "") +
          (d.toCommune ? " / " + d.toCommune : "") +
          (d.toQuartier ? " / " + d.toQuartier : "")
        ) ||
        "â€”"
      }
    </div>

    <div style="opacity:0.75;margin-top:6px;">
      ğŸ“ ${d.toLandmark || d.repereDestination || "â€”"}
    </div>
  </div>

  <!-- ğŸ‘¤ Contact -->
  <div style="background:#1e222b;padding:16px;border-radius:16px;border:1px solid rgba(212,175,55,0.25);">
    <div style="font-weight:800;margin-bottom:10px;color:var(--gold);">
      ğŸ‘¤ Contact
    </div>
    <div>ğŸ‘¤ <b>Nom :</b> ${d.receiverName || d.senderName || "â€”"}</div>
    <div>ğŸ“ <b>TÃ©lÃ©phone :</b> ${d.receiverPhone || d.senderPhone || "â€”"}</div>
    <div style="margin-top:8px;opacity:0.65;">
      ğŸ“ <b>Note :</b> ${d.adminNote || "â€”"}
    </div>
  </div>

</div>
`;
   /* =========================
     LOGIQUE Ã‰TAPES MÃ‰TIER
  ========================= */

  if(st==="assigned"){
    mainBtn.style.display = "block";
    mainBtn.textContent = "ğŸ“¦ Marquer comme rÃ©cupÃ©rÃ©";
  }

  if(st==="picked_up"){
    mainBtn.style.display = "block";
    mainBtn.textContent = "ğŸšš DÃ©marrer le transit";
  }

  if(st==="in_transit"){
    mainBtn.style.display = "block";
    mainBtn.textContent = "âœ… Finaliser livraison";

    navBtn.style.display = "block";
    navBtn.classList.add("nav-ready");

    securityPanel.style.display = "block";

    // ğŸ”¥ Calcul route automatique
    calculateRoute_OSRM();
  }

  if(st==="delivered"){
    archiveBtn.style.display = "block";
  }
}
/* =========================
   NAVIGATION
========================= */

function openNavigation(){

  if(!selectedShipment || !lastLat || !lastLng) return;
  if(!selectedShipment.toLat || !selectedShipment.toLng) return;

  const url =
  `https://www.google.com/maps/dir/?api=1&origin=${lastLat},${lastLng}&destination=${selectedShipment.toLat},${selectedShipment.toLng}`;

  window.open(url,"_blank");
}

document.getElementById("navBtn").onclick = openNavigation;

/* =========================
   ARCHIVE / RESTORE
========================= */

document.getElementById("archiveBtn").onclick = async function(){

  if(!selectedShipmentId) return;

  await updateDoc(doc(db,"shipments",selectedShipmentId),{
    archivedByDriver:true,
    archivedAt:serverTimestamp()
  });
};

window.restoreShipment = async function(id){
  await updateDoc(doc(db,"shipments",id),{
    archivedByDriver:false
  });
};

   
   DISTANCE CALC
========================= */

function calcDistKm(lat1,lon1,lat2,lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+
    Math.cos(lat1*Math.PI/180)*
    Math.cos(lat2*Math.PI/180)*
    Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* =========================
   LIVE TRACKING
========================= */

let lastTrackPushAt = 0;
let lastTrackLat = null;
let lastTrackLng = null;

async function maybePushTrackingPoint(){

  if(!selectedShipment || !selectedShipmentId) return;

  const st = (selectedShipment.status||"").toString();
  if(!(st==="picked_up" || st==="in_transit")) return;

  if(!navigator.onLine) return;
  if(lastLat==null || lastLng==null) return;

  const now = Date.now();
  const minIntervalMs = 10000;
  const minMoveM = 20;

  let movedM = 999999;

  if(lastTrackLat!=null && lastTrackLng!=null){
    movedM = calcDistKm(lastTrackLat,lastTrackLng,lastLat,lastLng) * 1000;
  }

  if((now-lastTrackPushAt)<minIntervalMs && movedM<minMoveM) return;

  await updateDoc(
    doc(db,"shipments",selectedShipmentId),
    { lastDriverLocation:{lat:lastLat,lng:lastLng,timestamp:serverTimestamp()} }
  );

  lastTrackPushAt = now;
  lastTrackLat = lastLat;
  lastTrackLng = lastLng;
}

setInterval(()=>{ maybePushTrackingPoint(); },10000);

/* =========================
   OSRM ROUTE
========================= */

async function calculateRoute_OSRM(){

  if(!selectedShipment || !lastLat || !selectedShipment.toLat || !selectedShipment.toLng) return;

  try{
    const url =
    `https://router.project-osrm.org/route/v1/driving/${lastLng},${lastLat};${selectedShipment.toLng},${selectedShipment.toLat}?overview=full&geometries=geojson`;

    const response = await fetch(url);
    const data = await response.json();

    if(!data.routes || !data.routes.length) return;

    const route = data.routes[0];
    const coords = route.geometry.coordinates.map(c=>[c[1],c[0]]);

    if(window.routeLayer){
      map.removeLayer(window.routeLayer);
    }

    window.routeLayer =
      L.polyline(coords,{color:"#D4AF37",weight:5}).addTo(map);

    map.fitBounds(window.routeLayer.getBounds(),{padding:[20,20]});

  }catch(e){
    console.log("OSRM error:",e);
  }
}

/* =========================
   MAIN ACTION BUTTON
========================= */

document.getElementById("mainActionBtn").onclick = async function(){

  if(!selectedShipmentId) return;

  const refDoc = doc(db,"shipments",selectedShipmentId);
  const snap = await getDoc(refDoc);
  if(!snap.exists()) return;

  const data = snap.data();
  const st = (data.status||"").toString();

  /* assigned â†’ picked_up */
  if(st==="assigned"){
    await updateDoc(refDoc,{
      status:"picked_up",
      pickedUpAt:serverTimestamp()
    });
    return;
  }

  /* picked_up â†’ in_transit */
  if(st==="picked_up"){

    let patch = {
      status:"in_transit",
      transitAt:serverTimestamp()
    };

    if(!data.otpCode){
      const otp = Math.floor(1000+Math.random()*9000).toString();
      patch.otpCode = otp;
      patch.otpGeneratedAt = serverTimestamp();
    }

    await updateDoc(refDoc,patch);
    return;
  }

  /* in_transit â†’ delivered */
  if(st==="in_transit"){

    if(!navigator.onLine){
      alert("Connexion requise.");
      return;
    }

    if(lastLat==null || lastLng==null){
      alert("GPS indisponible.");
      return;
    }

    if(!data.toLat || !data.toLng){
      alert("Destination GPS manquante.");
      return;
    }

    const distM = calcDistKm(lastLat,lastLng,data.toLat,data.toLng)*1000;

    if(distM>100){
      alert("Vous Ãªtes Ã  "+Math.round(distM)+"m. Rapprochez-vous.");
      return;
    }

    const enteredOtp =
      (document.getElementById("otpInput").value||"").trim();

    if(enteredOtp !== (data.otpCode||"")){
      alert("OTP incorrect.");
      return;
    }

    const photo =
      document.getElementById("photoInput").files[0];

    if(!photo){
      alert("Photo obligatoire.");
      return;
    }

    if(signatureIsEmpty()){
      alert("Signature obligatoire.");
      return;
    }

    await updateDoc(refDoc,{
      status:"delivered",
      deliveredAt:serverTimestamp(),
      deliveryLocation:{lat:lastLat,lng:lastLng}
    });

    alert("Livraison confirmÃ©e âœ…");

    document.getElementById("otpInput").value="";
    document.getElementById("photoInput").value="";
    clearSignatureCanvas();
  }
};/* ========================
   SIGNATURE CANVAS
========================= */

const signatureCanvas = document.getElementById("signatureCanvas");
const sigCtx = signatureCanvas.getContext("2d");
let drawing=false;
let lastPos=null;
let hasInk=false;

function resizeSignatureCanvas(){
  const rect = signatureCanvas.getBoundingClientRect();
  const ratio = Math.max(window.devicePixelRatio||1,1);
  signatureCanvas.width = Math.floor(rect.width*ratio);
  signatureCanvas.height = Math.floor(rect.height*ratio);
  sigCtx.setTransform(ratio,0,0,ratio,0,0);
  sigCtx.lineWidth = 2;
  sigCtx.lineCap = "round";
}
resizeSignatureCanvas();
window.addEventListener("resize",resizeSignatureCanvas);

function getPos(e){
  const rect = signatureCanvas.getBoundingClientRect();
  if(e.touches && e.touches[0]){
    return {x:e.touches[0].clientX-rect.left,y:e.touches[0].clientY-rect.top};
  }
  return {x:e.clientX-rect.left,y:e.clientY-rect.top};
}

function drawTo(pos){
  if(!lastPos){ lastPos=pos; return; }
  sigCtx.beginPath();
  sigCtx.moveTo(lastPos.x,lastPos.y);
  sigCtx.lineTo(pos.x,pos.y);
  sigCtx.stroke();
  lastPos=pos;
  hasInk=true;
}

signatureCanvas.addEventListener("mousedown",(e)=>{drawing=true;lastPos=getPos(e);});
signatureCanvas.addEventListener("mousemove",(e)=>{if(!drawing)return;drawTo(getPos(e));});
signatureCanvas.addEventListener("mouseup",()=>{drawing=false;lastPos=null;});
signatureCanvas.addEventListener("mouseleave",()=>{drawing=false;lastPos=null;});

signatureCanvas.addEventListener("touchstart",(e)=>{drawing=true;lastPos=getPos(e);e.preventDefault();},{passive:false});
signatureCanvas.addEventListener("touchmove",(e)=>{if(!drawing)return;drawTo(getPos(e));e.preventDefault();},{passive:false});
signatureCanvas.addEventListener("touchend",()=>{drawing=false;lastPos=null;},{passive:true});

function clearSignatureCanvas(){
  sigCtx.clearRect(0,0,signatureCanvas.width,signatureCanvas.height);
  hasInk=false;
}

function signatureIsEmpty(){
  return !hasInk;
}

document.getElementById("clearSignature").onclick = clearSignatureCanvas;

/* =========================
   KPI JOUR
========================= */

async function loadKPI(){

  const today=new Date();
  today.setHours(0,0,0,0);

  const q=query(collection(db,"shipments"),
    where("assignedDriverId","==",currentUser.uid));

  const snap=await getDocs(q);

  let delivered=0;

  snap.forEach(docSnap=>{
    const d=docSnap.data();
    if(d.status==="delivered" &&
       d.deliveredAt?.toDate &&
       d.deliveredAt.toDate()>=today){
      delivered++;
    }
  });

  document.getElementById("deliveryCounter").textContent=delivered;
}

/* =========================
   SCANNER ZXING
========================= */

let codeReader=null;
let scanActive=false;

document.getElementById("startScanBtn").onclick=async()=>{

  if(scanActive) return;

  try{
    await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  }catch(e){
    alert("Permission camÃ©ra refusÃ©e.");
    return;
  }

  scanActive=true;

  codeReader = new ZXing.BrowserMultiFormatReader();

  await codeReader.decodeFromVideoDevice(
    null,
    document.getElementById("scanVideo"),
    async(result,err)=>{
      if(result){

        const text=(result.getText()||"").trim();
        if(!text) return;

        try{ codeReader.reset(); }catch(e){}
        scanActive=false;

        const snap=await getDoc(doc(db,"shipments",text));
        if(!snap.exists()){
          alert("Colis introuvable.");
          return;
        }

        await selectShipmentInternal(text);
      }
    }
  );
};

document.getElementById("stopScanBtn").onclick=()=>{
  try{ if(codeReader) codeReader.reset(); }catch(e){}
  scanActive=false;
};

/* =========================
   SERVICE WORKER
========================= */

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./sw.js").catch(()=>{});
}

/* =========================
   SIDE MENU
========================= */

const sideMenu = document.getElementById("sideMenu");
const menuBtn = document.getElementById("menuBtn");

menuBtn.onclick = function(){
  if(sideMenu.style.right === "0px"){
    sideMenu.style.right = "-280px";
  }else{
    sideMenu.style.right = "0px";
  }
};

function closeMenu(){
  sideMenu.style.right = "-280px";
}

window.openArchived = function(){
  closeMenu();
  alert("Affichage des colis archivÃ©s Ã  implÃ©menter.");
};

window.openPrivacy = function(){
  alert("Politique de confidentialitÃ© Ciza Logistics.");
};

window.openAbout = function(){
  alert("Ciza Driver Tool v1.0\nCiza Group.");
};

document.getElementById("logoutMenuBtn").onclick = async()=>{
  await signOut(auth);
  location.href="login.html";
};

document.getElementById("deleteAccountBtn").onclick = async()=>{
  if(!confirm("Voulez-vous vraiment supprimer votre compte ?")) return;

  try{
    await auth.currentUser.delete();
    alert("Compte supprimÃ©.");
    location.href="login.html";
  }catch(e){
    alert("Reconnectez-vous pour supprimer le compte.");
  }
};
  
</script>
</body>
</html>
