<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dossier Chauffeur | Admin</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Inter,Arial;background:#f4f6f9;color:#111}
.container{max-width:1200px;margin:auto;padding:30px}

.header{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:30px;
}
.title{font-size:20px;font-weight:900}
.back-btn{
background:#000;
color:#D4AF37;
padding:10px 14px;
border-radius:10px;
text-decoration:none;
font-weight:900;
}

.card{
background:#fff;
padding:20px;
border-radius:16px;
margin-bottom:20px;
border:1px solid rgba(0,0,0,.05);
}
.card h3{
margin-bottom:12px;
font-size:14px;
font-weight:900;
}

.meta{
font-size:13px;
line-height:1.7;
}

input[type="file"]{
margin-top:10px;
}

.upload-btn{
background:#D4AF37;
border:none;
padding:10px 14px;
border-radius:10px;
font-weight:900;
cursor:pointer;
margin-top:10px;
}
.link{
display:block;
margin-top:6px;
font-size:12px;
color:#2980b9;
}
</style>
</head>

<body>

<div class="container">

<div class="header">
<div class="title">Dossier Chauffeur</div>
<a href="admin-parcel.html" class="back-btn">← Retour</a>
</div>

<div id="content"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

/* FIREBASE */
const app = initializeApp({
apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
authDomain:"ciza-logistics.firebaseapp.com",
projectId:"ciza-logistics",
storageBucket:"ciza-logistics.appspot.com"
});
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

/* ADMIN GUARD */
onAuthStateChanged(auth, async(user)=>{
if(!user){ location.href="../login.html"; return; }
const snap = await getDoc(doc(db,"users",user.uid));
if(!snap.exists()){ location.href="../login.html"; return; }
const data=snap.data();
if(data.role!=="admin" && data.role!=="superadmin"){
location.href="../login.html";
}
});

/* GET DRIVER */
const params = new URLSearchParams(window.location.search);
const driverId = params.get("id");

if(!driverId){
document.getElementById("content").innerHTML="Chauffeur non spécifié.";
}else{
loadDriver();
}

async function loadDriver(){
const snap = await getDoc(doc(db,"users",driverId));
if(!snap.exists()){
document.getElementById("content").innerHTML="Chauffeur introuvable.";
return;
}

const d = snap.data();

/* COLIS LIVRÉS */
const shipmentsSnap = await getDocs(query(
collection(db,"shipments"),
where("assignedDriverId","==",driverId),
where("status","==","delivered")
));

let totalDelivered = shipmentsSnap.size;

document.getElementById("content").innerHTML = `
<div class="card">
<h3>Informations</h3>
<div class="meta">
<b>Nom:</b> ${d.fullName || d.name || ""}<br>
<b>Email:</b> ${d.email || ""}<br>
<b>Téléphone:</b> ${d.phone || ""}<br>
<b>Province:</b> ${d.province || "—"}<br>
<b>Quartiers:</b> ${(d.quartiers||[]).join(", ") || "—"}<br>
<b>Colis livrés:</b> ${totalDelivered}
</div>
</div>

<div class="card">
<h3>Documents</h3>

<label>Permis de conduire</label>
<input type="file" id="licenceFile">
<button class="upload-btn" onclick="uploadDoc('licence')">Uploader</button>
<a class="link" id="licenceLink"></a>

<label style="margin-top:20px">Carte identité</label>
<input type="file" id="idFile">
<button class="upload-btn" onclick="uploadDoc('idcard')">Uploader</button>
<a class="link" id="idcardLink"></a>

<label style="margin-top:20px">Facture / Contrat</label>
<input type="file" id="contractFile">
<button class="upload-btn" onclick="uploadDoc('contract')">Uploader</button>
<a class="link" id="contractLink"></a>

</div>
`;
}

window.uploadDoc = async function(type){
let fileInput;

if(type==="licence") fileInput=document.getElementById("licenceFile");
if(type==="idcard") fileInput=document.getElementById("idFile");
if(type==="contract") fileInput=document.getElementById("contractFile");

if(!fileInput.files[0]){ alert("Sélectionner un fichier"); return; }

const file = fileInput.files[0];
const storageRef = ref(storage, `driverDocuments/${driverId}/${type}_${Date.now()}`);
await uploadBytes(storageRef, file);
const url = await getDownloadURL(storageRef);

document.getElementById(type+"Link").innerText="Voir document";
document.getElementById(type+"Link").href=url;
document.getElementById(type+"Link").target="_blank";

alert("Document uploadé avec succès");
};
</script>

</body>
</html>
