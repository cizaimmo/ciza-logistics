<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="#000000">

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<title>Ciza Driver</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
:root{
  --gold:#D4AF37;
  --gold-soft:#f6edd2;
  --black:#0b0b0b;
  --bg:#f7f7f7;
  --card:#ffffff;
  --muted:#6b7280;
  --ok:#1f8f3a;
  --warn:#ffb300;
  --bad:#c62828;
}

*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{
  margin:0;
  font-family:Inter;
  background:var(--bg);
  color:#111;
}

/* HEADER */
.header{
  background:linear-gradient(90deg,#000,#111);
  color:#fff;
  padding:16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;
  top:0;
  z-index:1000;
  border-bottom:3px solid var(--gold);
}

.brand{color:var(--gold);font-weight:900;}
.driverName{font-size:13px;color:#d1d5db;margin-top:6px;}

.header-right{
  display:flex;
  gap:14px;
  align-items:center;
  flex-wrap:wrap;
}

.icon-btn{
  background:#1a1a1a;
  border:1px solid rgba(255,255,255,0.1);
  color:#fff;
  width:42px;
  height:42px;
  border-radius:12px;
  font-size:18px;
  cursor:pointer;
}

.badge{
  padding:8px 14px;
  border-radius:999px;
  font-weight:800;
  font-size:12px;
  background:var(--ok);
  color:#fff;
}

.logout-btn{
  background:var(--gold);
  border:none;
  padding:10px 16px;
  border-radius:12px;
  font-weight:900;
  cursor:pointer;
}

/* LAYOUT */
.container{width:95%;max-width:1200px;margin:20px auto;}
.card{
  background:var(--card);
  border-radius:14px;
  padding:18px;
  border:1px solid rgba(0,0,0,0.06);
  margin-bottom:18px;
}

.section-title{font-weight:900;margin-bottom:14px;}
.small{font-size:12px;color:var(--muted);}

/* SHIPMENT */
.shipment-card{
  border:1px solid rgba(0,0,0,0.08);
  border-left:5px solid var(--gold);
  border-radius:12px;
  padding:16px;
  margin-bottom:14px;
  background:#fff;
}

.shipment-card.active{
  background:var(--gold-soft);
  border-left:5px solid #000;
}

.actionsRow{display:flex;gap:14px;flex-wrap:wrap;margin-top:12px;}

.btn{
  border:none;
  border-radius:12px;
  padding:14px 16px;
  font-weight:900;
  cursor:pointer;
  min-height:48px;
}

.btn.dark{background:#000;color:#fff;}
.btn.gold{background:var(--gold);color:#000;}
.btn.red{background:var(--bad);color:#fff;}
.btn.full{width:100%;}

#map{height:300px;border-radius:14px;margin-top:14px;}
</style>
</head>

<body>

<div class="header">
  <div>
    <div class="brand">üöö Ciza Driver</div>
    <div class="driverName" id="driverName">Chargement...</div>
  </div>
  <div class="header-right">
    <button class="icon-btn" id="notifyBtn">üîî</button>
    <button class="icon-btn" id="navBtn">üß≠</button>
    <span class="badge" id="connectionStatus">En ligne</span>
    <span class="badge" id="gpsStatus">GPS OK</span>
    <span class="badge" id="deliveryCounter">0</span>
    <button class="logout-btn" id="logoutBtn">üö™ D√©connexion</button>
  </div>
</div>

<div class="container">

<div class="card">
  <div class="section-title">üü° √Ä traiter</div>
  <div id="assignedList"></div>
</div>

<div class="card">
  <div class="section-title">üü¢ Livr√©s</div>
  <div id="deliveredList"></div>
</div>

<div class="card">
  <div class="section-title">üì¶ D√©tails & Navigation</div>
  <div id="map"></div>
</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, collection, query, where, onSnapshot,
  doc, getDoc, getDocs, updateDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
  authDomain:"ciza-logistics.firebaseapp.com",
  projectId:"ciza-logistics"
});

const db=getFirestore(app);
const auth=getAuth(app);

let currentUser=null;
let selectedShipmentId=null;
let selectedShipment=null;

let map=L.map('map').setView([-3.3731,29.9189],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let driverMarker=null;
let destinationMarker=null;

onAuthStateChanged(auth,async(user)=>{
  if(!user){location.href="login.html";return;}
  currentUser=user;
  listenShipments();
});

document.getElementById("logoutBtn").onclick=async()=>{
  await signOut(auth);
  location.href="login.html";
};

function listenShipments(){
  const q=query(collection(db,"shipments"),
  where("assignedDriverId","==",currentUser.uid));

  onSnapshot(q,(snap)=>{
    let assigned=[];
    let delivered=[];

    snap.forEach(docSnap=>{
      const d=docSnap.data();
      d.id=docSnap.id;
      if(d.archivedByDriver) return;
      if(d.status==="assigned") assigned.push(d);
      if(d.status==="delivered") delivered.push(d);
    });

    renderList("assignedList",assigned);
    renderList("deliveredList",delivered);
    document.getElementById("deliveryCounter").textContent=delivered.length;
  });
}

function renderList(id,list){
  const el=document.getElementById(id);
  if(!list.length){el.innerHTML="<div class='small'>Aucun colis.</div>";return;}
  el.innerHTML=list.map(d=>renderCard(d)).join("");
}

function renderCard(d){
  const activeClass=selectedShipmentId===d.id?"active":"";
  return `
  <div class="shipment-card ${activeClass}">
    <div><b>${d.trackingCode||d.id}</b></div>
    <div class="small">üìç ${d.fromCity||""} ‚Üí ${d.toCity||""}</div>
    <div class="actionsRow">
      <button class="btn dark" onclick="selectShipment('${d.id}')">Voir</button>
      ${d.status==="assigned"?`<button class="btn gold full" onclick="confirmPickup('${d.id}')">Confirmer prise en charge</button>`:""}
      ${d.status==="delivered"?`<button class="btn red full" onclick="archiveShipment('${d.id}')">üóÇ Archiver</button>`:""}
    </div>
  </div>`;
}

window.selectShipment=async function(id){
  const snap=await getDoc(doc(db,"shipments",id));
  if(!snap.exists())return;
  selectedShipmentId=id;
  selectedShipment=snap.data();
  renderAfterSelect();

  if(selectedShipment.toLat){
    if(destinationMarker){
      destinationMarker.setLatLng([selectedShipment.toLat,selectedShipment.toLng]);
    }else{
      destinationMarker=L.marker([selectedShipment.toLat,selectedShipment.toLng]).addTo(map);
    }
  }
};

function renderAfterSelect(){
  document.querySelectorAll(".shipment-card")
    .forEach(c=>c.classList.remove("active"));
  setTimeout(()=>{
    document.querySelectorAll(".shipment-card")
    .forEach(c=>{
      if(c.innerHTML.includes(selectedShipmentId))
        c.classList.add("active");
    });
  },50);
}

window.confirmPickup=async function(id){
  await updateDoc(doc(db,"shipments",id),{
    status:"picked_up",
    pickedUpAt:serverTimestamp()
  });
};

window.archiveShipment=async function(id){
  await updateDoc(doc(db,"shipments",id),{
    archivedByDriver:true,
    archivedAt:serverTimestamp()
  });
};

document.getElementById("navBtn").onclick=()=>{
  if(!selectedShipment)return alert("S√©lectionne un colis");
  window.open(`https://www.google.com/maps/dir/?api=1&destination=${selectedShipment.toLat},${selectedShipment.toLng}`,"_blank");
};

document.getElementById("notifyBtn").onclick=()=>{
  document.getElementById("assignedList").scrollIntoView({behavior:"smooth"});
};

navigator.geolocation.watchPosition(pos=>{
  const lat=pos.coords.latitude;
  const lng=pos.coords.longitude;
  if(driverMarker){
    driverMarker.setLatLng([lat,lng]);
  }else{
    driverMarker=L.marker([lat,lng]).addTo(map);
    map.setView([lat,lng],13);
  }
});

</script>
</body>
</html>
