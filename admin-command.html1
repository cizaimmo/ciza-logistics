<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Command Center | Ciza Logistics</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<style>
:root{
--gold:#D4AF37;
--bg:#0a0c10;
--card:#111418;
--green:#1dd75b;
--yellow:#ffc107;
--red:#ff3b3b;
--gray:#888;
}

*{margin:0;padding:0;box-sizing:border-box;font-family:Inter,Arial}
body{background:var(--bg);color:#fff;overflow:hidden}

/* ENTRY SCREEN */
.entry{
position:absolute;
inset:0;
display:flex;
flex-direction:column;
align-items:center;
justify-content:center;
background:#000;
z-index:999;
}
.entry h1{
color:var(--gold);
font-size:28px;
margin-bottom:25px;
font-weight:900;
}
.entry button{
padding:15px 30px;
background:var(--gold);
border:none;
border-radius:12px;
font-weight:900;
cursor:pointer;
font-size:14px;
}

/* KPI BAR */
.kpi-bar{
position:absolute;
top:0;
left:0;
right:0;
height:70px;
background:rgba(0,0,0,0.85);
display:flex;
align-items:center;
justify-content:space-around;
z-index:500;
font-weight:800;
font-size:13px;
backdrop-filter:blur(6px);
}
.kpi-bar span{margin:0 10px}
.kpi-green{color:var(--green)}
.kpi-yellow{color:var(--yellow)}
.kpi-red{color:var(--red)}
.kpi-gray{color:var(--gray)}
.kpi-gold{color:var(--gold)}

/* MAP */
#map{
position:absolute;
top:70px;
bottom:0;
left:0;
right:0;
}

/* ALERT */
.alert-panel{
position:absolute;
bottom:20px;
left:20px;
background:var(--red);
padding:15px 20px;
border-radius:12px;
display:none;
z-index:600;
font-weight:800;
}

/* DRIVER PANEL */
.driver-panel{
position:absolute;
right:-400px;
top:70px;
width:380px;
bottom:0;
background:var(--card);
padding:20px;
transition:0.4s;
z-index:700;
overflow:auto;
}
.driver-panel.active{
right:0;
}
.driver-panel h3{
color:var(--gold);
margin-bottom:15px;
}
.driver-panel p{
font-size:13px;
margin-bottom:10px;
}
.driver-panel button{
margin-top:10px;
padding:10px;
background:var(--gold);
border:none;
border-radius:10px;
font-weight:900;
cursor:pointer;
width:100%;
}
</style>
</head>
<body>

<div class="entry" id="entryScreen">
<h1>üõ∞Ô∏è Command Center</h1>
<button onclick="enterCommandCenter()">Entrer en mode Command Center</button>
</div>

<div class="kpi-bar" id="kpiBar" style="display:none">
<span class="kpi-green">Transit: <b id="kpiTransit">0</b></span>
<span class="kpi-yellow">Assign√©s: <b id="kpiAssigned">0</b></span>
<span class="kpi-red">Incidents: <b id="kpiIncident">0</b></span>
<span class="kpi-gray">Offline: <b id="kpiOffline">0</b></span>
<span class="kpi-gold">Actifs: <b id="kpiActive">0</b></span>
<span class="kpi-gold" id="kpiZone">Zone: ‚Äî</span>
<span id="clock"></span>
</div>

<div id="map"></div>
<div class="alert-panel" id="alertPanel"></div>

<div class="driver-panel" id="driverPanel">
<h3 id="driverName">Chauffeur</h3>
<p id="driverInfo"></p>
<button onclick="closePanel()">Fermer</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const app = initializeApp({
apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
authDomain:"ciza-logistics.firebaseapp.com",
projectId:"ciza-logistics"
});
const db = getFirestore(app);
const auth = getAuth(app);

let map, markers, activeDrivers={};

function enterCommandCenter(){
document.getElementById("entryScreen").style.display="none";
document.getElementById("kpiBar").style.display="flex";

document.documentElement.requestFullscreen();

initMap();
listenDrivers();
startClock();
}

function initMap(){
map = L.map('map',{zoomControl:false}).setView([-3.382,29.364],8);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
maxZoom:19
}).addTo(map);

markers = L.markerClusterGroup();
map.addLayer(markers);
}

function listenDrivers(){
onSnapshot(collection(db,"driversLive"), snap=>{
markers.clearLayers();

let transit=0,assigned=0,incident=0,offline=0;
let active=0;
let provinces={};

snap.forEach(doc=>{
const d=doc.data();
if(!d.lat||!d.lng) return;

activeDrivers[doc.id]=d;

if(d.status==="in_transit") transit++;
if(d.status==="assigned") assigned++;
if(d.status==="incident") incident++;
if(d.status==="offline") offline++;

if(d.status!=="offline") active++;

if(d.province){
provinces[d.province]=(provinces[d.province]||0)+1;
}

const marker=L.marker([d.lat,d.lng]).on("click",()=>showDriver(doc.id));
markers.addLayer(marker);
});

document.getElementById("kpiTransit").innerText=transit;
document.getElementById("kpiAssigned").innerText=assigned;
document.getElementById("kpiIncident").innerText=incident;
document.getElementById("kpiOffline").innerText=offline;
document.getElementById("kpiActive").innerText=active;

let topProvince="‚Äî";
let max=0;
for(const p in provinces){
if(provinces[p]>max){
max=provinces[p];
topProvince=p;
}
}
document.getElementById("kpiZone").innerText="Zone: "+topProvince;

fitToActive();

checkAlerts();
});
}

function fitToActive(){
const group=[];
for(const id in activeDrivers){
const d=activeDrivers[id];
if(d.status!=="offline") group.push([d.lat,d.lng]);
}
if(group.length>0){
map.fitBounds(group,{padding:[50,50],maxZoom:14});
}
}

function checkAlerts(){
let alert="";
const now=Date.now();

for(const id in activeDrivers){
const d=activeDrivers[id];
if(d.lastUpdate){
const last=d.lastUpdate.seconds*1000;
if(now-last>120000){
alert="‚ö†Ô∏è Chauffeur sans mise √† jour > 2 min";
}
}
if(d.status==="incident"){
alert="üö® Incident actif d√©tect√©";
}
}

if(alert){
document.getElementById("alertPanel").innerText=alert;
document.getElementById("alertPanel").style.display="block";
}else{
document.getElementById("alertPanel").style.display="none";
}
}

function showDriver(id){
const d=activeDrivers[id];
document.getElementById("driverName").innerText=d.fullName||"Chauffeur";
document.getElementById("driverInfo").innerHTML=
`T√©l√©phone: ${d.phone||""}<br>
Tracking: ${d.activeTracking||""}<br>
Province: ${d.province||""}<br>
Quartier: ${d.quartier||""}<br>
Vitesse: ${d.speed||0} km/h`;

document.getElementById("driverPanel").classList.add("active");
}

window.closePanel=function(){
document.getElementById("driverPanel").classList.remove("active");
}

function startClock(){
setInterval(()=>{
document.getElementById("clock").innerText=new Date().toLocaleTimeString("fr-FR");
},1000);
}

onAuthStateChanged(auth,user=>{
if(!user) location.href="../login.html";
});
</script>
</body>
</html>
