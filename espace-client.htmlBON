<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ciza Logistics | Espace Client</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

<style>
:root{
--gold:#D4AF37;
--black:#0b0b0c;
--soft:#121214;
--border:rgba(212,175,55,0.25);
--muted:#9a9aa3;
}

*{box-sizing:border-box;margin:0;padding:0}
body{
background:var(--black);
font-family:Inter;
color:#fff;
}

.header{
display:flex;
justify-content:space-between;
align-items:center;
padding:20px;
border-bottom:1px solid var(--border);
}

.header h1{
color:var(--gold);
font-size:18px;
}

.logout{
background:transparent;
border:1px solid var(--border);
color:var(--gold);
padding:8px 14px;
border-radius:12px;
cursor:pointer;
font-weight:900;
}

.container{
width:95%;
max-width:1100px;
margin:30px auto;
}

.kpi-row{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
gap:14px;
margin-bottom:25px;
}

.kpi{
background:var(--soft);
border:1px solid var(--border);
padding:18px;
border-radius:18px;
text-align:center;
}

.kpi b{
color:var(--gold);
font-size:20px;
display:block;
margin-bottom:5px;
}

.tabs{
display:flex;
gap:10px;
margin-bottom:20px;
flex-wrap:wrap;
}

.tab{
padding:10px 18px;
border-radius:999px;
border:1px solid var(--border);
cursor:pointer;
font-weight:800;
font-size:13px;
}

.tab.active{
background:var(--gold);
color:#000;
}

.card{
background:var(--soft);
border:1px solid var(--border);
border-radius:22px;
padding:20px;
margin-bottom:18px;
transition:0.2s;
}

.card:hover{
transform:translateY(-2px);
}

.badge{
display:inline-block;
padding:6px 12px;
border-radius:999px;
font-size:11px;
font-weight:900;
margin-top:6px;
}

.created{background:#636e72;}
.assigned{background:#0984e3;}
.in_transit{background:#6c5ce7;}
.delivered{background:#00b894;}

.price{
color:var(--gold);
font-weight:900;
margin-top:10px;
}

.timeline{
display:flex;
gap:8px;
margin-top:12px;
flex-wrap:wrap;
font-size:11px;
}

.step{
padding:6px 10px;
border-radius:12px;
border:1px solid rgba(255,255,255,0.1);
opacity:0.4;
}

.step.active{
background:var(--gold);
color:#000;
opacity:1;
}

.driver-box{
margin-top:15px;
padding:12px;
background:rgba(255,255,255,0.04);
border-radius:16px;
font-size:13px;
}

.driver-box b{
color:var(--gold);
}

.otp-box{
margin-top:12px;
background:rgba(212,175,55,0.15);
border:1px solid var(--gold);
padding:14px;
border-radius:16px;
text-align:center;
}

.otp-code{
font-size:22px;
font-weight:900;
letter-spacing:3px;
color:var(--gold);
}

.proof{
margin-top:12px;
font-size:13px;
}

.proof img{
max-width:100%;
border-radius:12px;
margin-top:6px;
}

button.call{
margin-top:8px;
padding:6px 12px;
border-radius:12px;
background:var(--gold);
border:none;
font-weight:900;
cursor:pointer;
}
</style>
</head>
<body>

<div class="header">
<h1>Espace Client</h1>
<button class="logout" id="logoutBtn">D√©connexion</button>
</div>

<div class="container">

<div class="kpi-row">
<div class="kpi"><b id="kpiActive">0</b>Actifs</div>
<div class="kpi"><b id="kpiTransit">0</b>En transit</div>
<div class="kpi"><b id="kpiDelivered">0</b>Livr√©s</div>
<div class="kpi"><b id="kpiTotalSpent">0</b>Total d√©pens√©</div>
</div>

<div class="tabs">
<div class="tab active" data-tab="active">Actifs</div>
<div class="tab" data-tab="delivered">Livr√©s</div>
<div class="tab" data-tab="all">Tous</div>
</div>

<div id="list"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig={
apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
authDomain:"ciza-logistics.firebaseapp.com",
projectId:"ciza-logistics"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth(app);

const list=document.getElementById("list");
const tabs=document.querySelectorAll(".tab");

let currentTab="active";
let allShipments=[];

tabs.forEach(tab=>{
tab.onclick=()=>{
tabs.forEach(t=>t.classList.remove("active"));
tab.classList.add("active");
currentTab=tab.dataset.tab;
render();
};
});

document.getElementById("logoutBtn").onclick=async()=>{
await signOut(auth);
location.href="login.html";
};

onAuthStateChanged(auth,user=>{
if(!user){location.href="login.html";return;}

const q=query(collection(db,"shipments"),where("ownerUid","==",user.uid));

onSnapshot(q,snap=>{
allShipments=[];
snap.forEach(doc=>allShipments.push({id:doc.id,...doc.data()}));
updateKPIs();
render();
});
});

function updateKPIs(){
let active=0, transit=0, delivered=0, total=0;

allShipments.forEach(d=>{
if(d.status!=="delivered") active++;
if(d.status==="in_transit") transit++;
if(d.status==="delivered") delivered++;
total+=Number(d.finalPrice||0);
});

document.getElementById("kpiActive").innerText=active;
document.getElementById("kpiTransit").innerText=transit;
document.getElementById("kpiDelivered").innerText=delivered;
document.getElementById("kpiTotalSpent").innerText=total.toLocaleString("fr-FR")+" BIF";
}

function render(){
list.innerHTML="";

let filtered=allShipments.filter(d=>{
if(currentTab==="active") return d.status!=="delivered";
if(currentTab==="delivered") return d.status==="delivered";
return true;
});

filtered.forEach(d=>{
list.innerHTML+=createCard(d);
});
}

function createCard(d){
let timeline=`
<div class="timeline">
<div class="step ${d.status==="created"||d.status==="assigned"||d.status==="in_transit"||d.status==="delivered"?"active":""}">Cr√©√©</div>
<div class="step ${d.status==="assigned"||d.status==="in_transit"||d.status==="delivered"?"active":""}">Assign√©</div>
<div class="step ${d.status==="in_transit"||d.status==="delivered"?"active":""}">Transit</div>
<div class="step ${d.status==="delivered"?"active":""}">Livr√©</div>
</div>
`;

let driverSection="";
if(d.driverName){
driverSection=`
<div class="driver-box">
<b>Chauffeur:</b> ${d.driverName}<br>
${d.driverPlate?"üöó "+d.driverPlate+"<br>":""}
${d.driverRating?"‚≠ê "+d.driverRating+"<br>":""}
${d.driverPhone?`<button class="call" onclick="window.location='tel:${d.driverPhone}'">Appeler</button>`:""}
</div>
`;
}

let etaSection="";
if(d.status==="in_transit"){
if(d.distanceMeters<=100){
etaSection="üü¢ Chauffeur arriv√© √† destination";
}
else if(d.distanceMeters<=500){
etaSection="üü° Chauffeur √† proximit√©";
}
else if(d.etaMinutes){
etaSection="üöó Arriv√©e estim√©e : "+d.etaMinutes+" min";
}
else{
etaSection="üöó En route";
}
}

let otpSection="";
if(d.deliveryOTP && d.status==="in_transit"){
otpSection=`
<div class="otp-box">
Code de r√©ception
<div class="otp-code">${d.deliveryOTP}</div>
</div>
`;
}

let proofSection="";
if(d.status==="delivered"){
proofSection=`
<div class="proof">
${d.deliveryPhoto?`<img src="${d.deliveryPhoto}">`:""}
${d.signatureUrl?`<img src="${d.signatureUrl}">`:""}
</div>
`;
}

return `
<div class="card">
<b>${d.trackingCode||d.id}</b>
<div class="badge ${d.status||"created"}">${(d.status||"created").toUpperCase()}</div>
<div class="price">${(Number(d.finalPrice||0)).toLocaleString("fr-FR")} BIF</div>
${timeline}
${driverSection}
${etaSection}
${otpSection}
${proofSection}
</div>
`;
}
</script>
</body>
</html>
