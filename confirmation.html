<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Confirmation de paiement | Ciza Logistics</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:Arial,Helvetica,sans-serif;background:#f5f7fa;color:#111;}
.container{width:92%;max-width:1100px;margin:auto;}
html{scroll-behavior:smooth;}

.main-header{position:fixed;width:100%;background:#000;padding:22px 0;z-index:1000;}
.header-container{display:flex;justify-content:space-between;align-items:center;}
.logo img{height:95px;}
.nav-menu{display:flex;gap:22px;align-items:center;}
.nav-menu a{color:#fff;text-decoration:none;text-transform:uppercase;font-size:13px;letter-spacing:1px;}
.nav-menu a:hover{color:#D4AF37;}

.hero{padding-top:170px;padding-bottom:40px;text-align:center;}
.hero h1{font-size:26px;}

.confirm-card{
background:#fff;border-radius:28px;padding:50px;
box-shadow:0 30px 90px rgba(0,0,0,0.08);
border:1px solid rgba(212,175,55,0.2);
margin-bottom:50px;text-align:center;
}

.tracking-code{font-size:20px;font-weight:900;color:#D4AF37;margin-bottom:10px;}
.status-badge{display:inline-block;padding:8px 18px;border-radius:999px;background:#000;color:#fff;font-size:12px;margin-bottom:20px;}
.amount{font-size:24px;font-weight:900;margin-bottom:25px;}

.pay-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin:30px 0;}
.pay-card{
background:#fff;border:1px solid rgba(212,175,55,0.3);
padding:25px;border-radius:20px;cursor:pointer;
transition:0.3s;text-align:center;
}
.pay-card.active{border:2px solid #D4AF37;background:#000;color:#D4AF37;}
.pay-card:hover{transform:translateY(-5px);box-shadow:0 10px 30px rgba(0,0,0,0.1);}
.copy-btn{margin-top:8px;background:#D4AF37;border:none;padding:6px 12px;border-radius:12px;font-weight:700;cursor:pointer;}

input{width:100%;padding:12px;border-radius:12px;border:1px solid #ccc;margin:10px 0;}
.btn-primary{display:inline-block;padding:14px 25px;border-radius:18px;background:#D4AF37;color:#000;font-weight:900;border:none;cursor:pointer;}
.btn-primary:disabled{opacity:0.5;cursor:not-allowed;}

.timeline{display:flex;justify-content:space-between;margin-top:40px;font-size:12px;}
.timeline div{flex:1;text-align:center;padding:8px;}
.timeline .active{color:#D4AF37;font-weight:900;}

.footer{background:#000;color:#fff;padding:50px 0;text-align:center;margin-top:60px;}
.countdown{margin-top:15px;font-size:14px;color:#555;}
</style>
</head>

<body>

<header class="main-header">
<div class="container header-container">
<div class="logo">
<img src="https://raw.githubusercontent.com/cizaimmo/ciza-logistics/4b1ea6a2d3697e3982880984ee31dca42d8c52fc/logo.png">
</div>
<nav class="nav-menu">
<a href="index.html">Accueil</a>
<a href="parcel.html">Créer un envoi</a>
<a href="tracking.html">Suivi</a>
<a href="enterprise.html">Entreprise</a>
</nav>
</div>
</header>

<section class="hero">
<div class="container">
<h1>Finalisez votre paiement Mobile Money</h1>
</div>
</section>

<section>
<div class="container">
<div class="confirm-card">

<div class="tracking-code" id="trackingCode">Tracking : ...</div>
<div class="status-badge" id="statusBadge">En attente de paiement</div>
<div class="amount" id="amountBox">Montant : ...</div>

<div class="countdown" id="countdown"></div>

<div class="pay-grid">
<div class="pay-card" data-method="EcoCash" onclick="selectMethod('EcoCash')">
EcoCash<br>+25779945005<br>
<button class="copy-btn" onclick="copyNumber(event,'+25779945005')">Copier</button>
</div>

<div class="pay-card" data-method="Lumicash" onclick="selectMethod('Lumicash')">
Lumicash<br>+25776007985<br>
<button class="copy-btn" onclick="copyNumber(event,'+25776007985')">Copier</button>
</div>

<div class="pay-card" data-method="eNoti" onclick="selectMethod('eNoti')">
eNoti<br>+25775890558<br>
<button class="copy-btn" onclick="copyNumber(event,'+25775890558')">Copier</button>
</div>
</div>

<input type="text" id="paymentReference" placeholder="Référence de transaction">
<input type="text" id="paymentPhone" placeholder="Numéro utilisé pour paiement">

<button class="btn-primary" id="submitBtn" onclick="submitPayment()">Envoyer la référence</button>

<div id="barcodeContainer" style="margin-top:30px;"></div>
<div id="qrcode" style="margin-top:20px;"></div>

<div class="timeline">
<div id="step1">Créé</div>
<div id="step2">Paiement</div>
<div id="step3">Validation</div>
<div id="step4">Ramassage</div>
<div id="step5">Livraison</div>
</div>

</div>
</div>
</section>

<footer class="footer">
© 2026 Ciza Logistics | Division de Ciza Group
</footer>

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
authDomain:"ciza-logistics.firebaseapp.com",
projectId:"ciza-logistics"
});
const db = getFirestore(app);

const params = new URLSearchParams(window.location.search);
const tracking = params.get("tracking");

let selectedMethod = null;

window.selectMethod = function(method){
document.querySelectorAll(".pay-card").forEach(c=>c.classList.remove("active"));
document.querySelector(`[data-method="${method}"]`).classList.add("active");
selectedMethod = method;
};

window.copyNumber = function(e,number){
e.stopPropagation();
navigator.clipboard.writeText(number);
e.target.innerText="Copié ✓";
setTimeout(()=>e.target.innerText="Copier",1500);
};

if(tracking){
const snap = await getDoc(doc(db,"shipments",tracking));
if(snap.exists()){
const data = snap.data();

document.getElementById("trackingCode").innerText="Tracking : "+tracking;
document.getElementById("amountBox").innerText="Montant : "+(data.finalPrice||0).toLocaleString("fr-FR")+" BIF";

updateTimeline(data.status);

if(data.paymentStatus==="pending_verification"){
disableForm();
}

generateCodes(tracking);
startCountdown(data.referenceSubmittedAt);
}
}

function updateTimeline(status){
const map={
created:"step1",
payment_under_review:"step2",
paid:"step3",
ready_for_dispatch:"step4",
delivered:"step5"
};
if(map[status]) document.getElementById(map[status]).classList.add("active");
}

function disableForm(){
document.getElementById("submitBtn").disabled=true;
document.getElementById("paymentReference").disabled=true;
document.getElementById("paymentPhone").disabled=true;
}

window.submitPayment = async function(){
if(!selectedMethod){alert("Sélectionnez un opérateur.");return;}
const ref=document.getElementById("paymentReference").value.trim();
const phone=document.getElementById("paymentPhone").value.trim();
if(!ref||!phone){alert("Entrez référence et numéro.");return;}

await updateDoc(doc(db,"shipments",tracking),{
status:"payment_under_review",
paymentStatus:"pending_verification",
paymentMethodSelected:selectedMethod,
paymentReference:ref,
paymentPhone:phone,
referenceSubmittedAt:serverTimestamp()
});

disableForm();
alert("Référence envoyée. En attente validation.");
};

function generateCodes(tracking){
new QRCode(document.getElementById("qrcode"),{
text:location.origin+"/tracking.html?code="+tracking,
width:140,height:140
});
const svg=document.createElement("svg");
document.getElementById("barcodeContainer").appendChild(svg);
JsBarcode(svg,tracking,{format:"CODE128",width:2,height:60});
}

function startCountdown(timestamp){
if(!timestamp)return;
const end=new Date(timestamp.seconds*1000+30*60*1000);
const el=document.getElementById("countdown");
const interval=setInterval(()=>{
const now=new Date();
const diff=end-now;
if(diff<=0){clearInterval(interval);el.innerText="Validation en cours...";return;}
const m=Math.floor(diff/60000);
const s=Math.floor((diff%60000)/1000);
el.innerText="⏱ Validation estimée : "+m+":"+String(s).padStart(2,"0");
},1000);
}
</script>

</body>
</html>
