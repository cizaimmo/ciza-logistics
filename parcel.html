<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ciza Parcel | Livraison Nationale</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
:root{
--gold:#D4AF37;
--black:#0b0b0c;
--softBlack:#121214;
--muted:#9a9aa3;
--border:rgba(212,175,55,0.25);
--radius:22px;
--field:#101012;
--danger:#ff6b6b;
--ok:#1dd1a1;
--white:#ffffff;
}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{font-family:'Inter',sans-serif;background:var(--black);color:#fff;overflow-x:hidden}

/* TOPBAR */
.topbar{
background:#000;border-bottom:1px solid var(--border);
padding:9px 10px;text-align:center;color:var(--gold);
font-size:12px;font-weight:800;letter-spacing:.4px;
}

/* HEADER */
.main-header{
position:sticky;top:0;background:rgba(0,0,0,0.90);
backdrop-filter:blur(10px);border-bottom:1px solid var(--border);
z-index:1200;
}
.header-inner{
width:95%;max-width:1200px;margin:auto;display:flex;
align-items:center;justify-content:space-between;padding:14px 0;gap:12px;
}
.logo{display:flex;align-items:center;gap:12px}
.logo img{height:60px;filter:drop-shadow(0 0 12px rgba(212,175,55,0.28))}
.header-right{display:flex;align-items:center;gap:10px;}
.user-chip{
display:none;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;
border:1px solid rgba(212,175,55,0.20);background:rgba(255,255,255,0.04);
color:#fff;font-size:12px;white-space:nowrap;
}
.user-chip b{color:var(--gold)}
.nav-desktop{display:flex;gap:22px;align-items:center}
.nav-desktop a{
text-decoration:none;color:#fff;font-size:13px;font-weight:900;letter-spacing:.2px;
}
.nav-desktop a:hover{color:var(--gold)}
.btn-outline{border:1px solid var(--border);padding:8px 12px;border-radius:12px;color:var(--gold)!important}
.logout-btn{
background:transparent;border:1px solid var(--border);color:var(--gold);
padding:8px 14px;border-radius:12px;cursor:pointer;font-weight:900;
}
.logout-btn:hover{background:rgba(212,175,55,0.12)}

/* HAMBURGER */
.hamburger{
display:none;flex-direction:column;gap:4px;background:transparent;border:none;cursor:pointer;
width:44px;height:44px;border-radius:14px;border:1px solid rgba(255,255,255,0.12);
align-items:center;justify-content:center;
}
.hamburger span{width:20px;height:2px;background:var(--gold);display:block}

/* MOBILE MENU */
.mobile-menu{
position:fixed;top:0;right:-100%;width:280px;height:100%;
background:#0d0e10;border-left:1px solid var(--border);
padding:18px;display:flex;flex-direction:column;gap:10px;transition:.35s;z-index:2500;
}
.mm-top{
display:flex;align-items:center;justify-content:space-between;gap:10px;
padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,0.08);
}
.mm-title{color:var(--gold);font-weight:900;font-size:13px;letter-spacing:.6px}
.mm-close{
width:42px;height:42px;border-radius:14px;border:1px solid rgba(255,255,255,0.14);
background:transparent;color:#fff;font-size:22px;cursor:pointer;
}
.mm-user{
margin-top:8px;padding:12px;border-radius:18px;background:rgba(255,255,255,0.04);
border:1px solid rgba(212,175,55,0.18);font-size:12px;line-height:1.6;
}
.mm-user b{color:var(--gold)}
.mobile-menu a{
text-decoration:none;color:#fff;font-weight:900;padding:12px 14px;border-radius:16px;
background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);
text-transform:uppercase;font-size:12px;letter-spacing:.6px;
}
.mobile-menu a:hover{background:rgba(212,175,55,0.10);color:var(--gold)}
.mm-actions{
margin-top:auto;padding-top:12px;border-top:1px solid rgba(255,255,255,0.08);
display:flex;flex-direction:column;gap:10px;
}
.mm-foot{color:#8b8b8b;font-size:11px;text-align:center}
.menu-overlay{
position:fixed;inset:0;background:rgba(0,0,0,0.65);
opacity:0;pointer-events:none;transition:.25s;z-index:2400;
}
.menu-open .mobile-menu{right:0}
.menu-open .menu-overlay{opacity:1;pointer-events:auto}

/* HERO (IMAGE + OVERLAY) */
.hero{
position:relative;
padding:36px 0 18px;
border-bottom:1px solid var(--border);
text-align:center;
overflow:hidden;
}
.hero::before{
content:"";
position:absolute;inset:0;
background:
linear-gradient(180deg,rgba(11,11,12,0.70),rgba(11,11,12,0.95)),
url("https://raw.githubusercontent.com/cizaimmo/ciza-logistics/e3c40587e17d4f35695b7daf5fab9383dcd38bd1/ciza-percel.png");
background-size:cover;
background-position:center;
filter:saturate(1.05);
transform:scale(1.02);
}
.hero-inner{
position:relative;
width:95%;max-width:1100px;margin:auto;
}
.hero h1{color:var(--gold);font-size:28px;font-weight:900;letter-spacing:.2px}
.hero p{
margin:8px auto 0;max-width:860px;font-size:13px;line-height:1.6;
color:rgba(255,255,255,0.82);padding:0 6px;
}

/* PAGE */
.section{padding:22px 0 52px}
.container{width:95%;max-width:1100px;margin:auto}
.form-card{
background:rgba(255,255,255,0.03);
border:1px solid var(--border);
border-radius:var(--radius);
padding:18px;
box-shadow:0 30px 90px rgba(0,0,0,0.35);
}
@media(min-width:720px){.form-card{padding:26px}}
.block{margin-bottom:18px}
.block-title{
color:var(--gold);font-size:12px;margin-bottom:12px;font-weight:900;
text-transform:uppercase;letter-spacing:1px;
}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
.grid.two{grid-template-columns:1fr}
.grid.three{grid-template-columns:1fr}
@media(min-width:900px){
.grid.two{grid-template-columns:1fr 1fr}
.grid.three{grid-template-columns:1fr 1fr 1fr}
.nav-desktop{display:flex}
.hamburger{display:none}
.user-chip{display:flex}
}
@media(max-width:899px){
.nav-desktop{display:none}
.hamburger{display:flex}
.user-chip{display:none}
}

/* INPUTS */
label{
display:block;font-size:11px;margin:0 0 6px;color:#e7e7ea;
text-transform:uppercase;letter-spacing:.6px;font-weight:900;
}
input,select,textarea{
width:100%;
padding:14px 14px;
background:var(--field);
border:1px solid rgba(255,255,255,0.10);
border-radius:14px;
color:#fff;
outline:none;
transition:.2s;
}
textarea{min-height:92px;resize:none}
input:focus,select:focus,textarea:focus{
border-color:rgba(212,175,55,0.75);
box-shadow:0 0 0 2px rgba(212,175,55,0.14);
}
.small-note{font-size:12px;color:rgba(255,255,255,0.72);margin-top:6px;line-height:1.55}
.sep{
height:1px;background:linear-gradient(to right,rgba(212,175,55,0),rgba(212,175,55,0.35),rgba(212,175,55,0));
margin:14px 0;
}

/* CHECKBOX */
.checkbox-line{
display:flex;gap:10px;align-items:flex-start;padding:12px;border-radius:16px;
background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);
}
.checkbox-line input{width:18px;height:18px;margin-top:2px}
.checkbox-line span{font-size:13px;color:rgba(255,255,255,0.90);line-height:1.45}
.checkbox-line strong{color:var(--gold)}

/* SUMMARY */
.summary{
margin-top:10px;
background:rgba(212,175,55,0.10);
border:1px solid rgba(212,175,55,0.22);
color:#f6e7b5;
padding:12px 12px;
border-radius:14px;
font-size:13px;
line-height:1.6;
white-space:pre-line;
}

/* ACTIONS */
.actions{margin-top:14px;display:flex;flex-direction:column;gap:10px}
@media(min-width:720px){.actions{flex-direction:row}}
.primary-btn{
flex:1;padding:16px;background:var(--gold);border:none;border-radius:18px;
font-weight:900;color:#000;cursor:pointer;font-size:14px;
}
.primary-btn:active{transform:scale(.99)}
.secondary-btn{
flex:1;padding:16px;background:transparent;border:1px solid rgba(255,255,255,0.14);
border-radius:18px;font-weight:900;color:#fff;cursor:pointer;font-size:14px;
}
.secondary-btn:hover{border-color:rgba(212,175,55,0.35);color:var(--gold)}
.error{color:var(--danger);font-size:13px;margin-top:10px;font-weight:900}
.ok{color:var(--ok);font-size:13px;margin-top:10px;font-weight:900}

/* LOADER */
.loader{display:none;margin-top:10px;text-align:center;color:var(--gold);font-weight:900;font-size:13px}

/* FOOTER */
.footer{
border-top:1px solid var(--border);padding:26px 0;text-align:center;color:#bdbdbd;
font-size:11px;background:#000;
}
.footer b{color:var(--gold)}
</style>
</head>

<body>

<div class="topbar">Service 24/7 ‚Ä¢ Support WhatsApp +257 79 94 50 07</div>

<header class="main-header">
<div class="header-inner">
<div class="logo">
<img src="https://raw.githubusercontent.com/cizaimmo/ciza-logistics/4b1ea6a2d3697e3982880984ee31dca42d8c52fc/logo.png" alt="Ciza Logistics">
</div>

<nav class="nav-desktop">
<a href="index.html">Accueil</a>
<a href="parcel.html" class="btn-outline">Cr√©er envoi</a>
<a href="tracking.html">Suivi</a>
<a href="dashboard.html">Espace client</a>
</nav>

<div class="header-right">
<div class="user-chip"><span>Client :</span> <b id="clientName">‚Äî</b></div>
<button class="logout-btn" id="logoutBtn" style="display:none;">D√©connexion</button>
<button class="hamburger" id="hamburgerBtn" aria-label="Menu">
<span></span><span></span><span></span>
</button>
</div>

</div>
</header>

<div class="mobile-menu" id="mobileMenu">
<div class="mm-top">
<div class="mm-title">MENU</div>
<button class="mm-close" id="mmClose">√ó</button>
</div>

<div class="mm-user">
<div style="opacity:.85">Connect√© :</div>
<div style="margin-top:6px"><b id="mmClientName">‚Äî</b></div>
</div>

<a href="index.html">Accueil</a>
<a href="parcel.html">Cr√©er envoi</a>
<a href="tracking.html">Suivi</a>
<a href="dashboard.html">Espace client</a>

<div class="mm-actions">
<button class="logout-btn" id="logoutMobile" style="display:none;">D√©connexion</button>
<div class="mm-foot">¬© 2026 Ciza Logistics</div>
</div>
</div>
<div class="menu-overlay" id="menuOverlay"></div>

<section class="hero">
<div class="hero-inner">
<h1>Ciza Parcel</h1>
<p>Choisis le service, le formulaire s‚Äôadapte automatiquement (Food, Pharmacie, Business, Parcel). Localisation pr√©cise (Province + Quartier + Rep√®re) et tarification dynamique via Firestore.</p>
</div>
</section>

<section class="section">
<div class="container">
<div class="form-card">

<!-- SERVICE -->
<div class="block">
<div class="block-title">Service</div>
<div class="grid three">
<div>
<label for="country">Pays</label>
<select id="country">
<option value="BI">üáßüáÆ Burundi</option>
<option value="RW">üá∑üáº Rwanda</option>
</select>
</div>

<div>
<label for="service">Service</label>
<select id="service">
<option value="parcel">Parcel (Colis)</option>
<option value="food">Food (Livraison alimentaire)</option>
<option value="pharmacy">Pharmacie (Sant√©)</option>
<option value="business">Business (Commerce)</option>
<option value="documents">Documents (Express)</option>
</select>
</div>

<div>
<label for="priority">Priorit√©</label>
<select id="priority">
<option value="standard">Standard</option>
<option value="express">Express</option>
</select>
</div>
</div>

<div class="small-note" id="serviceHint">S√©lectionne un service : le type d‚Äôexp√©diteur et les marchandises s‚Äôadaptent.</div>
</div>

<div class="sep"></div>

<!-- PROFIL -->
<div class="block">
<div class="block-title">Profil d‚Äôexp√©dition</div>

<div class="grid three">
<div>
<label for="senderType">Type d‚Äôexp√©diteur</label>
<select id="senderType">
<option value="">S√©lectionner</option>
<option value="particulier">Particulier</option>
<option value="commerce">Commerce</option>
<option value="pharmacie">Pharmacie</option>
<option value="restaurant">Restaurant</option>
</select>
</div>

<div>
<label for="frequency">Fr√©quence</label>
<select id="frequency">
<option value="">S√©lectionner</option>
<option value="occasionnel">Occasionnel</option>
<option value="hebdomadaire">Hebdomadaire</option>
<option value="quotidien">Quotidien</option>
</select>
</div>

<div id="internalRefWrap" style="display:none;">
<label for="internalRef">R√©f√©rence interne</label>
<input id="internalRef" placeholder="Ex: FACT-2026-015">
</div>
</div>

<div id="sensitivityWrap" style="display:none;margin-top:12px;">
<label>Sensibilit√©</label>
<div class="grid three" style="gap:10px;">
<div class="checkbox-line" style="padding:10px;border-radius:14px;">
<input type="checkbox" id="sensFragile">
<span><strong>Fragile</strong></span>
</div>
<div class="checkbox-line" style="padding:10px;border-radius:14px;">
<input type="checkbox" id="sensTemp">
<span><strong>Temp√©rature</strong></span>
</div>
<div class="checkbox-line" style="padding:10px;border-radius:14px;">
<input type="checkbox" id="sensSensitive">
<span><strong>Sensible</strong></span>
</div>
</div>
</div>

</div>

<div class="sep"></div>

<!-- ROUTE -->
<div class="block">
<div class="block-title">Route & Localisation</div>

<div class="grid two" style="margin-top:4px;">
<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:18px;padding:14px;">
<div style="color:var(--gold);font-weight:900;font-size:12px;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">D√©part</div>
<label for="originProvince">Province / Ville</label>
<select id="originProvince"></select>

<label for="originQuartier" style="margin-top:10px;">Quartier</label>
<select id="originQuartier"><option value="">‚Äî</option></select>

<label for="originLandmark" style="margin-top:10px;">Rep√®re</label>
<input id="originLandmark" placeholder="Ex: station, √©cole, portail...">
</div>

<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:18px;padding:14px;">
<div style="color:var(--gold);font-weight:900;font-size:12px;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">Destination</div>
<label for="destProvince">Province / Ville</label>
<select id="destProvince"></select>

<label for="destQuartier" style="margin-top:10px;">Quartier</label>
<select id="destQuartier"><option value="">‚Äî</option></select>

<label for="destLandmark" style="margin-top:10px;">Rep√®re</label>
<input id="destLandmark" placeholder="Ex: march√©, avenue, maison...">
</div>
</div>

<div style="margin-top:18px;">
<label>S√©lectionnez point exact de d√©part</label>
<div id="pickupMap" style="height:200px;border-radius:16px;border:1px solid var(--border);"></div>
</div>

<div style="margin-top:18px;">
<label>S√©lectionnez point exact de destination</label>
<div id="destMap" style="height:200px;border-radius:16px;border:1px solid var(--border);"></div>
</div>
  
<div class="small-note">Si province = <b>Bujumbura</b>, la liste de <b>38 quartiers</b> s‚Äôaffiche (M d‚Äôabord, puis A-Z). Sinon : ‚Äú‚Äî‚Äù.</div>
</div>

<div class="sep"></div>

<!-- CONTACTS -->
<div class="block">
<div class="block-title">Contacts</div>

<div class="grid two">
<div>
<label for="senderName">Nom exp√©diteur</label>
<input id="senderName" placeholder="Nom / Boutique">
</div>

<div>
<label for="senderPhone">T√©l√©phone exp√©diteur</label>
<input id="senderPhone" inputmode="numeric" placeholder="+257XXXXXXXX" autocomplete="tel">
</div>

<div>
<label for="receiverName">Nom destinataire</label>
<input id="receiverName" placeholder="Nom / Boutique">
</div>

<div>
<label for="receiverPhone">T√©l√©phone destinataire</label>
<input id="receiverPhone" inputmode="numeric" placeholder="+257XXXXXXXX" autocomplete="tel">
</div>
</div>
</div>

<div class="sep"></div>

<!-- MARCHANDISE -->
<div class="block">
<div class="block-title" id="goodsTitle">Marchandise</div>

<div class="grid three">
<div>
<label for="goodsType" id="goodsTypeLabel">Type</label>
<select id="goodsType">
<option value="">S√©lectionner</option>
</select>
</div>

<div>
<label for="weightValue" id="weightLabel">Poids estim√© (kg)</label>
<input id="weightValue" type="number" inputmode="numeric" placeholder="Ex: 1.5">
<div class="small-note" id="dynamicHint">Champ requis.</div>
</div>

<div>
<label for="paymentMethod">Mode de paiement</label>
<select id="paymentMethod">
<option value="">S√©lectionner</option>
<option value="Lumicash">Lumicash</option>
<option value="EcoCash">EcoCash</option>
<option value="eNoti">eNoti</option>
<option value="COD">Paiement √† la livraison</option>
</select>
</div>
</div>

<div class="grid two" style="margin-top:12px;">
<div>
<label for="declaredValue">Valeur d√©clar√©e (assurance)</label>
<input id="declaredValue" type="number" inputmode="numeric" placeholder="Ex: 50000">
<div class="small-note">Veuillez d√©clarer la valeur de votre marchandise pour assurance en cas de perte/dommage.</div>
</div>

<div>
<label for="content">Description</label>
<input id="content" placeholder="Ex: m√©dicaments, repas, accessoires, documents...">
</div>
</div>

<div style="margin-top:12px;">
<label for="notes">Instructions (optionnel)</label>
<textarea id="notes" placeholder="Ex: appeler avant, fragile, r√©ception..."></textarea>
</div>

<div style="margin-top:12px;">
<div class="checkbox-line">
<input type="checkbox" id="nonDangerous">
<span><strong>Mati√®res non dangereuses</strong> : je confirme que cet envoi ne contient pas de produits interdits ou dangereux.</span>
</div>
</div>

<label style="margin-top:14px;">R√©sum√©</label>
<div class="summary" id="summaryText">Compl√®te le service, la route, les contacts et la marchandise‚Ä¶</div>

</div>

<div id="errorMsg" class="error"></div>
<div id="okMsg" class="ok" style="display:none;"></div>
<div class="loader" id="loader">Traitement en cours‚Ä¶</div>

<div class="actions">
<button class="primary-btn" id="submitBtn">Continuer vers confirmation</button>
<button class="secondary-btn" id="goTrackingBtn" type="button">Aller au suivi</button>
</div>

</div>
</div>
</section>

<footer class="footer">
<b>Ciza Logistics</b> ‚Ä¢ Division de Ciza Group ‚Äî ¬© 2026
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* ================= BASE PATH (ANTI-404 GitHub Pages) ================= */
const BASE_PATH = (() => {
try{
const parts = location.pathname.split("/").filter(Boolean);
if(location.hostname.endsWith("github.io") && parts.length>0) return "/" + parts[0];
return "";
}catch(e){return "";}
})();
function withBase(p){
if(!p) return (BASE_PATH||"") + "/";
if(p.startsWith("http://") || p.startsWith("https://")) return p;
if(p.startsWith("/")) return (BASE_PATH||"") + p;
return (BASE_PATH||"") + "/" + p;
}
function go(p){ location.href = withBase(p); }
function fixHref(a, p){ a.setAttribute("href", withBase(p)); }

/* ================= FIREBASE ================= */
const firebaseConfig = {
apiKey: "AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
authDomain: "ciza-logistics.firebaseapp.com",
projectId: "ciza-logistics",
storageBucket: "ciza-logistics.firebasestorage.app",
messagingSenderId: "751524585771",
appId: "1:751524585771:web:6720db623a0ef70f56e56e"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ================= FIX LINKS (ANTI-404) ================= */
document.querySelectorAll('a[href="index.html"]').forEach(a=>fixHref(a,"index.html"));
document.querySelectorAll('a[href="parcel.html"]').forEach(a=>fixHref(a,"parcel.html"));
document.querySelectorAll('a[href="tracking.html"]').forEach(a=>fixHref(a,"tracking.html"));
document.querySelectorAll('a[href="dashboard.html"]').forEach(a=>fixHref(a,"dashboard.html"));

/* ================= UI REFS ================= */
const hamburgerBtn=document.getElementById("hamburgerBtn");
const menuOverlay=document.getElementById("menuOverlay");
const mmClose=document.getElementById("mmClose");

const logoutBtn=document.getElementById("logoutBtn");
const logoutMobile=document.getElementById("logoutMobile");

const clientName=document.getElementById("clientName");
const mmClientName=document.getElementById("mmClientName");

const country=document.getElementById("country");
const service=document.getElementById("service");
const priority=document.getElementById("priority");
const serviceHint=document.getElementById("serviceHint");

const senderType=document.getElementById("senderType");
const frequency=document.getElementById("frequency");

const internalRefWrap=document.getElementById("internalRefWrap");
const internalRef=document.getElementById("internalRef");

const sensitivityWrap=document.getElementById("sensitivityWrap");
const sensFragile=document.getElementById("sensFragile");
const sensTemp=document.getElementById("sensTemp");
const sensSensitive=document.getElementById("sensSensitive");

const originProvince=document.getElementById("originProvince");
const destProvince=document.getElementById("destProvince");
const originQuartier=document.getElementById("originQuartier");
const destQuartier=document.getElementById("destQuartier");
const originLandmark=document.getElementById("originLandmark");
const destLandmark=document.getElementById("destLandmark");

const senderName=document.getElementById("senderName");
const senderPhone=document.getElementById("senderPhone");
const receiverName=document.getElementById("receiverName");
const receiverPhone=document.getElementById("receiverPhone");

const goodsTitle=document.getElementById("goodsTitle");
const goodsTypeLabel=document.getElementById("goodsTypeLabel");
const goodsType=document.getElementById("goodsType");
const weightLabel=document.getElementById("weightLabel");
const weightValue=document.getElementById("weightValue");
const dynamicHint=document.getElementById("dynamicHint");
const paymentMethod=document.getElementById("paymentMethod");
const declaredValue=document.getElementById("declaredValue");
const content=document.getElementById("content");
const notes=document.getElementById("notes");
const nonDangerous=document.getElementById("nonDangerous");

const summaryText=document.getElementById("summaryText");
const submitBtn=document.getElementById("submitBtn");
const goTrackingBtn=document.getElementById("goTrackingBtn");
const errorMsg=document.getElementById("errorMsg");
const okMsg=document.getElementById("okMsg");
const loader=document.getElementById("loader");

let currentUser=null;

/* ================= MENU ================= */
function openMenu(){document.body.classList.add("menu-open");}
function closeMenu(){document.body.classList.remove("menu-open");}
hamburgerBtn.addEventListener("click",()=>{document.body.classList.contains("menu-open")?closeMenu():openMenu();});
menuOverlay.addEventListener("click",closeMenu);
mmClose.addEventListener("click",closeMenu);

/* ================= AUTH GUARD (PRODUCTION) ================= */
async function ensureClientRole(user){
try{
const uSnap = await getDoc(doc(db,"users",user.uid));

if(!uSnap.exists()){
await signOut(auth);
location.replace(withBase("login.html"));
return false;
}

const u = uSnap.data() || {};

if(u.accountStatus==="suspended"){
await signOut(auth);
location.replace(withBase("login.html"));
return false;
}

if(u.role!=="client"){
await signOut(auth);
location.replace(withBase("login.html"));
return false;
}

const nm=(u.fullName || u.name || user.email || "Client");
clientName.innerText=nm;
mmClientName.innerText=nm;

logoutBtn.style.display="inline-block";
logoutMobile.style.display="inline-block";
document.querySelector(".user-chip").style.display="flex";

return true;

}catch(e){
await signOut(auth);
location.replace(withBase("login.html"));
return false;
}
}

onAuthStateChanged(auth, async (user)=>{
if(!user){location.replace(withBase("login.html"));return;}
currentUser=user;

const ok = await ensureClientRole(user);
if(!ok) return;

applyPhonePrefix(country.value);
loadProvinces();
applyServiceRules(true);
updateSummary();
});

logoutBtn.addEventListener("click",async()=>{
try{ await signOut(auth); }catch(e){}
location.replace(withBase("login.html"));
});
logoutMobile.addEventListener("click",async()=>{
try{ await signOut(auth); }catch(e){}
location.replace(withBase("login.html"));
});

/* ================= PHONE HELPERS ================= */
function enforceNumericPhone(input){
let v=input.value || "";
v=v.replace(/[^\d+]/g,"");
if(v.indexOf("+")>0){v=v.replace(/\+/g,"");}
input.value=v;
}
function applyPhonePrefix(cty){
const prefix = cty==="RW" ? "+250" : "+257";
if(senderPhone.value.trim()==="" || senderPhone.value.startsWith("+")) senderPhone.value=prefix;
if(receiverPhone.value.trim()==="" || receiverPhone.value.startsWith("+")) receiverPhone.value=prefix;
}
senderPhone.addEventListener("input",()=>enforceNumericPhone(senderPhone));
receiverPhone.addEventListener("input",()=>enforceNumericPhone(receiverPhone));

/* ================= PROVINCES + 38 QUARTIERS ================= */
const provincesBI=["Bujumbura","Bujumbura Rural","Gitega","Ngozi","Muyinga","Kayanza","Kirundo","Rutana","Ruyigi","Cankuzo","Makamba","Bururi","Mwaro","Muramvya","Bubanza","Cibitoke","Karusi","Rumonge"];
const provincesRW=["Kigali","Northern","Southern","Eastern","Western"];

const quartiersBuj38=[
"Musaga","Mutanga Nord","Mutanga Sud","Mutakura",
"Buyenzi","Bwiza","Buterere","Buterere II",
"Carama","Cibitoke","Gatumba","Gihosha","Jabe","Kajaga","Kamenge","Kamenge II",
"Kanyosha","Kanyosha II","Kanyosha III","Kanyosha IV",
"Kibenga","Kigobe","Kinama","Kinindo","Kinanira I","Kinanira II","Kiriri",
"Ngagara","Ngagara II","Ngagara III","Nyabugete","Nyakabiga","Rohero I","Rohero II","Rohero III",
"Ruziba","Rweza","Sororezo"
];

function sortMFirst(list){
const m=list.filter(x=>x.trim().toLowerCase().startsWith("m")).sort((a,b)=>a.localeCompare(b,"fr"));
const rest=list.filter(x=>!x.trim().toLowerCase().startsWith("m")).sort((a,b)=>a.localeCompare(b,"fr"));
return [...m,...rest];
}
function loadProvinces(){
const c = country.value;
const list = c==="RW" ? provincesRW : provincesBI;

originProvince.innerHTML=`<option value="">S√©lectionner</option>`;
destProvince.innerHTML=`<option value="">S√©lectionner</option>`;

list.slice().sort((a,b)=>a.localeCompare(b,"fr")).forEach(p=>{
originProvince.innerHTML+=`<option value="${p}">${p}</option>`;
destProvince.innerHTML+=`<option value="${p}">${p}</option>`;
});

originQuartier.innerHTML=`<option value="">‚Äî</option>`;
destQuartier.innerHTML=`<option value="">‚Äî</option>`;
}
function bindQuartiers(provEl, qEl){
qEl.innerHTML=`<option value="">‚Äî</option>`;
if(provEl.value==="Bujumbura"){
sortMFirst(quartiersBuj38).forEach(q=>{
qEl.innerHTML+=`<option value="${q}">${q}</option>`;
});
}else{
qEl.innerHTML=`<option value="‚Äî">‚Äî</option>`;
}
}

originProvince.addEventListener("change",()=>{bindQuartiers(originProvince,originQuartier);updateSummary();});
destProvince.addEventListener("change",()=>{bindQuartiers(destProvince,destQuartier);updateSummary();});
originQuartier.addEventListener("change",updateSummary);
destQuartier.addEventListener("change",updateSummary);
originLandmark.addEventListener("input",updateSummary);
destLandmark.addEventListener("input",updateSummary);

country.addEventListener("change",()=>{
applyPhonePrefix(country.value);
loadProvinces();
updateSummary();
});

/* ================= SERVICE -> FORM LOGIC ================= */
function setRequired(el, on){
if(on) el.setAttribute("required","required");
else el.removeAttribute("required");
}
function resetSensitivity(){
sensFragile.checked=false;
sensTemp.checked=false;
sensSensitive.checked=false;
}
const SERVICES = {
parcel:{
label:"Parcel (Colis)",
lockSender:false,
senderDefault:"",
showInternalRef:false,
internalRefRequired:false,
showSensitivity:false,
forcePriority:"",
goodsTitle:"Marchandise",
goodsTypeLabel:"Type",
goodsOptions:[
{v:"boite",t:"Bo√Æte / Carton"},
{v:"sac",t:"Sac"},
{v:"enveloppe",t:"Enveloppe"},
{v:"bidon",t:"Bidon / Liquide"}
],
weightMode:"weight"
},
food:{
label:"Food (Livraison alimentaire)",
lockSender:true,
senderDefault:"restaurant",
showInternalRef:false,
internalRefRequired:false,
showSensitivity:true,
forcePriority:"express",
goodsTitle:"Commande (Food)",
goodsTypeLabel:"Cat√©gorie",
goodsOptions:[
{v:"repas_chaud",t:"Repas chaud"},
{v:"repas_froid",t:"Repas froid"},
{v:"boissons",t:"Boissons"},
{v:"patisserie",t:"P√¢tisserie / G√¢teau"},
{v:"surgele",t:"Surgel√©"}
],
weightMode:"qty"
},
pharmacy:{
label:"Pharmacie (Sant√©)",
lockSender:true,
senderDefault:"pharmacie",
showInternalRef:true,
internalRefRequired:false,
showSensitivity:true,
forcePriority:"express",
goodsTitle:"Envoi (Pharmacie)",
goodsTypeLabel:"Cat√©gorie",
goodsOptions:[
{v:"medicaments",t:"M√©dicaments"},
{v:"ordonnance",t:"Ordonnance"},
{v:"materiel",t:"Mat√©riel m√©dical"},
{v:"parapharmacie",t:"Parapharmacie"}
],
weightMode:"weight"
},
business:{
label:"Business (Commerce)",
lockSender:true,
senderDefault:"commerce",
showInternalRef:true,
internalRefRequired:true,
showSensitivity:false,
forcePriority:"",
goodsTitle:"Marchandise (Business)",
goodsTypeLabel:"Type",
goodsOptions:[
{v:"carton",t:"Carton"},
{v:"sacs",t:"Sacs"},
{v:"colis_multiple",t:"Colis multiple"},
{v:"palette",t:"Palette"}
],
weightMode:"weight"
},
documents:{
label:"Documents (Express)",
lockSender:false,
senderDefault:"particulier",
showInternalRef:false,
internalRefRequired:false,
showSensitivity:false,
forcePriority:"express",
goodsTitle:"Documents",
goodsTypeLabel:"Type",
goodsOptions:[
{v:"documents",t:"Documents"},
{v:"enveloppe",t:"Enveloppe"}
],
weightMode:"weight"
}
};

function fillGoodsOptions(list){
goodsType.innerHTML=`<option value="">S√©lectionner</option>`;
list.forEach(o=>{
goodsType.innerHTML+=`<option value="${o.v}">${o.t}</option>`;
});
}

function applyWeightMode(mode){
if(mode==="qty"){
weightLabel.innerText="Quantit√©";
weightValue.placeholder="Ex: 2";
dynamicHint.innerText="Quantit√© requise.";
}else{
weightLabel.innerText="Poids estim√© (kg)";
weightValue.placeholder="Ex: 1.5";
dynamicHint.innerText="Poids requis.";
}
}

function applyServiceRules(init=false){
const s = SERVICES[service.value] || SERVICES.parcel;

serviceHint.innerText = "Service : " + s.label + " ‚Ä¢ Le formulaire s‚Äôadapte automatiquement.";

goodsTitle.innerText = s.goodsTitle;
goodsTypeLabel.innerText = s.goodsTypeLabel;
fillGoodsOptions(s.goodsOptions);
applyWeightMode(s.weightMode);

if(s.forcePriority){
priority.value = s.forcePriority;
}

if(s.lockSender){
senderType.value = s.senderDefault || "";
senderType.disabled = true;
}else{
senderType.disabled = false;
if(init && s.senderDefault) senderType.value = s.senderDefault;
}

const showInternal = !!s.showInternalRef;
internalRefWrap.style.display = showInternal ? "block" : "none";
if(!showInternal) internalRef.value="";
setRequired(internalRef, !!s.internalRefRequired);

sensitivityWrap.style.display = s.showSensitivity ? "block" : "none";
if(!s.showSensitivity) resetSensitivity();
else{
sensTemp.checked = true;
}

updateSummary();
}

service.addEventListener("change",()=>{applyServiceRules(false);});

senderType.addEventListener("change",()=>{
const t = senderType.value;
const showInternal = (t==="commerce" || t==="pharmacie" || t==="restaurant");
internalRefWrap.style.display = showInternal ? "block" : "none";
if(!showInternal) internalRef.value="";
const showSens = (t==="pharmacie" || t==="restaurant");
sensitivityWrap.style.display = showSens ? "block" : "none";
if(!showSens) resetSensitivity();
updateSummary();
});

/* ================= SUMMARY ================= */
function safeVal(v){return (v===undefined||v===null||String(v).trim()==="")?"‚Äî":String(v).trim();}
function updateSummary(){
const c = country.value==="RW" ? "Rwanda" : "Burundi";
const s = SERVICES[service.value]?.label || "Parcel";
const op = safeVal(originProvince.value);
const dp = safeVal(destProvince.value);
const oq = safeVal(originQuartier.value);
const dq = safeVal(destQuartier.value);

const st = safeVal(senderType.value);
const fr = safeVal(frequency.value);
const pr = safeVal(priority.value);

const gt = safeVal(goodsType.value);
const pm = safeVal(paymentMethod.value);
const dv = declaredValue.value ? Number(declaredValue.value||0).toLocaleString("fr-FR") : "‚Äî";
const wv = weightValue.value ? String(weightValue.value) : "‚Äî";

let sensTxt="‚Äî";
if(sensitivityWrap.style.display==="block"){
const arr=[];
if(sensFragile.checked) arr.push("Fragile");
if(sensTemp.checked) arr.push("Temp√©rature");
if(sensSensitive.checked) arr.push("Sensible");
sensTxt = arr.length?arr.join(", "):"‚Äî";
}

summaryText.innerText =
`Service: ${s}
${c} ‚Ä¢ ${op} (${oq}) ‚Üí ${dp} (${dq})
Exp√©diteur: ${st} ‚Ä¢ Fr√©quence: ${fr} ‚Ä¢ Priorit√©: ${pr}
Marchandise: ${gt} ‚Ä¢ Valeur d√©clar√©e: ${dv} ‚Ä¢ Poids/Qt√©: ${wv} ‚Ä¢ Paiement: ${pm}
Sensibilit√©: ${sensTxt}`;
}

[
service,frequency,priority,internalRef,
originProvince,destProvince,originQuartier,destQuartier,originLandmark,destLandmark,
senderName,senderPhone,receiverName,receiverPhone,
goodsType,weightValue,declaredValue,paymentMethod,content,notes,nonDangerous,
sensFragile,sensTemp,sensSensitive
].forEach(el=>{
if(!el) return;
el.addEventListener("input",updateSummary);
el.addEventListener("change",updateSummary);
});

/* ================= TRACKING ================= */
function generateTracking(cty){
const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
let code="CL-"+cty+"-";
for(let i=0;i<8;i++) code+=chars[Math.floor(Math.random()*chars.length)];
return code;
}

/* ================= PRICING (DYNAMIC / GLOBAL) ================= */
function countrySuffix(cty){ return (cty==="RW") ? "rw" : "bi"; }

async function loadPricing(cty){
const s = (service.value || "parcel").toLowerCase();
const suffix = countrySuffix(cty);
const primaryId = `${s}_${suffix}`;

let snap = await getDoc(doc(db,"pricing",primaryId));
if(snap.exists()) return { id: primaryId, data: snap.data() };

const legacyId = (cty==="RW") ? "parcel_rw" : "parcel_bi";
snap = await getDoc(doc(db,"pricing",legacyId));
if(snap.exists()) return { id: legacyId, data: snap.data() };

throw new Error("Configuration tarifaire introuvable.");
}

function num(v,def=0){const n=Number(v);return Number.isFinite(n)?n:def;}

/* ================= SUBMIT ================= */
/* ================= MAP INIT ================= */

let pickupLat=null;
let pickupLng=null;
let destLat=null;
let destLng=null;

const pickupMap = L.map('pickupMap').setView([-3.3822,29.3644],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(pickupMap);

const destMap = L.map('destMap').setView([-3.3822,29.3644],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(destMap);

let pickupMarker=null;
let destMarker=null;
let routeLine=null;

function drawRoute(){
if(pickupLat && pickupLng && destLat && destLng){

if(routeLine){
pickupMap.removeLayer(routeLine);
}

routeLine = L.polyline(
[
[pickupLat,pickupLng],
[destLat,destLng]
],
{
color:"#D4AF37",
weight:4,
opacity:0.9
}
).addTo(pickupMap);

pickupMap.fitBounds(routeLine.getBounds(),{padding:[40,40]});
}
}

pickupMap.on("click", function(e){
pickupLat = e.latlng.lat;
pickupLng = e.latlng.lng;

if(pickupMarker) pickupMap.removeLayer(pickupMarker);
pickupMarker = L.marker([pickupLat,pickupLng]).addTo(pickupMap);

drawRoute();
});

destMap.on("click", function(e){
destLat = e.latlng.lat;
destLng = e.latlng.lng;

if(destMarker) destMap.removeLayer(destMarker);
destMarker = L.marker([destLat,destLng]).addTo(destMap);

drawRoute();
});

/* ================= SUBMIT ================= */

let isSubmitting=false;

submitBtn.addEventListener("click", async ()=>{

if(isSubmitting) return;
isSubmitting=true;

showError("");
setLoading(true);

try{

if(!currentUser) throw new Error("Session expir√©e. Reconnectez-vous.");
if(!service.value) throw new Error("S√©lectionnez le service.");
if(!senderType.value) throw new Error("S√©lectionnez le type d‚Äôexp√©diteur.");
if(!frequency.value) throw new Error("S√©lectionnez la fr√©quence.");
if(!originProvince.value || !destProvince.value) throw new Error("S√©lectionnez la province de d√©part et destination.");
if(originProvince.value==="Bujumbura" && !originQuartier.value) throw new Error("S√©lectionnez le quartier de d√©part.");
if(destProvince.value==="Bujumbura" && !destQuartier.value) throw new Error("S√©lectionnez le quartier de destination.");

if(!pickupLat || !pickupLng) throw new Error("S√©lectionnez le point exact de d√©part sur la carte.");
if(!destLat || !destLng) throw new Error("S√©lectionnez le point exact de destination sur la carte.");

if(!senderName.value.trim() || !senderPhone.value.trim()) throw new Error("Compl√©tez les infos exp√©diteur.");
if(!receiverName.value.trim() || !receiverPhone.value.trim()) throw new Error("Compl√©tez les infos destinataire.");

if(senderPhone.value.length < 8 || receiverPhone.value.length < 8) throw new Error("Num√©ro de t√©l√©phone invalide.");

if(!goodsType.value) throw new Error("S√©lectionnez la marchandise.");
if(!weightValue.value) throw new Error("Poids / quantit√© requis.");
if(num(weightValue.value)<=0) throw new Error("Poids / quantit√© invalide.");
if(!paymentMethod.value) throw new Error("S√©lectionnez un mode de paiement.");
if(!content.value.trim()) throw new Error("Ajoutez une description courte.");
if(!nonDangerous.checked) throw new Error("Veuillez confirmer 'mati√®res non dangereuses'.");

if(internalRefWrap.style.display==="block" && internalRef.hasAttribute("required") && !internalRef.value.trim()){
throw new Error("R√©f√©rence interne requise (Business).");
}

const cty = country.value || "BI";

/* ===== PRICING (LOGIQUE ORIGINALE CONSERV√âE) ===== */

let pricingPack = await loadPricing(cty);
const pricing = pricingPack.data || {};

const originSameDest = (originProvince.value === destProvince.value);
let base = originSameDest ? num(pricing.urbanBase) : num(pricing.interBase);

const w = num(weightValue.value,1);
const declared = num(declaredValue.value,0);

const weightExtra = w>1 ? (w-1)*num(pricing.weightMultiplier) : 0;
const insurance = declared>0 ? declared*(num(pricing.insurancePercent)/100) : 0;
const fuel = (base+weightExtra)*(num(pricing.fuelPercent)/100);

const finalPrice = Math.round(base + weightExtra + insurance + fuel);

const priceBreakdown={
base:Math.round(base),
weightExtra:Math.round(weightExtra),
insurance:Math.round(insurance),
fuel:Math.round(fuel),
pricingId: pricingPack.id,
pricingVersion: pricing.pricingVersion || pricingPack.id || "pricing_v1"
};

/* ===== TRACKING ===== */

const tracking = generateTracking(cty);
const shipmentRef = doc(db,"shipments",tracking);

await setDoc(shipmentRef,{
trackingCode: tracking,

service: service.value,
serviceLabel: (SERVICES[service.value]?.label || "Parcel"),
country: cty,

pickupLat,
pickupLng,
destinationLat: destLat,
destinationLng: destLng,

ownerUid: currentUser.uid,
uid: currentUser.uid,

senderProfile:{
type: senderType.value,
frequency: frequency.value,
priority: priority.value,
internalReference: (internalRefWrap.style.display==="block" && internalRef.value.trim()) ? internalRef.value.trim() : null,
sensitivity:{
fragile: !!sensFragile.checked,
temperatureControlled: !!sensTemp.checked,
sensitiveProduct: !!sensSensitive.checked
}
},

senderName: senderName.value.trim(),
senderPhone: senderPhone.value.trim(),
receiverName: receiverName.value.trim(),
receiverPhone: receiverPhone.value.trim(),

fromProvince: originProvince.value,
fromQuartier: originProvince.value==="Bujumbura" ? (originQuartier.value || "‚Äî") : "‚Äî",
fromLandmark: originLandmark.value.trim() || null,

toProvince: destProvince.value,
toQuartier: destProvince.value==="Bujumbura" ? (destQuartier.value || "‚Äî") : "‚Äî",
toLandmark: destLandmark.value.trim() || null,

goodsType: goodsType.value,
weightOrQty: w,
declaredValue: declared>0 ? declared : null,

content: content.value.trim(),
notes: notes.value.trim() || null,

nonDangerous:true,

paymentMethod: paymentMethod.value,
paymentStatus:"unpaid",
status:"created",

priceCalculated:true,
finalPrice,
priceBreakdown,

createdAt: serverTimestamp()
});

showOk("Envoi cr√©√©. Redirection‚Ä¶");
location.replace(withBase("confirmation.html?tracking=" + encodeURIComponent(tracking)));

}catch(e){
showError(e.message || "Erreur inconnue.");
}finally{
setLoading(false);
isSubmitting=false;
}

});

/* INIT (page) */
applyPhonePrefix(country.value);
loadProvinces();
applyServiceRules(true);
updateSummary();

</script>

</body>
</html>
