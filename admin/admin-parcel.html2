<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard | Ciza Logistics</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Inter,Arial;background:#0f1115;color:#111;display:flex;min-height:100vh}

/* SIDEBAR */
.sidebar{
width:260px;
background:#000;
color:#fff;
display:flex;
flex-direction:column;
padding:20px 16px;
position:fixed;
height:100vh;
}
.logo{
font-weight:900;
font-size:18px;
color:#D4AF37;
margin-bottom:30px;
}
.nav a{
display:block;
padding:12px 14px;
border-radius:12px;
text-decoration:none;
color:#fff;
font-weight:800;
font-size:13px;
margin-bottom:8px;
}
.nav a:hover,
.nav a.active{
background:#D4AF37;
color:#000;
}
.sidebar-bottom{
margin-top:auto;
}
.logout-btn{
background:#D4AF37;
border:none;
padding:12px;
width:100%;
border-radius:12px;
font-weight:900;
cursor:pointer;
}

/* MAIN */
.main{
margin-left:260px;
flex:1;
padding:30px;
background:#f4f6f9;
min-height:100vh;
}

.header-title{
font-size:20px;
font-weight:900;
margin-bottom:20px;
}

/* KPI */
.kpi-grid{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
gap:16px;
margin-bottom:30px;
}
.kpi{
background:#000;
color:#D4AF37;
padding:18px;
border-radius:16px;
text-align:center;
font-weight:900;
}
.kpi small{
display:block;
color:#fff;
opacity:.8;
margin-top:6px;
font-size:11px;
}

/* CARD */
.card{
background:#fff;
border-radius:16px;
padding:18px;
margin-bottom:14px;
border:1px solid rgba(0,0,0,0.05);
}
.status{
display:inline-block;
padding:6px 12px;
border-radius:999px;
color:#fff;
font-size:11px;
font-weight:900;
margin-bottom:10px;
text-transform:uppercase;
}
.row{
display:grid;
grid-template-columns:1.2fr 1fr;
gap:20px;
margin-top:10px;
}
.meta{
font-size:12px;
line-height:1.6;
}
.controls{
margin-top:12px;
display:flex;
flex-wrap:wrap;
gap:8px;
}
button{
background:#D4AF37;
border:none;
padding:10px 12px;
border-radius:10px;
font-weight:900;
cursor:pointer;
font-size:12px;
}
.print-btn{
background:#000;
color:#D4AF37;
border:1px solid rgba(212,175,55,.3);
}

@media(max-width:900px){
.sidebar{position:relative;width:100%;height:auto}
.main{margin-left:0}
.row{grid-template-columns:1fr}
}
</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
<div class="logo">CIZA LOGISTICS</div>

<div class="nav">
<a href="admin-parcel.html" class="active">ðŸ“¦ Colis</a>
<a href="driver-details.html">ðŸšš Chauffeurs</a>
<a href="driver-payments.html">ðŸ’° Paiements</a>
<a href="messages.html">ðŸ’¬ Messagerie</a>
<a href="calendar.html">ðŸ“… Planning</a>
</div>

<div class="sidebar-bottom">
<button class="logout-btn" id="logoutBtn">DÃ©connexion</button>
</div>
</div>

<!-- MAIN -->
<div class="main">

<div class="header-title">Dashboard Colis</div>

<div class="kpi-grid">
<div class="kpi"><div id="kpiPayment">0</div><small>Paiement attente</small></div>
<div class="kpi"><div id="kpiReady">0</div><small>Ready</small></div>
<div class="kpi"><div id="kpiAssigned">0</div><small>AssignÃ©</small></div>
<div class="kpi"><div id="kpiTransit">0</div><small>Transit</small></div>
<div class="kpi"><div id="kpiDelivered">0</div><small>LivrÃ©</small></div>
<div class="kpi"><div id="kpiRevenue">0</div><small>Total CA</small></div>
</div>

<div id="parcelList"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, query, where, onSnapshot, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* FIREBASE */
const app = initializeApp({
apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
authDomain:"ciza-logistics.firebaseapp.com",
projectId:"ciza-logistics"
});
const db = getFirestore(app);
const auth = getAuth(app);

/* ADMIN GUARD */
onAuthStateChanged(auth, async(user)=>{
if(!user){ location.href="../login.html"; return; }
const snap = await getDoc(doc(db,"users",user.uid));
if(!snap.exists()){ location.href="../login.html"; return; }
const data=snap.data();
if(data.role!=="admin" && data.role!=="superadmin"){
location.href="../login.html";
return;
}
});

/* LOGOUT */
document.getElementById("logoutBtn").addEventListener("click",async()=>{
await signOut(auth);
location.href="../login.html";
});

/* LOAD SHIPMENTS */
const q = query(collection(db,"shipments"), where("service","==","parcel"));

onSnapshot(q,(snap)=>{
let payment=0,ready=0,assigned=0,transit=0,delivered=0,revenue=0;
let html="";

snap.forEach(docSnap=>{
const d=docSnap.data();
const id=docSnap.id;

if(d.status==="payment_under_review") payment++;
if(d.status==="ready_for_pickup") ready++;
if(d.status==="assigned") assigned++;
if(d.status==="in_transit") transit++;
if(d.status==="delivered") delivered++;
revenue += d.finalPrice || 0;

let color="#000";
if(d.status==="payment_under_review") color="#e67e22";
if(d.status==="ready_for_pickup") color="#f39c12";
if(d.status==="assigned") color="#2980b9";
if(d.status==="in_transit") color="#8e44ad";
if(d.status==="delivered") color="#27ae60";

html+=`
<div class="card">
<div style="display:flex;justify-content:space-between">
<div style="font-weight:900">${id}</div>
<div class="status" style="background:${color}">${d.status||"â€”"}</div>
</div>

<div class="row">
<div class="meta">
<b>Route:</b> ${d.fromProvince||""} â†’ ${d.toProvince||""}<br>
<b>Client:</b> ${d.senderName||""}<br>
<b>Destinataire:</b> ${d.receiverName||""}<br>
<b>Description:</b> ${d.content||""}
</div>
<div class="meta">
<b>Prix:</b> ${(d.finalPrice||0).toLocaleString("fr-FR")} BIF<br>
<b>Paiement:</b> ${d.paymentStatus||""}
</div>
</div>

<div class="controls">
<button onclick="location.href='driver-details.html?tracking=${id}'">Dossier</button>
<button class="print-btn" onclick="window.open('../print-label.html?tracking=${id}','_blank')">Imprimer</button>
</div>
</div>
`;
});

document.getElementById("parcelList").innerHTML=html;
document.getElementById("kpiPayment").innerText=payment;
document.getElementById("kpiReady").innerText=ready;
document.getElementById("kpiAssigned").innerText=assigned;
document.getElementById("kpiTransit").innerText=transit;
document.getElementById("kpiDelivered").innerText=delivered;
document.getElementById("kpiRevenue").innerText=revenue.toLocaleString("fr-FR")+" BIF";
});
</script>

</body>
</html>
