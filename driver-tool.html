<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="#000000">

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<title>Ciza Driver</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
:root{
  --gold:#D4AF37;
  --bg:#f3f4f6;
  --card:#fff;
  --muted:#6b7280;
  --ok:#16a34a;
  --warn:#f59e0b;
  --bad:#dc2626;
}

*{box-sizing:border-box}
body{margin:0;font-family:Inter;background:var(--bg);color:#111;}

.header{
  background:#000;
  color:#fff;
  padding:16px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.brand{color:var(--gold);font-weight:900;font-size:16px;}
.driverName{font-size:12px;color:#ddd;}

.header-right{display:flex;gap:16px;align-items:center;}

.badge{
  padding:6px 12px;
  border-radius:999px;
  font-weight:900;
  font-size:12px;
  background:var(--ok);
  color:#fff;
}

.badge.gold{background:var(--gold);color:#000;}

.logout-btn{
  background:var(--gold);
  border:none;
  padding:8px 14px;
  border-radius:12px;
  font-weight:900;
  cursor:pointer;
}

.container{width:95%;max-width:1200px;margin:20px auto;}

.card{
  background:var(--card);
  border-radius:18px;
  padding:18px;
  margin-bottom:18px;
  box-shadow:0 12px 26px rgba(0,0,0,0.06);
}

.section-title{font-weight:900;margin-bottom:14px;}

.actionsRow{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px;}

.btn{
  border:none;
  border-radius:14px;
  padding:12px 16px;
  font-weight:900;
  cursor:pointer;
}

.btn.full{width:100%;}
.btn.dark{background:#111;color:#fff;}
.btn.gold{background:var(--gold);color:#000;}

input{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(0,0,0,0.12);
  margin-top:10px;
}

#map{height:300px;border-radius:16px;margin-top:12px;}

.small{font-size:12px;color:var(--muted);}
.shipment-card{
  border:1px solid rgba(212,175,55,0.35);
  border-radius:16px;
  padding:14px;
  margin-bottom:12px;
}
</style>
</head>

<body>

<div class="header">
  <div>
    <div class="brand">üöö Ciza Driver</div>
    <div class="driverName" id="driverName">Chargement...</div>
  </div>
  <div class="header-right">
    <span class="badge" id="connectionStatus">En ligne</span>
    <span class="badge gold" id="deliveryCounter">0</span>
    <button class="logout-btn" id="logoutBtn">D√©connexion</button>
  </div>
</div>

<div class="container">

<div class="card">
  <div class="section-title">üü° √Ä traiter</div>
  <div id="assignedList"></div>
</div>

<div class="card">
  <div class="section-title">üîµ En transit</div>
  <div id="transitList"></div>
</div>

<div class="card">
  <div class="section-title">üü¢ Livr√©s</div>
  <div id="deliveredList"></div>
</div>

<div class="card">
  <div class="section-title">
    üì¶ D√©tails & Navigation
    <span id="selectedHint">S√©lectionne un colis</span>
  </div>

  <div id="shipmentDetails">Aucun colis s√©lectionn√©</div>
  <div id="map"></div>

  <div class="actionsRow">
    <button class="btn gold full" id="mainActionBtn" style="display:none;">Action</button>
    <button class="btn dark full" id="navBtn" style="display:none;">üß≠ Navigation</button>
  </div>
</div>

<div class="card" id="deliverySecurity" style="display:none;">
  <div class="section-title">üîê Finalisation livraison</div>
  <input type="text" id="otpInput" placeholder="Entrer OTP client">
  <input type="file" accept="image/*" capture="environment" id="photoInput">
</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, query, where, onSnapshot,
  doc, getDoc, updateDoc, serverTimestamp } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const app = initializeApp({
  apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
  authDomain:"ciza-logistics.firebaseapp.com",
  projectId:"ciza-logistics",
  storageBucket:"ciza-logistics.appspot.com"
});

const db=getFirestore(app);
const auth=getAuth(app);
const storage=getStorage(app);

let currentUser=null;
let selectedShipment=null;
let selectedShipmentId=null;
let lastLat=null,lastLng=null;

let map=L.map('map').setView([-3.3731,29.9189],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let driverMarker=null;
let destinationMarker=null;

onAuthStateChanged(auth,async(user)=>{
  if(!user){location.href="login.html";return;}
  currentUser=user;
  startGPS();
  listenShipments();
});

document.getElementById("logoutBtn").onclick=async()=>{
  await signOut(auth);
  location.href="login.html";
};

function startGPS(){
  navigator.geolocation.watchPosition(pos=>{
    lastLat=pos.coords.latitude;
    lastLng=pos.coords.longitude;

    if(driverMarker){
      driverMarker.setLatLng([lastLat,lastLng]);
    }else{
      driverMarker=L.marker([lastLat,lastLng]).addTo(map);
      map.setView([lastLat,lastLng],13);
    }
  });
}

function listenShipments(){
  const q=query(collection(db,"shipments"),
    where("assignedDriverId","==",currentUser.uid));

  onSnapshot(q,snap=>{
    let assigned=[],transit=[],delivered=[];

    snap.forEach(docSnap=>{
      const d=docSnap.data();
      d.id=docSnap.id;

      if(d.archivedByDriver) return;

      if(d.status==="assigned"||d.status==="picked_up") assigned.push(d);
      else if(d.status==="in_transit") transit.push(d);
      else if(d.status==="delivered") delivered.push(d);
    });

    renderList("assignedList",assigned);
    renderList("transitList",transit);
    renderList("deliveredList",delivered);
    document.getElementById("deliveryCounter").textContent=delivered.length;
  });
}

function renderList(id,list){
  const el=document.getElementById(id);
  if(!list.length){el.innerHTML="<div class='small'>Aucun colis.</div>";return;}

  el.innerHTML=list.map(d=>`
    <div class="shipment-card">
      <b>${d.trackingCode||d.id}</b><br>
      üìç ${d.fromCity||""} ‚Üí ${d.toCity||""}
      <div class="actionsRow">
        <button class="btn dark" onclick="selectShipment('${d.id}')">Voir</button>
      </div>
    </div>
  `).join("");
}

window.selectShipment=async function(id){
  const snap=await getDoc(doc(db,"shipments",id));
  if(!snap.exists())return;

  selectedShipmentId=id;
  selectedShipment=snap.data();

  document.getElementById("selectedHint").innerText=
    "S√©lectionn√© : "+(selectedShipment.trackingCode||id);

  document.getElementById("shipmentDetails").innerHTML=
    `<b>${selectedShipment.trackingCode||id}</b><br>
     üìç ${selectedShipment.fromCity||""} ‚Üí ${selectedShipment.toCity||""}`;

  if(selectedShipment.toLat && selectedShipment.toLng){
    if(destinationMarker){
      destinationMarker.setLatLng([selectedShipment.toLat,selectedShipment.toLng]);
    }else{
      destinationMarker=L.marker([selectedShipment.toLat,selectedShipment.toLng]).addTo(map);
    }
  }

  refreshButtons(selectedShipment.status);
};

document.getElementById("mainActionBtn").onclick=async()=>{
  if(!selectedShipmentId) return;

  const refDoc=doc(db,"shipments",selectedShipmentId);
  const snap=await getDoc(refDoc);
  if(!snap.exists())return;

  const data=snap.data();

  if(data.status==="assigned"){
    await updateDoc(refDoc,{status:"picked_up",pickedUpAt:serverTimestamp()});
  }
  else if(data.status==="picked_up"){
    await updateDoc(refDoc,{status:"in_transit",transitAt:serverTimestamp()});
  }
  else if(data.status==="in_transit"){
    await finalizeDelivery(refDoc,data);
  }
};

async function finalizeDelivery(refDoc,data){
  const otp=document.getElementById("otpInput").value.trim();
  if(otp!==(data.otpCode||"")){alert("OTP incorrect");return;}

  const photo=document.getElementById("photoInput").files[0];
  if(!photo){alert("Photo obligatoire");return;}

  const photoRef=ref(storage,`deliveries/${selectedShipmentId}/photo.jpg`);
  await uploadBytes(photoRef,photo);
  const photoURL=await getDownloadURL(photoRef);

  await updateDoc(refDoc,{
    status:"delivered",
    deliveredAt:serverTimestamp(),
    deliveryPhoto:photoURL
  });

  alert("Livraison confirm√©e ‚úÖ");
}

document.getElementById("navBtn").onclick=function(){
  if(!selectedShipment||!selectedShipment.toLat||!selectedShipment.toLng)return;
  if(!lastLat||!lastLng)return;

  window.open(
    `https://www.google.com/maps/dir/?api=1&origin=${lastLat},${lastLng}&destination=${selectedShipment.toLat},${selectedShipment.toLng}`,
    "_blank"
  );
};

function refreshButtons(status){
  const main=document.getElementById("mainActionBtn");
  const nav=document.getElementById("navBtn");
  const sec=document.getElementById("deliverySecurity");

  main.style.display="block";

  if(status==="assigned"){
    main.innerText="Confirmer prise en charge";
    nav.style.display="none";
    sec.style.display="none";
  }
  else if(status==="picked_up"){
    main.innerText="D√©marrer livraison";
    nav.style.display="block";
    sec.style.display="none";
  }
  else if(status==="in_transit"){
    main.innerText="Confirmer livraison";
    nav.style.display="block";
    sec.style.display="block";
  }
  else{
    main.style.display="none";
    nav.style.display="none";
    sec.style.display="none";
  }
}

</script>
</body>
</html>
