<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Enterprise | Ciza Logistics</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:Arial;background:#f4f6f9;color:#111;}
.container{width:95%;max-width:1300px;margin:auto;}

header{
background:#000;
color:#fff;
padding:25px;
text-align:center;
}
header h1{color:#D4AF37;font-size:22px;}

.section{
margin-top:30px;
background:#fff;
padding:25px;
border-radius:18px;
box-shadow:0 10px 30px rgba(0,0,0,0.08);
}

.kpi-grid{
display:grid;
grid-template-columns:repeat(5,1fr);
gap:20px;
margin-bottom:25px;
}

.kpi-box{
background:#000;
color:#D4AF37;
padding:20px;
border-radius:16px;
text-align:center;
font-weight:bold;
}

.request-card{
border:1px solid rgba(212,175,55,0.4);
padding:18px;
border-radius:16px;
margin-bottom:18px;
}

.status-badge{
display:inline-block;
padding:6px 12px;
border-radius:999px;
font-size:12px;
font-weight:900;
color:#fff;
margin-top:6px;
}

button{
background:#D4AF37;
border:none;
padding:8px 14px;
border-radius:12px;
font-weight:900;
cursor:pointer;
margin:6px 6px 0 0;
}

textarea{
width:100%;
margin-top:8px;
padding:10px;
border-radius:10px;
border:1px solid #ccc;
}

.footer-divider{
width:100%;height:4px;
background:linear-gradient(to right,rgba(212,175,55,0.2),#D4AF37,rgba(212,175,55,0.2));
margin-top:60px;
}

.footer{
background:#000;
color:#fff;
padding:50px 0 30px;
}

.footer-grid{
display:grid;
grid-template-columns:2fr 1fr 1fr 1fr;
gap:30px;
}

.footer-logo{
height:70px;
margin-bottom:15px;
}

.footer a{
display:block;
text-decoration:none;
color:#cfcfcf;
margin:6px 0;
font-size:14px;
}

.footer a:hover{color:#D4AF37;}

.footer-bottom{
text-align:center;
margin-top:30px;
font-size:13px;
color:#888;
}

@media(max-width:900px){
.kpi-grid{grid-template-columns:1fr;}
.footer-grid{grid-template-columns:1fr;}
}
</style>
</head>

<body>

<header>
<h1>ADMIN ENTERPRISE – CIZA LOGISTICS</h1>
</header>

<div class="container">

<div class="section">
<h2>Vue Globale</h2>

<div class="kpi-grid">
<div class="kpi-box"><div id="total">0</div><small>Total</small></div>
<div class="kpi-box"><div id="pending">0</div><small>En attente</small></div>
<div class="kpi-box"><div id="approved">0</div><small>Approuvées</small></div>
<div class="kpi-box"><div id="rejected">0</div><small>Rejetées</small></div>
<div class="kpi-box"><div id="monthly">0</div><small>Ce mois</small></div>
</div>

<button onclick="exportExcel()">Exporter Excel</button>

</div>

<div class="section">
<h2>Demandes Entreprise</h2>
<div id="requestList"></div>
</div>

</div>

<div class="footer-divider"></div>

<footer class="footer">
<div class="container footer-grid">

<div>
<img src="https://raw.githubusercontent.com/cizaimmo/ciza-logistics/4b1ea6a2d3697e3982880984ee31dca42d8c52fc/logo.png" class="footer-logo">
<p>Division Logistique de Ciza Group.</p>
</div>

<div>
<h4>Entreprise</h4>
<a href="enterprise.html">Page Enterprise</a>
<a href="index.html">Accueil</a>
</div>

<div>
<h4>Légal</h4>
<a href="#">Confidentialité</a>
<a href="#">Conditions</a>
</div>

<div>
<h4>Support</h4>
<a href="mailto:contact@cizalogistics.bi">contact@cizalogistics.bi</a>
</div>

</div>

<div class="footer-bottom">
© 2026 Ciza Logistics – Tous droits réservés
</div>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, onSnapshot, doc, updateDoc, addDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
authDomain:"ciza-logistics.firebaseapp.com",
projectId:"ciza-logistics"
});

const auth = getAuth(app);
const db = getFirestore(app);

onAuthStateChanged(auth,(user)=>{
if(!user){
alert("Connexion requise");
location.href="login.html";
}
});

onSnapshot(collection(db,"enterpriseRequests"),(snap)=>{

let total=0,pending=0,approved=0,rejected=0,monthly=0;
let html="";

const now=new Date();
const currentMonth=now.getMonth();
const currentYear=now.getFullYear();

snap.forEach(docSnap=>{
const d=docSnap.data();
total++;

if(d.status==="pending_review") pending++;
if(d.status==="approved") approved++;
if(d.status==="rejected") rejected++;

if(d.createdAt){
const date=d.createdAt.toDate();
if(date.getMonth()===currentMonth && date.getFullYear()===currentYear){
monthly++;
}
}

let badge="#999";
if(d.status==="pending_review") badge="#e67e22";
if(d.status==="approved") badge="#27ae60";
if(d.status==="rejected") badge="#c0392b";

html+=`
<div class="request-card">
<strong>${d.companyName}</strong><br>
Responsable : ${d.contactPerson}<br>
Email : ${d.email}<br>
Organisation : ${d.organizationType}<br>
Volume : ${d.monthlyVolume}<br>
<span class="status-badge" style="background:${badge}">${d.status}</span>

<textarea id="note-${docSnap.id}" placeholder="Note interne">${d.adminNote||""}</textarea>

<br>
<button onclick="approve('${docSnap.id}')">Approuver</button>
<button onclick="reject('${docSnap.id}')">Rejeter</button>
<button onclick="saveNote('${docSnap.id}')">Sauvegarder note</button>
<button onclick="convertAccount('${docSnap.id}')">Convertir Compte</button>
</div>
`;
});

document.getElementById("total").innerText=total;
document.getElementById("pending").innerText=pending;
document.getElementById("approved").innerText=approved;
document.getElementById("rejected").innerText=rejected;
document.getElementById("monthly").innerText=monthly;
document.getElementById("requestList").innerHTML=html;

});

window.approve = async(id)=>{
await updateDoc(doc(db,"enterpriseRequests",id),{status:"approved"});
};

window.reject = async(id)=>{
await updateDoc(doc(db,"enterpriseRequests",id),{status:"rejected"});
};

window.saveNote = async(id)=>{
const note=document.getElementById("note-"+id).value;
await updateDoc(doc(db,"enterpriseRequests",id),{adminNote:note});
alert("Note sauvegardée");
};

window.convertAccount = async(id)=>{
const requestRef = doc(db,"enterpriseRequests",id);
const snap = await getDoc(requestRef);
const data = snap.data();

if(data.status !== "approved"){
alert("Approuvez d'abord la demande.");
return;
}

await addDoc(collection(db,"enterpriseAccounts"),{
companyName:data.companyName,
email:data.email,
monthlyVolume:data.monthlyVolume,
status:"active",
accountType:"enterprise",
contractAccepted:true,
createdAt:serverTimestamp()
});

await updateDoc(requestRef,{
status:"active",
converted:true,
convertedAt:serverTimestamp()
});

alert("Compte Enterprise activé.");
};

window.exportExcel = ()=>{
let csv="Entreprise,Responsable,Email,Volume,Statut\n";
document.querySelectorAll(".request-card").forEach(card=>{
csv+=card.innerText.replace(/\n/g,",")+"\n";
});
const blob=new Blob([csv],{type:"text/csv"});
const url=URL.createObjectURL(blob);
const a=document.createElement("a");
a.href=url;
a.download="enterprise_requests.csv";
a.click();
};

</script>

</body>
</html>
