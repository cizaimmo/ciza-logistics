<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Suivi colis | Ciza Logistics</title>

<!-- jsPDF + QR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:Arial,Helvetica,sans-serif;background:#f5f7fa;color:#111;}
.container{width:92%;max-width:1100px;margin:auto;}
html{scroll-behavior:smooth;}

.main-header{position:fixed;width:100%;background:#000;padding:22px 0;z-index:1000;}
.header-container{display:flex;justify-content:space-between;align-items:center;}
.logo img{height:90px;}
.nav-menu{display:flex;gap:22px;align-items:center;}
.nav-menu a{color:#fff;text-decoration:none;text-transform:uppercase;font-size:13px;letter-spacing:1px;}
.nav-menu a:hover{color:#D4AF37;}

.hero{padding-top:170px;padding-bottom:40px;}
.hero-box{background:#000;color:#fff;border-radius:28px;padding:35px;box-shadow:0 30px 80px rgba(0,0,0,0.2);border:1px solid rgba(212,175,55,0.3);}
.hero-box h1{font-size:32px;margin-bottom:10px;}
.hero-box p{color:#ccc;}

.track-card{background:#fff;border-radius:28px;padding:30px;margin-top:25px;box-shadow:0 30px 80px rgba(0,0,0,0.1);border:1px solid rgba(212,175,55,0.25);}
.track-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;margin-bottom:25px;}
.track-code{font-weight:900;font-size:18px;color:#D4AF37;}
.status-badge{padding:8px 16px;border-radius:999px;background:#000;color:#fff;font-size:12px;}

.timeline{position:relative;margin-top:20px;}
.timeline:before{content:"";position:absolute;left:12px;top:0;width:3px;height:100%;background:rgba(212,175,55,0.3);}
.step{position:relative;margin-left:35px;margin-bottom:35px;}
.step:before{content:"";position:absolute;left:-25px;top:4px;width:18px;height:18px;border-radius:50%;background:#fff;border:3px solid #ccc;}
.step.active:before{border-color:#D4AF37;background:#D4AF37;transition:0.4s ease;}
.step h3{font-size:14px;margin-bottom:5px;}
.step p{font-size:13px;color:#666;}

.estimate-box{margin-top:20px;padding:15px;border-radius:14px;background:rgba(212,175,55,0.1);font-size:14px;}

.otp-box{margin-top:20px;padding:15px;border-radius:16px;background:#000;color:#fff;font-weight:900;letter-spacing:3px;text-align:center;display:none;}
.photo-box{margin-top:20px;display:none;}
.photo-box img{width:100%;border-radius:18px;border:1px solid rgba(212,175,55,0.4);}
.pdf-btn{margin-top:20px;display:none;padding:12px 20px;background:#D4AF37;color:#000;font-weight:900;border:none;border-radius:14px;cursor:pointer;}

.footer{background:#000;color:#fff;padding:40px 0;text-align:center;margin-top:60px;}
.footer strong{color:#D4AF37;}

@media(max-width:900px){
.nav-menu{display:none;}
.hero{padding-top:150px;}
}
</style>
</head>

<body>

<header class="main-header">
<div class="container header-container">
<div class="logo">
<img src="https://raw.githubusercontent.com/cizaimmo/ciza-logistics/4b1ea6a2d3697e3982880984ee31dca42d8c52fc/logo.png">
</div>
<nav class="nav-menu">
<a href="index.html">Accueil</a>
<a href="parcel.html">Parcel</a>
<a href="tracking.html">Suivi</a>
</nav>
</div>
</header>

<section class="hero">
<div class="container">
<div class="hero-box">
<h1>Suivi en temps réel</h1>
<p>Statut officiel de votre envoi Ciza Logistics.</p>
</div>
</div>
</section>

<section class="container">
<div class="track-card">

<div class="track-header">
<div class="track-code" id="trackCode">Tracking : —</div>
<div class="status-badge" id="statusBadge">Chargement...</div>
</div>

<div class="timeline">
<div class="step" id="s1"><h3>Création</h3><p>Envoi enregistré.</p></div>
<div class="step" id="s2"><h3>Paiement</h3><p>En attente.</p></div>
<div class="step" id="s3"><h3>Ramassage</h3><p>Colis pris en charge.</p></div>
<div class="step" id="s4"><h3>En transit</h3><p>En route.</p></div>
<div class="step" id="s5"><h3>Livré</h3><p>Remis au destinataire.</p></div>
</div>

<div class="estimate-box" id="estimateBox"></div>

<div class="otp-box" id="otpBox"></div>
<div class="photo-box" id="photoBox"><img id="deliveryPhoto"></div>
<button class="pdf-btn" id="pdfBtn">Télécharger preuve officielle (PDF)</button>

</div>
</section>

<footer class="footer">
© 2026 <strong>Ciza Logistics</strong>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const { jsPDF } = window.jspdf;

const firebaseConfig = {
apiKey: "AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
authDomain: "ciza-logistics.firebaseapp.com",
projectId: "ciza-logistics"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const params = new URLSearchParams(window.location.search);
const code = params.get("code");

if(!code){
document.getElementById("statusBadge").innerText="Tracking invalide";
throw new Error("Tracking invalide");
}

document.getElementById("trackCode").innerText="Tracking : "+code;

const ref = doc(db,"shipments",code);

onSnapshot(ref,(snap)=>{
if(!snap.exists()){
document.getElementById("statusBadge").innerText="Introuvable";
return;
}

const data = snap.data();
const status = data.status || "created";

updateUI(status,data);
});

function updateUI(status,data){

const badge = document.getElementById("statusBadge");
const estimate = document.getElementById("estimateBox");
const steps=["s1","s2","s3","s4","s5"];
steps.forEach(id=>document.getElementById(id).classList.remove("active"));

let label="",color="#000";

switch(status){
case "created":
label="Enregistré";color="#000";
activate(["s1"]);
estimate.innerText="Livraison estimée : 24 à 48h après validation.";
break;

case "payment_under_review":
label="Paiement en vérification";color="#a67c00";
activate(["s1","s2"]);
document.querySelector("#s2 h3").innerText="Paiement en vérification";
document.querySelector("#s2 p").innerText="Transaction en analyse.";
break;

case "payment_validated":
label="Paiement validé";color="#2e7d32";
activate(["s1","s2"]);
document.querySelector("#s2 h3").innerText="Paiement validé";
document.querySelector("#s2 p").innerText="Transaction confirmée.";
break;

case "picked_up":
label="Colis ramassé";color="#1565c0";
activate(["s1","s2","s3"]);
estimate.innerText="Colis en préparation pour transit.";
break;

case "in_transit":
label="En transit";color="#6a1b9a";
activate(["s1","s2","s3","s4"]);
estimate.innerText="Colis en route. Livraison imminente.";
break;

case "delivered":
label="Livré";color="#1b5e20";
activate(["s1","s2","s3","s4","s5"]);
estimate.innerText="Colis livré avec succès.";
document.getElementById("pdfBtn").style.display="inline-block";
break;
}

badge.innerText=label;
badge.style.background=color;

/* OTP */
if(data.deliveryOTP){
document.getElementById("otpBox").style.display="block";
document.getElementById("otpBox").innerText="CODE OTP : "+data.deliveryOTP;
}

/* Photo */
if(data.deliveryPhoto){
document.getElementById("photoBox").style.display="block";
document.getElementById("deliveryPhoto").src=data.deliveryPhoto;
}

/* POD */
document.getElementById("pdfBtn").onclick=function(){
generatePDF(data);
};
}

function activate(arr){
arr.forEach(id=>document.getElementById(id).classList.add("active"));
}

function generatePDF(data){

const docPDF=new jsPDF();
docPDF.setFontSize(18);
docPDF.text("CIZA LOGISTICS",20,20);

docPDF.setFontSize(12);
docPDF.text("Preuve officielle de livraison",20,30);
docPDF.text("Tracking : "+code,20,40);

if(data.deliveredAt){
docPDF.text("Date : "+new Date(data.deliveredAt.seconds*1000).toLocaleString(),20,50);
}

if(data.deliveredBy){
docPDF.text("Livre par : "+data.deliveredBy,20,60);
}

if(data.receiverNameConfirmed){
docPDF.text("Destinataire : "+data.receiverNameConfirmed,20,70);
}

const qrContainer=document.createElement("div");
new QRCode(qrContainer,{text:code,width:80,height:80});
const qrImg=qrContainer.querySelector("img").src;

docPDF.addImage(qrImg,"PNG",140,20,40,40);

docPDF.save("Ciza_Logistics_POD_"+code+".pdf");
}
</script>

</body>
</html>
