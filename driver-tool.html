<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="#000000">

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<title>Ciza Driver</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{margin:0;font-family:Inter;background:#f3f4f6;transition:0.3s;}
.header{background:#000;color:#fff;padding:14px;display:flex;justify-content:space-between;align-items:center;}
.brand{color:#D4AF37;font-weight:900;}
.badge{padding:6px 12px;border-radius:999px;font-weight:700;background:#16a34a;}
.card{background:#fff;margin:16px;padding:16px;border-radius:16px;}
#map{height:260px;border-radius:16px;margin-top:10px;}
.btn{width:100%;padding:14px;border:none;border-radius:14px;font-weight:900;margin-top:10px;}
.gold{background:#D4AF37;}
.dark{background:#111;color:#fff;}
input{width:100%;padding:12px;margin-top:10px;border-radius:12px;border:1px solid #ddd;}
canvas{border:1px solid #ddd;margin-top:10px;border-radius:12px;width:100%;height:150px;touch-action:none;}
.small{font-size:12px;color:#777;}
</style>
</head>

<body>

<div class="header">
  <div class="brand">ðŸšš Ciza Driver</div>
  <span class="badge">En ligne</span>
</div>

<div class="card">
  <h3>Livraison active</h3>
  <div id="shipmentInfo">Aucune</div>
  <div id="etaInfo" class="small"></div>
  <div id="map"></div>

  <input id="otpInput" placeholder="Code OTP">
  <canvas id="signaturePad"></canvas>
  <button class="btn dark" id="clearSignature">Effacer signature</button>
  <button class="btn gold" id="mainActionBtn">Action</button>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, query, where, onSnapshot, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const app=initializeApp({
apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
authDomain:"ciza-logistics.firebaseapp.com",
projectId:"ciza-logistics"
});

const auth=getAuth(app);
const db=getFirestore(app);
const storage=getStorage(app);

let currentUser,activeShipment,lastLat,lastLng,lastAccuracy;
let driverMarker,destinationMarker;
let map=L.map('map').setView([-3.3731,29.9189],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

/* GPS */
navigator.geolocation.watchPosition(pos=>{
lastLat=pos.coords.latitude;
lastLng=pos.coords.longitude;
lastAccuracy=pos.coords.accuracy;

if(driverMarker) driverMarker.setLatLng([lastLat,lastLng]);
else driverMarker=L.marker([lastLat,lastLng]).addTo(map);
});

/* Auth */
onAuthStateChanged(auth,async(user)=>{
if(!user)return;
currentUser=user;
loadShipment();
});

/* Load shipment */
function loadShipment(){
const q=query(collection(db,"shipments"),where("assignedDriverId","==",currentUser.uid));
onSnapshot(q,snap=>{
snap.forEach(docSnap=>{
const s={id:docSnap.id,...docSnap.data()};
if(["assigned","picked_up","in_transit"].includes(s.status)){
activeShipment=s;
document.getElementById("shipmentInfo").innerHTML=
`<strong>${s.trackingCode}</strong><br>
${s.fromCity} â†’ ${s.toCity}<br>
ðŸ“ž <a href="tel:${s.senderPhone}">${s.senderPhone}</a><br>
ðŸ“ ${s.repereDestination||""}`;

if(s.toLat && s.toLng){
if(destinationMarker) destinationMarker.setLatLng([s.toLat,s.toLng]);
else destinationMarker=L.marker([s.toLat,s.toLng]).addTo(map);
}
}
});
});
}

/* Distance */
function calcDist(lat1,lon1,lat2,lon2){
const R=6371;
const dLat=(lat2-lat1)*Math.PI/180;
const dLon=(lon2-lon1)*Math.PI/180;
const a=Math.sin(dLat/2)**2+
Math.cos(lat1*Math.PI/180)*
Math.cos(lat2*Math.PI/180)*
Math.sin(dLon/2)**2;
return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* Signature */
const canvas=document.getElementById("signaturePad");
const ctx=canvas.getContext("2d");
let drawing=false;
canvas.addEventListener("mousedown",()=>drawing=true);
canvas.addEventListener("mouseup",()=>drawing=false);
canvas.addEventListener("mousemove",e=>{
if(!drawing)return;
ctx.lineWidth=2;
ctx.lineCap="round";
ctx.lineTo(e.offsetX,e.offsetY);
ctx.stroke();
});
document.getElementById("clearSignature").onclick=()=>ctx.clearRect(0,0,canvas.width,canvas.height);

/* Action */
document.getElementById("mainActionBtn").onclick=async()=>{
if(!activeShipment)return;

if(activeShipment.status==="assigned"){
await updateDoc(doc(db,"shipments",activeShipment.id),{status:"picked_up",pickedUpAt:serverTimestamp()});
return;
}

if(activeShipment.status==="picked_up"){
await updateDoc(doc(db,"shipments",activeShipment.id),{status:"in_transit",transitAt:serverTimestamp()});
return;
}

if(activeShipment.status==="in_transit"){
const snap=await getDoc(doc(db,"shipments",activeShipment.id));
const data=snap.data();

if(document.getElementById("otpInput").value!== (data.otpCode||data.deliveryOtp)){
alert("OTP incorrect");return;
}

if(!lastLat||!data.toLat){alert("GPS manquant");return;}

if(calcDist(lastLat,lastLng,data.toLat,data.toLng)*1000>100){
alert("Trop loin du point de livraison");return;
}

const sigData=canvas.toDataURL();
if(sigData.length<1000){alert("Signature obligatoire");return;}

const input=document.createElement("input");
input.type="file";
input.accept="image/*";
input.capture="environment";
input.onchange=async()=>{
const file=input.files[0];
if(!file){alert("Photo requise");return;}
const refPhoto=ref(storage,"deliveries/"+activeShipment.id+"/photo.jpg");
await uploadBytes(refPhoto,file);
const photoURL=await getDownloadURL(refPhoto);

await updateDoc(doc(db,"shipments",activeShipment.id),{
status:"delivered",
deliveryPhoto:photoURL,
receiverSignature:sigData,
deliveryLocation:{lat:lastLat,lng:lastLng,accuracy:lastAccuracy},
deliveredAt:serverTimestamp()
});
alert("Livraison confirmÃ©e");
};
input.click();
}
};

/* Offline detection */
window.addEventListener("offline",()=>alert("Mode hors ligne activÃ©"));
window.addEventListener("online",()=>alert("Connexion rÃ©tablie"));

/* PWA */
if("serviceWorker" in navigator){
navigator.serviceWorker.register("./sw.js");
}

</script>
</body>
</html>
