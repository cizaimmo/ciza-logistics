<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="#000000">

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<title>Ciza Driver</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
:root{
  --gold:#D4AF37;
  --black:#000;
  --bg:#f3f4f6;
  --card:#fff;
  --muted:#6b7280;
  --ok:#16a34a;
  --warn:#f59e0b;
  --bad:#dc2626;
  --blue:#2563eb;
  --purple:#7c3aed;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter;background:var(--bg);color:#111;}
.header{background:rgba(0,0,0,0.96);color:#fff;padding:14px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10}
.brand{color:var(--gold);font-weight:900;font-size:16px}
.driverName{font-size:12px;color:#e5e7eb;margin-top:4px}
.badge{padding:6px 12px;border-radius:999px;font-weight:900;font-size:12px;background:var(--ok);color:#fff}
.logout-btn{background:var(--gold);border:none;padding:7px 12px;border-radius:12px;font-weight:900;cursor:pointer}
.container{width:95%;max-width:1100px;margin:16px auto 80px auto}
.card{background:var(--card);border-radius:18px;padding:16px;margin:14px 0;box-shadow:0 12px 26px rgba(0,0,0,0.06)}
canvas{border:1px solid rgba(0,0,0,0.15);border-radius:14px;width:100%;height:160px;touch-action:none;background:#fff}
</style>
</head>

<body>

<div class="header">
  <div>
    <div class="brand">ðŸšš CizaLogistics Driver</div>
    <div class="driverName" id="driverName">Chargement...</div>
  </div>
  <button class="logout-btn" id="logoutBtn">DÃ©connexion</button>
</div>

<div class="container">
  <div class="card">
    <input type="text" id="otpInput" placeholder="Entrer OTP client">
    <input type="file" accept="image/*" capture="environment" id="photoInput">
    <canvas id="signatureCanvas"></canvas>
    <button id="mainActionBtn">Confirmer</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, doc, getDoc, updateDoc,
  serverTimestamp, setDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const app = initializeApp({
  apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
  authDomain:"ciza-logistics.firebaseapp.com",
  projectId:"ciza-logistics",
  storageBucket:"ciza-logistics.appspot.com"
});

const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

let selectedShipmentId = null;
let selectedShipment = null;

/* SHA256 */
async function sha256(str){
  const buffer = new TextEncoder().encode(str);
  const hashBuffer = await crypto.subtle.digest("SHA-256", buffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
}/* ACTION PRINCIPALE */
document.getElementById("mainActionBtn").onclick = async function(){

  if(!selectedShipmentId){
    alert("Aucun colis sÃ©lectionnÃ©");
    return;
  }

  const snap = await getDoc(doc(db,"shipments",selectedShipmentId));
  if(!snap.exists()) return;

  const data = snap.data() || {};
  const st = (data.status||"").toString();

  /* assigned â†’ picked_up */
  if(st==="assigned"){
    await updateDoc(doc(db,"shipments",selectedShipmentId),{
      status:"picked_up",
      pickedUpAt:serverTimestamp()
    });
    return;
  }

  /* picked_up â†’ in_transit (GEN OTP HASH) */
  if(st==="picked_up"){

    let patch = {
      status:"in_transit",
      transitAt:serverTimestamp()
    };

    if(!data.otpHash){

      const otp = Math.floor(1000 + Math.random()*9000).toString();
      const hash = await sha256(otp);

      await setDoc(
        doc(db,"shipments",selectedShipmentId,"private","security"),
        {
          otpCode: otp,
          otpGeneratedAt: serverTimestamp()
        }
      );

      patch.otpHash = hash;
      alert("OTP gÃ©nÃ©rÃ© et envoyÃ© au client.");
    }

    await updateDoc(doc(db,"shipments",selectedShipmentId), patch);
    return;
  }

  /* in_transit â†’ delivered */
  if(st==="in_transit"){

    const enteredOtp = (document.getElementById("otpInput").value || "").trim();

    if(!data.otpHash){
      alert("OTP non configurÃ©");
      return;
    }

    const enteredHash = await sha256(enteredOtp);

    if(enteredHash !== data.otpHash){
      alert("OTP incorrect");
      return;
    }

    const photo = document.getElementById("photoInput").files[0];
    if(!photo){
      alert("Photo obligatoire");
      return;
    }

    const photoRef = ref(storage, `deliveries/${selectedShipmentId}/photo.jpg`);
    await uploadBytes(photoRef, photo);
    const photoURL = await getDownloadURL(photoRef);

    await updateDoc(doc(db,"shipments",selectedShipmentId),{
      status:"delivered",
      deliveryPhoto:photoURL,
      deliveredAt:serverTimestamp()
    });

    alert("Livraison confirmÃ©e âœ…");
  }
};

onAuthStateChanged(auth, async(user)=>{
  if(!user){
    location.href="login.html";
    return;
  }
});

document.getElementById("logoutBtn").onclick = async()=>{
  await signOut(auth);
  location.href="login.html";
};

</script>
</body>
</html>
