<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

<meta name="theme-color" content="#000000">

<title>Ciza Driver</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
  margin:0;
  font-family:Inter;
  background:#f3f4f6;
}
.header{
  background:#000;
  color:#fff;
  padding:14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.brand{color:#D4AF37;font-weight:900}
.badge{
  padding:6px 12px;
  border-radius:999px;
  font-weight:700;
}
.online{background:#16a34a}
.card{
  background:#fff;
  margin:16px;
  padding:16px;
  border-radius:16px;
}
#map{height:260px;border-radius:16px;margin-top:10px}
.btn{
  width:100%;
  padding:14px;
  border:none;
  border-radius:14px;
  font-weight:900;
  margin-top:10px;
}
.gold{background:#D4AF37}
.dark{background:#111;color:#fff}
</style>
</head>

<body>

<div class="header">
  <div class="brand">ðŸšš Ciza Driver</div>
  <div>
    <span class="badge online">En ligne</span>
    <button id="logoutBtn" class="btn gold" style="width:auto;margin-left:10px;">DÃ©connexion</button>
  </div>
</div>

<div class="card">
  <h2>Livraison active</h2>
  <div id="activeShipmentInfo">Aucune</div>
  <div id="etaInfo"></div>
  <div id="map"></div>
</div>

<div class="card">
  <button id="scanBtn" class="btn dark">ðŸ“· Scanner colis</button>
</div>

<div id="stickyAction" style="display:none;padding:16px;">
  <button id="mainActionBtn" class="btn gold">Action</button>
</div>

<div id="reader" style="width:100%;display:none;"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, updateDoc,
  collection, query, where, onSnapshot,
  serverTimestamp, getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

import {
  getAuth, onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
  getStorage, ref, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const app = initializeApp({
  apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
  authDomain:"ciza-logistics.firebaseapp.com",
  projectId:"ciza-logistics",
  storageBucket:"ciza-logistics.appspot.com"
});

const db=getFirestore(app);
const auth=getAuth(app);
const storage=getStorage(app);

let currentUser=null;
let activeShipment=null;
let driverMarker=null;
let destinationMarker=null;
let driverSpeed=0;

/* MAP */

let map=L.map('map').setView([-3.3731,29.9189],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

/* AUTH */

onAuthStateChanged(auth, async(user)=>{
  if(!user){
    window.location.href="./login.html";
    return;
  }

  const snap=await getDoc(doc(db,"users",user.uid));
  if(!snap.exists() || snap.data().role!=="driver"){
    await signOut(auth);
    window.location.href="./login.html";
    return;
  }

  currentUser=user;
  startGPS();
  startShipmentListener();
});

/* GPS */

function startGPS(){
  navigator.geolocation.watchPosition(async(pos)=>{
    driverSpeed=pos.coords.speed||0;

    if(driverMarker){
      driverMarker.setLatLng([pos.coords.latitude,pos.coords.longitude]);
    }else{
      driverMarker=L.marker([pos.coords.latitude,pos.coords.longitude]).addTo(map);
    }

    updateETA();

  },{enableHighAccuracy:true});
}

/* LISTENER ASSIGNATION */

function startShipmentListener(){

  const q=query(
    collection(db,"shipments"),
    where("assignedDriverId","==",currentUser.uid)
  );

  onSnapshot(q,(snapshot)=>{
    let found=false;

    snapshot.forEach(docSnap=>{
      const s={id:docSnap.id,...docSnap.data()};

      if(s.status==="assigned" || s.status==="in_transit"){
        activeShipment=s;
        found=true;

        document.getElementById("activeShipmentInfo").textContent=
          s.trackingCode||s.id;

        if(s.toLat && s.toLng){
          if(destinationMarker){
            destinationMarker.setLatLng([s.toLat,s.toLng]);
          }else{
            destinationMarker=L.marker([s.toLat,s.toLng]).addTo(map);
          }
        }

        document.getElementById("stickyAction").style.display="block";
        document.getElementById("mainActionBtn").textContent=
          s.status==="assigned"?
          "ðŸš€ DÃ©marrer livraison":
          "ðŸ“¦ Confirmer livraison";
      }
    });

    if(!found){
      document.getElementById("activeShipmentInfo").textContent="Aucune";
      document.getElementById("stickyAction").style.display="none";
      activeShipment=null;
    }
  });
}

/* SCAN */

let qrScanner=null;

document.getElementById("scanBtn").onclick=async()=>{
  document.getElementById("reader").style.display="block";

  qrScanner=new Html5Qrcode("reader");

  await qrScanner.start(
    {facingMode:"environment"},
    {fps:10,qrbox:250},
    async(text)=>{

      await qrScanner.stop();
      document.getElementById("reader").style.display="none";

      const snap=await getDoc(doc(db,"shipments",text));
      if(!snap.exists()){
        alert("Introuvable");
        return;
      }

      const s={id:snap.id,...snap.data()};

      if(s.assignedDriverId!==currentUser.uid){
        alert("Non assignÃ© Ã  vous.");
        return;
      }

      activeShipment=s;
      document.getElementById("activeShipmentInfo").textContent=s.id;
    }
  );
};

/* ACTION */

document.getElementById("mainActionBtn").onclick=async()=>{

  if(!activeShipment) return;

  if(activeShipment.status==="assigned"){
    await updateDoc(doc(db,"shipments",activeShipment.id),{
      status:"in_transit",
      inTransitAt:serverTimestamp()
    });
  }

  else if(activeShipment.status==="in_transit"){

    const file=await capturePhoto();
    const storageRef=ref(storage,"proofs/"+activeShipment.id+"/photo.jpg");

    await uploadBytes(storageRef,file);
    const url=await getDownloadURL(storageRef);

    await updateDoc(doc(db,"shipments",activeShipment.id),{
      status:"delivered",
      deliveredAt:serverTimestamp(),
      proofPhoto:url
    });

    alert("Livraison confirmÃ©e.");
  }
};

/* ETA */

function updateETA(){
  if(!activeShipment || !destinationMarker || !driverMarker) return;

  const lat1=driverMarker.getLatLng().lat;
  const lng1=driverMarker.getLatLng().lng;
  const lat2=destinationMarker.getLatLng().lat;
  const lng2=destinationMarker.getLatLng().lng;

  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lng2-lng1)*Math.PI/180;

  const a=Math.sin(dLat/2)**2+
    Math.cos(lat1*Math.PI/180)*
    Math.cos(lat2*Math.PI/180)*
    Math.sin(dLon/2)**2;

  const distance=R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  const speedKmh=(driverSpeed||10)*3.6;
  const eta=speedKmh>0?(distance/speedKmh)*60:0;

  document.getElementById("etaInfo").innerHTML=
    `ðŸ“ ${distance.toFixed(2)} km â€¢ â± ${eta.toFixed(0)} min`;
}

/* PHOTO */

function capturePhoto(){
  return new Promise(resolve=>{
    const input=document.createElement("input");
    input.type="file";
    input.accept="image/*";
    input.capture="environment";
    input.onchange=()=>resolve(input.files[0]);
    input.click();
  });
}

/* LOGOUT */

document.getElementById("logoutBtn").onclick=async()=>{
  await signOut(auth);
  window.location.href="./login.html";
};

</script>

</body>
</html>
