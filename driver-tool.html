<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">

<link rel="manifest" href="../manifest.json">

<title>Ciza Driver</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
:root{
  --gold:#D4AF37;
  --black:#000;
  --green:#16a34a;
  --red:#dc2626;
}

*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:Inter,Arial;
  background:#f3f4f6;
  overflow-x:hidden;
}

.header{
  background:#000;
  color:#fff;
  padding:14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.brand{color:var(--gold);font-weight:900}

.badge{
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:800;
}

.online{background:var(--green)}
.offline{background:var(--red)}

.logout{
  background:var(--gold);
  border:none;
  padding:6px 10px;
  border-radius:10px;
  font-weight:900;
}

.main{padding:16px}

.card{
  background:#fff;
  padding:16px;
  border-radius:16px;
  margin-bottom:14px;
  box-shadow:0 6px 20px rgba(0,0,0,.05);
}

#map{
  height:280px;
  border-radius:16px;
  margin-top:10px;
}

.btn{
  width:100%;
  padding:14px;
  border:none;
  border-radius:14px;
  font-weight:900;
  margin-top:10px;
}

.gold{background:var(--gold)}
.dark{background:#111;color:#fff}

.section-title{font-weight:900;margin-bottom:8px}
</style>
</head>

<body>

<div class="header">
  <div class="brand">üöö Ciza Driver</div>
  <div style="display:flex;gap:8px;align-items:center;">
    <div id="onlineBadge" class="badge online">üü¢ En ligne</div>
    <button id="logoutBtn" class="logout">D√©connexion</button>
  </div>
</div>

<div class="main">

  <div class="card">
    <div class="section-title">Statut</div>
    <button id="toggleOnline" class="btn gold">Se mettre hors ligne</button>
    <div id="driverInfo"></div>
  </div>

  <div class="card">
    <div class="section-title">Livraison active</div>
    <div id="activeShipmentInfo">Aucune</div>
    <div id="map"></div>
  </div>

  <div id="shipmentsContainer"></div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore,
  doc,
  getDoc,
  updateDoc,
  setDoc,
  deleteDoc,
  collection,
  query,
  where,
  onSnapshot,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* FIREBASE */

const app = initializeApp({
  apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
  authDomain:"ciza-logistics.firebaseapp.com",
  projectId:"ciza-logistics"
});

const db=getFirestore(app);
const auth=getAuth(app);

let currentUser=null;
let driverData=null;
let watchId=null;
let activeShipment=null;

/* MAP */

let map=L.map('map').setView([-3.3731,29.9189],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19
}).addTo(map);

let driverMarker=null;
let destinationMarker=null;

/* AUTH GUARD */

onAuthStateChanged(auth,async(user)=>{
  if(!user){
    location.replace("../login.html");
    return;
  }

  const snap=await getDoc(doc(db,"users",user.uid));
  if(!snap.exists() || snap.data().role!=="driver"){
    await signOut(auth);
    location.replace("../login.html");
    return;
  }

  currentUser=user;
  driverData=snap.data();

  document.getElementById("driverInfo").textContent=
    driverData.fullName+" ‚Ä¢ "+(driverData.province||"");

  startShipmentsListener();
});

/* ONLINE TOGGLE */

const toggleBtn=document.getElementById("toggleOnline");

toggleBtn.addEventListener("click",async()=>{
  const newStatus=driverData.onlineStatus==="online"?"offline":"online";

  await updateDoc(doc(db,"users",currentUser.uid),{
    onlineStatus:newStatus
  });

  driverData.onlineStatus=newStatus;
  updateOnlineUI();
});

function updateOnlineUI(){
  const badge=document.getElementById("onlineBadge");

  if(driverData.onlineStatus==="online"){
    badge.className="badge online";
    badge.textContent="üü¢ En ligne";
    toggleBtn.textContent="Se mettre hors ligne";
    startGPS();
  }else{
    badge.className="badge offline";
    badge.textContent="üî¥ Hors ligne";
    toggleBtn.textContent="Revenir en ligne";
    stopGPS();
  }
}

/* GPS LIVE */

function startGPS(){
  if(watchId) return;

  watchId=navigator.geolocation.watchPosition(async(pos)=>{
    const {latitude,longitude,speed}=pos.coords;

    await setDoc(doc(db,"driversLive",currentUser.uid),{
      driverUid:currentUser.uid,
      fullName:driverData.fullName,
      lat:latitude,
      lng:longitude,
      speed:speed||0,
      status:"online",
      lastUpdate:serverTimestamp()
    });

    if(driverMarker){
      driverMarker.setLatLng([latitude,longitude]);
    }else{
      driverMarker=L.marker([latitude,longitude]).addTo(map);
    }

  },{
    enableHighAccuracy:true
  });
}

function stopGPS(){
  if(watchId){
    navigator.geolocation.clearWatch(watchId);
    watchId=null;
  }
}

/* FIFO SHIPMENTS */

function startShipmentsListener(){

  const q=query(
    collection(db,"shipments"),
    where("assignedDriverId","==",currentUser.uid)
  );

  onSnapshot(q,(snap)=>{

    let shipments=[];

    snap.forEach(docSnap=>{
      shipments.push({id:docSnap.id,...docSnap.data()});
    });

    shipments.sort((a,b)=>{
      const aa=a.assignedAt?.seconds||0;
      const bb=b.assignedAt?.seconds||0;
      return aa-bb;
    });

    renderShipments(shipments);
  });
}

function renderShipments(list){

  const container=document.getElementById("shipmentsContainer");
  container.innerHTML="";

  list.forEach(s=>{

    const card=document.createElement("div");
    card.className="card";

    card.innerHTML=`
      <div class="section-title">${s.trackingCode}</div>
      <div>Statut : ${s.status}</div>
      <button class="btn gold" data-id="${s.id}">
        Ouvrir
      </button>
    `;

    card.querySelector("button").addEventListener("click",()=>{
      openShipment(s);
    });

    container.appendChild(card);
  });
}

function openShipment(s){
  activeShipment=s;

  document.getElementById("activeShipmentInfo").textContent=
    s.trackingCode+" ‚Ä¢ "+s.status;

  if(s.toLat && s.toLng){
    if(destinationMarker){
      destinationMarker.setLatLng([s.toLat,s.toLng]);
    }else{
      destinationMarker=L.marker([s.toLat,s.toLng]).addTo(map);
    }

    map.setView([s.toLat,s.toLng],14);
  }
}

/* LOGOUT */

document.getElementById("logoutBtn")
.addEventListener("click",async()=>{
  await signOut(auth);
  location.replace("../login.html");
});
/* ================= SCAN + OTP + SIGNATURE + DELIVERY ================= */

let qrScanner=null;
let scanCooldown=3000;
let lastScanTime=0;

/* UI injection (scan + sticky + signature overlay) */

const scanUI=`
<div class="card">
  <div class="section-title">Scanner colis</div>
  <button id="scanBtn" class="btn dark">üì∑ Scanner QR</button>
  <div id="readerWrapper" style="display:none;margin-top:10px;">
    <div id="reader" style="width:100%;border-radius:16px;overflow:hidden;"></div>
  </div>
  <div id="scanResult" style="margin-top:10px;font-size:13px;"></div>
</div>

<div id="stickyAction" style="
position:fixed;
bottom:0;
left:0;
right:0;
padding:16px;
background:#000;
display:none;
z-index:999;">
  <button id="mainActionBtn" style="
  width:100%;
  padding:16px;
  font-weight:900;
  border:none;
  border-radius:14px;
  background:#D4AF37;">
  üöÄ Action
  </button>
</div>

<div id="signatureOverlay" style="
position:fixed;
inset:0;
background:#000;
display:none;
flex-direction:column;
justify-content:center;
align-items:center;
z-index:2000;">
  <div style="color:#fff;font-weight:800;margin-bottom:10px;">
    ‚úçÔ∏è Signature du client<br>
    <span style="font-weight:400;font-size:13px;">
      Merci pour votre confiance
    </span>
  </div>
  <canvas id="signatureCanvas"
    style="width:95%;height:220px;background:#fff;border-radius:12px;"></canvas>
  <div style="margin-top:15px;display:flex;gap:10px;">
    <button id="clearSign" class="btn dark">Effacer</button>
    <button id="validateSign" class="btn gold">Valider</button>
  </div>
</div>
`;

document.querySelector(".main").insertAdjacentHTML("beforeend",scanUI);

/* ================= QR SCAN ================= */

document.getElementById("scanBtn").addEventListener("click",async()=>{

  const wrapper=document.getElementById("readerWrapper");

  if(qrScanner){
    await qrScanner.stop();
    await qrScanner.clear();
    qrScanner=null;
    wrapper.style.display="none";
    return;
  }

  wrapper.style.display="block";
  qrScanner=new Html5Qrcode("reader");

  await qrScanner.start(
    {facingMode:"environment"},
    {fps:10,qrbox:250},
    onScanSuccess
  );
});

async function onScanSuccess(decodedText){

  const now=Date.now();
  if(now-lastScanTime<scanCooldown) return;
  lastScanTime=now;

  await qrScanner.stop();
  await qrScanner.clear();
  qrScanner=null;
  document.getElementById("readerWrapper").style.display="none";

  const q=query(
    collection(db,"shipments"),
    where("trackingCode","==",decodedText)
  );

  const snap=await getDocs(q);

  if(snap.empty){
    alert("Tracking introuvable.");
    return;
  }

  const docSnap=snap.docs[0];
  const shipment={id:docSnap.id,...docSnap.data()};

  if(shipment.assignedDriverId!==currentUser.uid){
    alert("Colis non assign√© √† vous.");
    return;
  }

  activeShipment=shipment;

  document.getElementById("scanResult").innerHTML=
    "‚úÖ "+shipment.trackingCode;

  showSticky();
}

/* ================= STICKY ACTION ================= */

function showSticky(){
  const sticky=document.getElementById("stickyAction");
  const btn=document.getElementById("mainActionBtn");

  sticky.style.display="block";

  if(activeShipment.status==="assigned"){
    btn.textContent="üöÄ D√©marrer livraison";
  }
  else if(activeShipment.status==="in_transit"){
    btn.textContent="üîê Confirmer livraison";
  }
}

document.getElementById("mainActionBtn")
.addEventListener("click",async()=>{

  if(!activeShipment) return;

  if(activeShipment.status==="assigned"){
    await updateDoc(doc(db,"shipments",activeShipment.id),{
      status:"in_transit",
      inTransitAt:serverTimestamp()
    });
    activeShipment.status="in_transit";
    alert("Livraison d√©marr√©e.");
    showSticky();
  }
  else if(activeShipment.status==="in_transit"){
    verifyDistanceAndOTP();
  }
});

/* ================= DISTANCE < 200m ================= */

function distanceKm(lat1,lon1,lat2,lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=
    Math.sin(dLat/2)*Math.sin(dLat/2)+
    Math.cos(lat1*Math.PI/180)*
    Math.cos(lat2*Math.PI/180)*
    Math.sin(dLon/2)*Math.sin(dLon/2);
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function verifyDistanceAndOTP(){

  navigator.geolocation.getCurrentPosition(async(pos)=>{

    const d=distanceKm(
      pos.coords.latitude,
      pos.coords.longitude,
      activeShipment.toLat,
      activeShipment.toLng
    );

    if(d>0.2){
      alert("Vous devez √™tre √† moins de 200m.");
      return;
    }

    verifyOTP();

  });
}

/* ================= OTP ================= */

let otpAttempts=0;

function verifyOTP(){

  if(activeShipment.otpLocked){
    alert("OTP verrouill√©.");
    return;
  }

  const code=prompt("Entrez le code client");

  if(code!==activeShipment.otpCode){
    otpAttempts++;
    if(otpAttempts>=3){
      updateDoc(doc(db,"shipments",activeShipment.id),{
        otpLocked:true
      });
      alert("OTP verrouill√©.");
    }else{
      alert("Code incorrect.");
    }
    return;
  }

  openSignature();
}

/* ================= SIGNATURE ================= */

function openSignature(){

  const overlay=document.getElementById("signatureOverlay");
  const canvas=document.getElementById("signatureCanvas");
  const ctx=canvas.getContext("2d");

  overlay.style.display="flex";
  canvas.width=canvas.offsetWidth;
  canvas.height=canvas.offsetHeight;

  ctx.fillStyle="#fff";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  let drawing=false;

  canvas.onmousedown=e=>{
    drawing=true;
    ctx.beginPath();
    ctx.moveTo(e.offsetX,e.offsetY);
  };

  canvas.onmousemove=e=>{
    if(!drawing) return;
    ctx.lineTo(e.offsetX,e.offsetY);
    ctx.stroke();
  };

  canvas.onmouseup=()=>drawing=false;

  canvas.ontouchstart=e=>{
    drawing=true;
    const rect=canvas.getBoundingClientRect();
    const x=e.touches[0].clientX-rect.left;
    const y=e.touches[0].clientY-rect.top;
    ctx.beginPath();
    ctx.moveTo(x,y);
  };

  canvas.ontouchmove=e=>{
    if(!drawing) return;
    e.preventDefault();
    const rect=canvas.getBoundingClientRect();
    const x=e.touches[0].clientX-rect.left;
    const y=e.touches[0].clientY-rect.top;
    ctx.lineTo(x,y);
    ctx.stroke();
  };

  canvas.ontouchend=()=>drawing=false;

  document.getElementById("clearSign").onclick=()=>{
    ctx.fillRect(0,0,canvas.width,canvas.height);
  };

  document.getElementById("validateSign").onclick=async()=>{

    const signature=canvas.toDataURL("image/png");

    await updateDoc(doc(db,"shipments",activeShipment.id),{
      status:"delivered",
      deliveredAt:serverTimestamp(),
      deliveredBy:currentUser.uid,
      proofSignatureBase64:signature
    });

    overlay.style.display="none";
    document.getElementById("stickyAction").style.display="none";

    alert("Livraison confirm√©e.");
  };
}
</script>

</body>
</html>
