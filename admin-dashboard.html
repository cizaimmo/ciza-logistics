<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard | Ciza Logistics</title>

<style>
body{font-family:Arial;background:#0f0f10;color:#fff;margin:0;}
header{background:#000;padding:20px;text-align:center;}
header img{height:80px;}
.container{width:95%;max-width:1200px;margin:30px auto;}
.card{
background:#000;
padding:20px;
border-radius:16px;
margin-bottom:20px;
border:1px solid rgba(212,175,55,0.3);
}
select,button{
padding:10px;
margin-top:10px;
border-radius:10px;
border:none;
}
button{
background:#D4AF37;
font-weight:bold;
cursor:pointer;
}
</style>
</head>

<body>

<header>
<img src="https://raw.githubusercontent.com/cizaimmo/ciza-logistics/4b1ea6a2d3697e3982880984ee31dca42d8c52fc/logo.png">
<h2>Admin – Assignation Chauffeurs</h2>
</header>

<div class="container">

<h3>Colis à assigner</h3>
<div id="shipmentsList"></div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, getDocs, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
authDomain:"ciza-logistics.firebaseapp.com",
projectId:"ciza-logistics"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let drivers=[];

onAuthStateChanged(auth,async(user)=>{

if(!user){location.href="/login.html";return;}

const usersSnap=await getDocs(collection(db,"users"));
usersSnap.forEach(d=>{
const data=d.data();
if(data.role==="driver" && data.accountStatus==="approved"){
drivers.push({id:d.id,name:data.fullName});
}
});

loadShipments();

});

async function loadShipments(){

const snap=await getDocs(collection(db,"shipments"));
const container=document.getElementById("shipmentsList");
container.innerHTML="";

snap.forEach(docSnap=>{
const data=docSnap.data();

if(data.status==="delivered") return;

const div=document.createElement("div");
div.className="card";

let driverOptions="";
drivers.forEach(d=>{
driverOptions+=`<option value="${d.id}">${d.name}</option>`;
});

div.innerHTML=`
<strong>${data.trackingCode}</strong><br>
Status: ${data.status}<br>

<select id="driver-${docSnap.id}">
${driverOptions}
</select>

<button onclick="assignDriver('${docSnap.id}')">
Assigner
</button>
`;

container.appendChild(div);

});

}

window.assignDriver=async function(shipmentId){

const select=document.getElementById("driver-"+shipmentId);
const driverId=select.value;

await updateDoc(doc(db,"shipments",shipmentId),{
assignedDriverId:driverId,
status:"assigned",
assignedAt:serverTimestamp()
});

alert("Driver assigné !");
loadShipments();

};

</script>

</body>
</html>
