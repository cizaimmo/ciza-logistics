<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Ciza Driver">

<link rel="manifest" href="../manifest.json">

<title>Ciza Driver</title>

<style>
:root{
  --black:#000;
  --gold:#D4AF37;
  --green:#16a34a;
  --red:#dc2626;
  --card:#ffffff;
}

*{box-sizing:border-box;margin:0;padding:0}

html,body{
  height:100%;
  background:#f3f4f6;
  font-family:Inter,Arial;
  overscroll-behavior:none;
  touch-action:manipulation;
}

body{
  padding-bottom:env(safe-area-inset-bottom);
}

.app{
  display:flex;
  flex-direction:column;
  height:100vh;
}

/* HEADER */
.header{
  background:#000;
  color:#fff;
  padding:14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.brand{
  font-weight:900;
  color:var(--gold);
  font-size:16px;
}

.badges{
  display:flex;
  gap:8px;
  align-items:center;
}

.badge{
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  font-weight:800;
}

.online{ background:var(--green); color:#fff;}
.offline{ background:var(--red); color:#fff;}
.browser{ background:#374151;color:#fff;}
.appmode{ background:#111827;color:#fff;}

.logout{
  background:var(--gold);
  border:none;
  padding:6px 10px;
  border-radius:10px;
  font-weight:900;
  cursor:pointer;
}

/* MAIN */
.main{
  flex:1;
  padding:16px;
  overflow-y:auto;
}

.card{
  background:var(--card);
  padding:16px;
  border-radius:16px;
  margin-bottom:14px;
  box-shadow:0 6px 20px rgba(0,0,0,.05);
}

.toggle-btn{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:none;
  font-weight:900;
  font-size:14px;
  cursor:pointer;
}

.btn-online{
  background:var(--gold);
}

.btn-offline{
  background:#111;
  color:#fff;
}
</style>
</head>

<body>
<div class="app">

<div class="header">
  <div class="brand">üöö Ciza Driver</div>
  <div class="badges">
    <div id="connectionBadge" class="badge online">üü¢ En ligne</div>
    <div id="modeBadge" class="badge browser">üåê Browser</div>
    <button class="logout" id="logoutBtn">D√©connexion</button>
  </div>
</div>

<div class="main">

  <div class="card">
    <h3 style="margin-bottom:8px">Statut Chauffeur</h3>
    <button id="toggleOnline" class="toggle-btn btn-online">
      ‚è∏ Se mettre hors ligne
    </button>
  </div>

  <div class="card">
    <h3>Dashboard (Base)</h3>
    <p id="driverName">Chargement...</p>
    <p id="driverStatus"></p>
  </div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  updateDoc,
  deleteDoc,
  setDoc,
  serverTimestamp,
  collection,
  query,
  where,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ================= FIREBASE ================= */
const app = initializeApp({
  apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
  authDomain:"ciza-logistics.firebaseapp.com",
  projectId:"ciza-logistics"
});

const auth = getAuth(app);
const db = getFirestore(app);

let currentUser=null;
let driverData=null;
let activeShipments=[];
let watchId=null;

/* ================= HELPERS ================= */
function distanceKm(lat1, lon1, lat2, lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+
          Math.cos(lat1*Math.PI/180)*
          Math.cos(lat2*Math.PI/180)*
          Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* ================= AUTH GUARD ================= */
onAuthStateChanged(auth, async(user)=>{
  if(!user){
    location.replace("../login.html");
    return;
  }

  currentUser=user;

  const snap=await getDoc(doc(db,"users",user.uid));
  if(!snap.exists() || snap.data().role!=="driver"){
    await signOut(auth);
    location.replace("../login.html");
    return;
  }

  driverData=snap.data();
  document.getElementById("driverName").textContent =
    driverData.fullName || driverData.email;

  startRealtimeShipments();
  updateDriverStatusUI();
});

/* ================= REALTIME FIFO ================= */
function startRealtimeShipments(){
  const q=query(
    collection(db,"shipments"),
    where("assignedDriverId","==",currentUser.uid)
  );

  onSnapshot(q,(snap)=>{
    activeShipments=[];
    snap.forEach(doc=>{
      activeShipments.push({id:doc.id,...doc.data()});
    });

    // FIFO tri par assignedAt asc
    activeShipments.sort((a,b)=>{
      const aa=a.assignedAt?.seconds||0;
      const bb=b.assignedAt?.seconds||0;
      return aa-bb;
    });

    renderShipments();
  });
}

/* ================= RENDER FIFO ================= */
function renderShipments(){
  const container=document.querySelector(".main");
  container.querySelectorAll(".shipment-card").forEach(el=>el.remove());

  activeShipments.forEach(s=>{
    const card=document.createElement("div");
    card.className="card shipment-card";

    card.innerHTML=`
      <h4>${s.id}</h4>
      <p>${s.toProvince || ""} ‚Ä¢ ${s.toQuartier || ""}</p>
      <p>Status: ${s.status}</p>
      <button data-id="${s.id}" class="startBtn toggle-btn btn-online">
        üöÄ D√©marrer
      </button>
    `;

    container.appendChild(card);
  });

  document.querySelectorAll(".startBtn").forEach(btn=>{
    btn.addEventListener("click",handleStart);
  });
}

/* ================= MULTI-ZONE 3KM GUARD ================= */
async function handleStart(e){
  const id=e.target.dataset.id;
  const shipment=activeShipments.find(s=>s.id===id);
  if(!shipment) return;

  if(driverData.onlineStatus!=="online"){
    alert("Vous √™tes hors ligne.");
    return;
  }

  // V√©rifier si autre colis en transit
  const inTransit=activeShipments.filter(s=>s.status==="in_transit");

  if(inTransit.length>0){
    const ref=inTransit[0];

    if(!shipment.toLat || !shipment.toLng ||
       !ref.toLat || !ref.toLng){
      alert("Coordonn√©es manquantes.");
      return;
    }

    const d=distanceKm(
      ref.toLat,ref.toLng,
      shipment.toLat,shipment.toLng
    );

    if(d>3){
      alert("Zone diff√©rente (>3km). Terminez d'abord la livraison active.");
      return;
    }
  }

  await updateDoc(doc(db,"shipments",id),{
    status:"in_transit",
    inTransitAt:serverTimestamp()
  });

  alert("Livraison d√©marr√©e.");
}

/* ================= ONLINE / OFFLINE ================= */
const toggleBtn=document.getElementById("toggleOnline");

function updateDriverStatusUI(){
  const status=driverData.onlineStatus || "offline";
  document.getElementById("driverStatus").textContent =
    "Statut : " + status;

  if(status==="online"){
    startGPS();
    toggleBtn.textContent="‚è∏ Se mettre hors ligne";
  }else{
    stopGPS();
    toggleBtn.textContent="‚ñ∂ Revenir en ligne";
  }
}

toggleBtn.addEventListener("click",async ()=>{
  const newStatus=driverData.onlineStatus==="online"?"offline":"online";

  await updateDoc(doc(db,"users",currentUser.uid),{
    onlineStatus:newStatus,
    lastOnlineAt:serverTimestamp()
  });

  driverData.onlineStatus=newStatus;
  updateDriverStatusUI();
});

/* ================= GPS LIVE ================= */
function startGPS(){
  if(watchId) return;

  watchId=navigator.geolocation.watchPosition(async(pos)=>{
    const {latitude,longitude}=pos.coords;

    await setDoc(doc(db,"driversLive",currentUser.uid),{
      uid:currentUser.uid,
      fullName:driverData.fullName||"",
      lat:latitude,
      lng:longitude,
      updatedAt:serverTimestamp()
    });

  },err=>{
    console.log(err);
  },{
    enableHighAccuracy:true,
    maximumAge:5000,
    timeout:10000
  });
}

function stopGPS(){
  if(watchId){
    navigator.geolocation.clearWatch(watchId);
    watchId=null;
  }
}

/* ================= LOGOUT ================= */
document.getElementById("logoutBtn").addEventListener("click",async()=>{
  await signOut(auth);
  location.replace("../login.html");
});

/* ================= SERVICE WORKER ================= */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("../sw.js");
}
</script>/* ================= SCAN QR (JSON s√©curis√©) ================= */

let selectedShipment=null;
let otpAttempts={};
let otpLockedUntil={};

document.getElementById("scanBtn").addEventListener("click", async ()=>{
  const code=prompt("Collez le QR JSON (simulation scan)");
  if(!code) return;

  try{
    const data=JSON.parse(code);

    if(!data.id){
      alert("QR invalide.");
      return;
    }

    const snap=await getDoc(doc(db,"shipments",data.id));
    if(!snap.exists()){
      alert("Colis introuvable.");
      return;
    }

    const shipment=snap.data();

    if(shipment.assignedDriverId!==currentUser.uid){
      alert("Colis non assign√© √† vous.");
      return;
    }

    if(shipment.status==="delivered"){
      alert("D√©j√† livr√©.");
      return;
    }

    selectedShipment={id:data.id,...shipment};

    document.getElementById("scanResult").innerHTML=
      `Colis s√©lectionn√© : ${data.id}`;

    showStickyAction();

  }catch(e){
    alert("QR invalide.");
  }
});

/* ================= STICKY DYNAMIQUE ================= */

function showStickyAction(){
  const sticky=document.getElementById("stickyAction");
  const btn=document.getElementById("mainActionBtn");

  sticky.style.display="block";

  if(selectedShipment.status==="assigned"){
    btn.textContent="üöÄ D√âMARRER LIVRAISON";
    btn.style.background="#D4AF37";
  }
  else if(selectedShipment.status==="in_transit"){
    btn.textContent="üîê CONFIRMER LIVRAISON";
    btn.style.background="#16a34a";
  }
}

document.getElementById("mainActionBtn").addEventListener("click",async ()=>{
  if(!selectedShipment) return;

  const btn=document.getElementById("mainActionBtn");
  btn.disabled=true;

  if(selectedShipment.status==="assigned"){
    await updateDoc(doc(db,"shipments",selectedShipment.id),{
      status:"in_transit",
      inTransitAt:serverTimestamp()
    });
    alert("Livraison d√©marr√©e.");
  }

  else if(selectedShipment.status==="in_transit"){
    await confirmDelivery();
  }

  btn.disabled=false;
});

/* ================= CONFIRM DELIVERY ================= */

async function confirmDelivery(){

  if(!navigator.geolocation){
    alert("GPS requis.");
    return;
  }

  navigator.geolocation.getCurrentPosition(async(pos)=>{
    const {latitude,longitude}=pos.coords;

    if(!selectedShipment.toLat || !selectedShipment.toLng){
      alert("Coordonn√©es destination manquantes.");
      return;
    }

    const d=distanceKm(
      latitude,longitude,
      selectedShipment.toLat,
      selectedShipment.toLng
    );

    if(d>0.2){
      alert("Vous devez √™tre √† moins de 200m.");
      return;
    }

    await handleOTP(latitude,longitude);

  },()=>{
    alert("Impossible d'obtenir GPS.");
  });
}

/* ================= OTP ================= */

async function handleOTP(lat,lng){

  const now=Date.now();

  if(otpLockedUntil[selectedShipment.id] &&
     now<otpLockedUntil[selectedShipment.id]){
    alert("Trop de tentatives. Attendez 2 minutes.");
    return;
  }

  const code=prompt("Entrez le code client");

  if(code!==selectedShipment.otp){
    otpAttempts[selectedShipment.id]=(otpAttempts[selectedShipment.id]||0)+1;

    if(otpAttempts[selectedShipment.id]>=3){
      otpLockedUntil[selectedShipment.id]=now+120000;
      alert("3 erreurs. Blocage 2 minutes.");
    }else{
      alert("Code incorrect.");
    }
    return;
  }

  await handleProof(lat,lng);
}

/* ================= PHOTO + SIGNATURE ================= */

async function handleProof(lat,lng){

  const fileInput=document.createElement("input");
  fileInput.type="file";
  fileInput.accept="image/*";

  fileInput.onchange=async ()=>{
    const file=fileInput.files[0];
    if(!file) return;

    if(file.size>10*1024*1024){
      alert("Photo >10MB interdite.");
      return;
    }

    // Signature plein √©cran simplifi√©e
    const signature=prompt("Tapez 'SIGN√â' pour simuler signature");

    if(signature!=="SIGN√â"){
      alert("Signature obligatoire.");
      return;
    }

    await updateDoc(doc(db,"shipments",selectedShipment.id),{
      status:"delivered",
      deliveredAt:serverTimestamp(),
      deliveredLat:lat,
      deliveredLng:lng,
      deliveredBy:currentUser.uid
    });

    alert("Livraison confirm√©e.");

    document.getElementById("stickyAction").style.display="none";
  };

  fileInput.click();
}</script>
</body>
</html>
       
