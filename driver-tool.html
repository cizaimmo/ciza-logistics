<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Outil Chauffeur | Ciza Logistics</title>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:Arial,Helvetica,sans-serif;background:#f4f6f9;color:#111;}
.container{width:95%;max-width:1200px;margin:auto;}

header{background:#000;color:#fff;padding:18px;text-align:center;}
header img{height:70px;}
header h1{font-size:18px;margin-top:8px;color:#D4AF37;}

.top-info{
margin-top:15px;
background:#000;
color:#fff;
padding:15px;
border-radius:14px;
display:flex;
justify-content:space-between;
align-items:center;
flex-wrap:wrap;
}

.badge{padding:6px 12px;border-radius:999px;font-size:12px;font-weight:900;background:#2e7d32;}
.logout{background:#D4AF37;border:none;padding:8px 14px;border-radius:10px;font-weight:bold;cursor:pointer;}

.section{margin-top:20px;background:#fff;padding:20px;border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,0.05);}
.section h2{font-size:16px;margin-bottom:15px;color:#D4AF37;}

.shipment-card{border:1px solid rgba(212,175,55,0.3);padding:15px;border-radius:14px;margin-bottom:15px;}

.timeline{font-size:11px;color:#777;margin-top:6px;line-height:1.6;}

button{width:100%;padding:12px;border-radius:12px;border:none;background:#000;color:#fff;font-weight:900;cursor:pointer;margin-top:6px;}
button.gold{background:#D4AF37;color:#000;}

.footer{background:#000;color:#fff;padding:40px 0;text-align:center;margin-top:40px;font-size:12px;}
.footer strong{color:#D4AF37;}

video{width:100%;border-radius:12px;margin-top:10px;}
canvas{border:1px solid #ccc;border-radius:12px;width:100%;height:150px;margin-top:10px;}

.counter{font-weight:900;color:#2e7d32;margin-bottom:10px;}
</style>
</head>

<body>

<header>
<img src="https://raw.githubusercontent.com/cizaimmo/ciza-logistics/4b1ea6a2d3697e3982880984ee31dca42d8c52fc/logo.png">
<h1>Outil Chauffeur</h1>
</header>

<div class="container">

<div class="top-info">
<div id="driverName">Chargement...</div>
<div>
<span class="badge">ValidÃ©</span>
<button class="logout" onclick="logout()">DÃ©connexion</button>
</div>
</div>

<div class="section">
<h2>ðŸŸ¡ Ã€ traiter</h2>
<div id="assignedList"></div>
</div>

<div class="section">
<h2>ðŸ”µ En transit</h2>
<div id="transitList"></div>
</div>

<div class="section">
<h2>ðŸŸ¢ LivrÃ©s aujourdâ€™hui</h2>
<div class="counter" id="deliveredCount">0 livraison</div>
<div id="deliveredList"></div>
</div>

<div class="section" id="deliverySection" style="display:none;">
<h2>Finaliser Livraison</h2>
<input type="text" id="otpInput" placeholder="Entrer OTP client">
<input type="file" accept="image/*" capture="environment" id="photoInput">
<canvas id="signatureCanvas"></canvas>
<button class="gold" onclick="clearSignature()">Effacer signature</button>
<button class="gold" onclick="completeDelivery()">Confirmer Livraison</button>
</div>

</div>

<div class="footer">
<strong>Ciza Logistics</strong><br>
Division de Ciza Group â€¢ Outil interne sÃ©curisÃ©
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, query, where, onSnapshot, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig={
apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
authDomain:"ciza-logistics.firebaseapp.com",
projectId:"ciza-logistics"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);
const storage=getStorage(app);

let currentUser=null;
let currentShipment=null;

onAuthStateChanged(auth,async(user)=>{
if(!user){location.href="login.html";return;}
currentUser=user;

const snap=await getDoc(doc(db,"users",user.uid));
const data=snap.data();
if(data.role!=="driver"||data.accountStatus!=="approved"){
alert("AccÃ¨s refusÃ©");
signOut(auth);
return;
}

document.getElementById("driverName").innerText=data.fullName;
loadShipments();
});

function formatDate(ts){
if(!ts) return "";
const d=ts.toDate();
return d.toLocaleDateString()+" "+d.toLocaleTimeString();
}

function isToday(ts){
if(!ts) return false;
const d=ts.toDate();
const now=new Date();
return d.getFullYear()===now.getFullYear() &&
d.getMonth()===now.getMonth() &&
d.getDate()===now.getDate();
}

function renderCard(d){

let callBtn="";
if(d.status==="assigned"||d.status==="picked_up"){
callBtn=`<a href="tel:${d.senderPhone||""}">ðŸ“ž ExpÃ©diteur</a>`;
}
if(d.status==="in_transit"){
callBtn=`<a href="tel:${d.receiverPhone||""}">ðŸ“ž Destinataire</a>`;
}

let timeline=`
<div class="timeline">
${d.assignedAt?"ðŸŸ¡ AssignÃ© : "+formatDate(d.assignedAt)+"<br>":""}
${d.pickedUpAt?"ðŸ”µ RamassÃ© : "+formatDate(d.pickedUpAt)+"<br>":""}
${d.transitAt?"ðŸŸ£ Transit : "+formatDate(d.transitAt)+"<br>":""}
${d.deliveredAt?"ðŸŸ¢ LivrÃ© : "+formatDate(d.deliveredAt)+"<br>":""}
</div>`;

return `
<div class="shipment-card">
<strong>${d.trackingCode}</strong><br>
${d.fromCity} â†’ ${d.toCity}<br>
${d.receiverName||""}
${timeline}
${callBtn}
${d.status!=="delivered" ? `<button onclick="nextStep('${d.id}')">Ã‰tape suivante</button>` : ""}
</div>
`;
}

function loadShipments(){
const q=query(collection(db,"shipments"),where("assignedDriverId","==",currentUser.uid));
onSnapshot(q,(snap)=>{

let assigned=[], transit=[], delivered=[];
snap.forEach(docSnap=>{
const d=docSnap.data();
d.id=docSnap.id;

if(d.status==="assigned"||d.status==="picked_up") assigned.push(d);
else if(d.status==="in_transit") transit.push(d);
else if(d.status==="delivered" && isToday(d.deliveredAt)) delivered.push(d);
});

document.getElementById("assignedList").innerHTML=assigned.map(renderCard).join("");
document.getElementById("transitList").innerHTML=transit.map(renderCard).join("");
document.getElementById("deliveredList").innerHTML=delivered.map(renderCard).join("");
document.getElementById("deliveredCount").innerText=delivered.length+" livraison(s)";
});
}

window.nextStep=async function(id){
const snap=await getDoc(doc(db,"shipments",id));
const d=snap.data();

if(d.status==="assigned"){
await updateDoc(doc(db,"shipments",id),{status:"picked_up",pickedUpAt:serverTimestamp()});
}
else if(d.status==="picked_up"){
await updateDoc(doc(db,"shipments",id),{status:"in_transit",transitAt:serverTimestamp()});
}
else if(d.status==="in_transit"){
currentShipment=id;
document.getElementById("deliverySection").style.display="block";
}
};

window.completeDelivery=async function(){
const snap=await getDoc(doc(db,"shipments",currentShipment));
const data=snap.data();

if(data.status!=="in_transit"){
alert("Colis non prÃªt");
return;
}

if(document.getElementById("otpInput").value!==data.deliveryOTP){
alert("OTP incorrect");
return;
}

const photo=document.getElementById("photoInput").files[0];
if(!photo){alert("Photo obligatoire");return;}

const photoRef=ref(storage,"deliveries/"+currentShipment+"/photo.jpg");
await uploadBytes(photoRef,photo);
const photoURL=await getDownloadURL(photoRef);

const canvas=document.getElementById("signatureCanvas");
const blob=await (await fetch(canvas.toDataURL())).blob();
const sigRef=ref(storage,"deliveries/"+currentShipment+"/signature.png");
await uploadBytes(sigRef,blob);
const sigURL=await getDownloadURL(sigRef);

await updateDoc(doc(db,"shipments",currentShipment),{
status:"delivered",
deliveryPhoto:photoURL,
receiverSignature:sigURL,
deliveredAt:serverTimestamp()
});

alert("Livraison confirmÃ©e");
document.getElementById("deliverySection").style.display="none";
};

window.logout=async function(){
await signOut(auth);
window.location.href="login.html";
};

const canvas=document.getElementById("signatureCanvas");
const ctx=canvas.getContext("2d");
let drawing=false;
canvas.addEventListener("mousedown",()=>drawing=true);
canvas.addEventListener("mouseup",()=>drawing=false);
canvas.addEventListener("mousemove",(e)=>{
if(!drawing)return;
ctx.lineWidth=2;
ctx.lineTo(e.offsetX,e.offsetY);
ctx.stroke();
});
window.clearSignature=function(){ctx.clearRect(0,0,canvas.width,canvas.height);};

</script>

</body>
</html>
