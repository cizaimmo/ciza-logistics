<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Parcel | Operations Complete</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:Arial;background:#f4f6f9;color:#111;}
.container{width:95%;max-width:1400px;margin:auto;}

header{background:#000;color:#fff;padding:20px;text-align:center;}
header h1{color:#D4AF37;}

.section{
margin-top:30px;
background:#fff;
padding:25px;
border-radius:18px;
box-shadow:0 10px 30px rgba(0,0,0,0.08);
}

.kpi-grid{
display:grid;
grid-template-columns:repeat(4,1fr);
gap:20px;
margin-bottom:30px;
}

.kpi-box{
background:#000;
color:#D4AF37;
padding:20px;
border-radius:16px;
text-align:center;
font-weight:900;
}

.parcel-card{
border:1px solid rgba(212,175,55,0.3);
padding:20px;
border-radius:16px;
margin-bottom:20px;
}

.status{
display:inline-block;
padding:6px 12px;
border-radius:999px;
background:#000;
color:#fff;
font-size:12px;
margin-bottom:15px;
}

select{
padding:8px;
border-radius:8px;
border:1px solid #ccc;
margin-top:8px;
}

button{
background:#D4AF37;
border:none;
padding:10px 15px;
border-radius:12px;
font-weight:900;
cursor:pointer;
margin-top:10px;
margin-right:5px;
}

@media(max-width:900px){
.kpi-grid{grid-template-columns:1fr;}
}
</style>
</head>

<body>

<header>
<h1>Admin Parcel – Operations Dashboard</h1>
</header>

<div class="container">

<div class="section">

<h2>KPI</h2>

<div class="kpi-grid">
<div class="kpi-box"><div id="kpiReady">0</div><small>Ready Pickup</small></div>
<div class="kpi-box"><div id="kpiAssigned">0</div><small>Assigned</small></div>
<div class="kpi-box"><div id="kpiTransit">0</div><small>In Transit</small></div>
<div class="kpi-box"><div id="kpiDelivered">0</div><small>Delivered</small></div>
</div>

<select id="statusFilter">
<option value="all">Tous</option>
<option value="ready_for_pickup">Ready Pickup</option>
<option value="assigned">Assigned</option>
<option value="in_transit">In Transit</option>
<option value="delivered">Delivered</option>
</select>

<div id="parcelList"></div>

</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, query, where, onSnapshot, doc, updateDoc, serverTimestamp, getDocs } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
authDomain:"ciza-logistics.firebaseapp.com",
projectId:"ciza-logistics"
});

const db = getFirestore(app);

let drivers = [];

async function loadDrivers(){
const snap = await getDocs(query(collection(db,"users"), where("role","==","driver")));
snap.forEach(d=>drivers.push({id:d.id,...d.data()}));
}

await loadDrivers();

const q = query(
collection(db,"shipments"),
where("service","==","parcel"),
where("paymentStatus","==","approved")
);

const filterEl = document.getElementById("statusFilter");

onSnapshot(q,(snap)=>{

let ready=0,assigned=0,transit=0,delivered=0;
let html="";

snap.forEach(docSnap=>{
const d=docSnap.data();
const id=docSnap.id;

if(d.status==="ready_for_pickup") ready++;
if(d.status==="assigned") assigned++;
if(d.status==="in_transit") transit++;
if(d.status==="delivered") delivered++;

if(filterEl.value!=="all" && d.status!==filterEl.value) return;

html+=`
<div class="parcel-card">

<strong>${id}</strong><br>
${d.fromCity} → ${d.toCity}<br>
Client: ${d.senderName}<br>

<div class="status">${d.status}</div>

${d.status==="ready_for_pickup" ? `
<select id="driver-${id}">
<option value="">Choisir chauffeur</option>
${drivers.map(driver=>`<option value="${driver.id}">${driver.name||driver.email}</option>`).join("")}
</select>
<button onclick="assignDriver('${id}')">Assigner</button>
`:""}

${d.status==="assigned" ? `
<button onclick="markTransit('${id}')">Marquer en transit</button>
`:""}

${d.status==="in_transit" ? `
<button onclick="markDelivered('${id}')">Confirmer livraison</button>
`:""}

</div>
`;
});

document.getElementById("parcelList").innerHTML=html;
document.getElementById("kpiReady").innerText=ready;
document.getElementById("kpiAssigned").innerText=assigned;
document.getElementById("kpiTransit").innerText=transit;
document.getElementById("kpiDelivered").innerText=delivered;

});

filterEl.addEventListener("change",()=>location.reload());

window.assignDriver = async function(id){

const driverId=document.getElementById("driver-"+id).value;
if(!driverId){alert("Choisir chauffeur");return;}

await updateDoc(doc(db,"shipments",id),{
status:"assigned",
assignedDriverId:driverId,
assignedAt:serverTimestamp()
});

alert("Chauffeur assigné");

};

window.markTransit = async function(id){

await updateDoc(doc(db,"shipments",id),{
status:"in_transit",
inTransitAt:serverTimestamp()
});

alert("Colis en transit");

};

window.markDelivered = async function(id){

await updateDoc(doc(db,"shipments",id),{
status:"delivered",
deliveredAt:serverTimestamp()
});

alert("Livraison confirmée");

};

</script>

</body>
</html>
