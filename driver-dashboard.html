<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Outil Chauffeur | Ciza Logistics</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:Arial,Helvetica,sans-serif;background:#f4f6f9;color:#111;}
.container{width:95%;max-width:1200px;margin:auto;}

header{
background:#000;
color:#fff;
padding:18px 0;
text-align:center;
}
header img{height:70px;}
header h1{font-size:18px;margin-top:8px;color:#D4AF37;}

.top-info{
margin-top:15px;
background:#000;
color:#fff;
padding:15px;
border-radius:14px;
display:flex;
justify-content:space-between;
align-items:center;
flex-wrap:wrap;
}

.badge{
padding:6px 12px;
border-radius:999px;
font-size:12px;
font-weight:900;
background:#2e7d32;
}

.section{
margin-top:20px;
background:#fff;
padding:20px;
border-radius:16px;
box-shadow:0 10px 25px rgba(0,0,0,0.05);
}

.section h2{
font-size:16px;
margin-bottom:15px;
color:#D4AF37;
}

.input-group{
margin-bottom:15px;
}

input,button{
width:100%;
padding:14px;
border-radius:12px;
border:1px solid #ddd;
font-size:15px;
}

button{
background:#000;
color:#fff;
font-weight:900;
cursor:pointer;
margin-top:8px;
}

button.gold{
background:#D4AF37;
color:#000;
}

.shipment-card{
border:1px solid rgba(212,175,55,0.3);
padding:15px;
border-radius:14px;
margin-bottom:15px;
}

.status{
font-size:12px;
font-weight:900;
margin-top:5px;
}

canvas{
border:1px solid #ccc;
border-radius:12px;
width:100%;
height:150px;
margin-top:10px;
}

.footer{
background:#000;
color:#fff;
padding:40px 0;
text-align:center;
margin-top:40px;
font-size:12px;
}

/* Responsive */
@media(min-width:768px){
.grid{
display:grid;
grid-template-columns:1fr 1fr;
gap:20px;
}
}
</style>
</head>

<body>

<header>
<img src="https://raw.githubusercontent.com/cizaimmo/ciza-logistics/4b1ea6a2d3697e3982880984ee31dca42d8c52fc/logo.png">
<h1>Outil Chauffeur</h1>
</header>

<div class="container">

<div class="top-info">
<div id="driverName">Chargement...</div>
<div class="badge" id="driverStatus">Validé</div>
</div>

<!-- SCAN / MANUAL -->
<div class="section">
<h2>Scanner / Recherche Tracking</h2>

<div class="input-group">
<input type="text" id="manualTracking" placeholder="Entrer tracking manuellement">
<button onclick="searchTracking()">Rechercher</button>
</div>

<button onclick="startCamera()">Scanner avec caméra</button>
<video id="video" style="width:100%;margin-top:10px;display:none;"></video>
</div>

<!-- COLIS ACTIFS -->
<div class="section">
<h2>Mes colis actifs</h2>
<div id="shipmentsList"></div>
</div>

<!-- LIVRAISON -->
<div class="section" id="deliverySection" style="display:none;">
<h2>Finaliser livraison</h2>

<input type="text" id="otpInput" placeholder="Entrer OTP client">

<input type="file" accept="image/*" capture="environment" id="photoInput">

<canvas id="signatureCanvas"></canvas>
<button class="gold" onclick="clearSignature()">Effacer signature</button>

<button class="gold" onclick="completeDelivery()">Confirmer Livraison</button>
</div>

</div>

<div class="footer">
Ciza Logistics – Outil interne sécurisé
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, query, where, onSnapshot, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
authDomain:"ciza-logistics.firebaseapp.com",
projectId:"ciza-logistics"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let currentUser;
let currentShipment=null;

onAuthStateChanged(auth,async(user)=>{
if(!user){location.href="login.html";return;}
currentUser=user;

const snap=await getDoc(doc(db,"users",user.uid));
const data=snap.data();

if(data.role!=="driver"||data.accountStatus!=="approved"){
alert("Accès refusé.");
signOut(auth);
return;
}

document.getElementById("driverName").innerText=data.fullName;
loadShipments();
});

function loadShipments(){
const q=query(collection(db,"shipments"),where("assignedDriverId","==",currentUser.uid));
onSnapshot(q,(snap)=>{
const list=document.getElementById("shipmentsList");
list.innerHTML="";
snap.forEach(docSnap=>{
const d=docSnap.data();
if(d.status==="delivered")return;

list.innerHTML+=`
<div class="shipment-card">
<strong>${d.trackingCode}</strong><br>
${d.fromCity} → ${d.toCity}
<div class="status">${d.status}</div>
<button onclick="updateStatus('${docSnap.id}','picked_up')">Ramassé</button>
<button onclick="goTransit('${docSnap.id}')">En transit</button>
<button onclick="prepareDelivery('${docSnap.id}')">Livrer</button>
</div>
`;
});
});
}

window.updateStatus=async(id,status)=>{
await updateDoc(doc(db,"shipments",id),{
status:status,
pickedUpAt:serverTimestamp()
});
};

window.goTransit=async(id)=>{
const otp=Math.floor(1000+Math.random()*9000).toString();
await updateDoc(doc(db,"shipments",id),{
status:"in_transit",
deliveryOTP:otp,
otpGeneratedAt:serverTimestamp()
});
};

window.prepareDelivery=function(id){
currentShipment=id;
document.getElementById("deliverySection").style.display="block";
};

window.completeDelivery=async function(){
const snap=await getDoc(doc(db,"shipments",currentShipment));
const data=snap.data();
const inputOTP=document.getElementById("otpInput").value;

if(inputOTP!==data.deliveryOTP){
alert("OTP incorrect");
return;
}

await updateDoc(doc(db,"shipments",currentShipment),{
status:"delivered",
deliveredAt:serverTimestamp()
});

alert("Livraison confirmée");
document.getElementById("deliverySection").style.display="none";
};

window.searchTracking=function(){
alert("Recherche manuelle activée");
};

window.startCamera=function(){
document.getElementById("video").style.display="block";
};

</script>

</body>
</html>
