<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Messagerie Interne | Admin</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Inter,Arial;background:#0b0b0c;color:#fff}

header{
background:#000;
padding:18px 20px;
display:flex;
justify-content:space-between;
align-items:center;
border-bottom:1px solid rgba(212,175,55,.3);
}

.logo img{height:60px}

.logout{
background:#D4AF37;
color:#000;
border:none;
padding:10px 14px;
border-radius:12px;
font-weight:900;
cursor:pointer;
}

.container{
max-width:1200px;
margin:auto;
padding:20px;
display:flex;
flex-direction:column;
height:calc(100vh - 120px);
}

.chat-box{
flex:1;
overflow-y:auto;
padding:15px;
background:#121214;
border-radius:16px;
border:1px solid rgba(212,175,55,.2);
}

.message{
margin-bottom:14px;
padding:12px 14px;
border-radius:14px;
max-width:75%;
font-size:13px;
line-height:1.6;
}

.me{
background:#D4AF37;
color:#000;
margin-left:auto;
}

.other{
background:#1c1c1f;
border:1px solid rgba(212,175,55,.2);
}

.tag{
display:inline-block;
font-size:10px;
padding:4px 8px;
border-radius:999px;
font-weight:900;
margin-bottom:6px;
}

.tag.general{background:#555}
.tag.operation{background:#2980b9}
.tag.finance{background:#27ae60}
.tag.urgent{background:#c0392b}

.input-area{
margin-top:15px;
display:flex;
flex-direction:column;
gap:10px;
}

select,textarea{
background:#1c1c1f;
color:#fff;
border:1px solid rgba(212,175,55,.3);
border-radius:12px;
padding:10px;
font-size:13px;
}

textarea{resize:none;height:70px}

.send-btn{
background:#D4AF37;
border:none;
padding:12px;
border-radius:12px;
font-weight:900;
cursor:pointer;
color:#000;
}

.footer{
text-align:center;
padding:12px;
font-size:11px;
color:#aaa;
border-top:1px solid rgba(212,175,55,.2);
}

@media(min-width:900px){
.container{padding:30px}
.chat-box{padding:25px}
}
</style>
</head>

<body>

<header>
<div class="logo">
<img src="https://raw.githubusercontent.com/cizaimmo/ciza-logistics/4b1ea6a2d3697e3982880984ee31dca42d8c52fc/logo.png">
</div>
<button class="logout" id="logoutBtn">Déconnexion</button>
</header>

<div class="container">

<div class="chat-box" id="chatBox"></div>

<div class="input-area">
<select id="tagSelect">
<option value="general">GENERAL</option>
<option value="operation">OPERATION</option>
<option value="finance">FINANCE</option>
<option value="urgent">URGENT</option>
</select>

<textarea id="messageInput" placeholder="Écrire un message interne..."></textarea>
<button class="send-btn" id="sendBtn">Envoyer</button>
</div>

</div>

<div class="footer">
Ciza Logistics • Communication interne sécurisée • © 2026
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, addDoc, collection, onSnapshot, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const app = initializeApp({
apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
authDomain:"ciza-logistics.firebaseapp.com",
projectId:"ciza-logistics"
});
const db = getFirestore(app);
const auth = getAuth(app);

const chatBox=document.getElementById("chatBox");
const sendBtn=document.getElementById("sendBtn");

let currentUser;

onAuthStateChanged(auth, async(user)=>{
if(!user){location.href="../login.html";return;}
const snap=await getDoc(doc(db,"users",user.uid));
if(!snap.exists()){location.href="../login.html";return;}
const role=snap.data().role;
if(!["admin","superadmin","bureau"].includes(role)){
location.href="../login.html";
return;
}
currentUser={uid:user.uid,role,name:snap.data().fullName||snap.data().name||"User"};
listenMessages();
});

document.getElementById("logoutBtn").onclick=()=>signOut(auth);

const conversationRef=doc(db,"internalMessages","admin_global_chat");
const messagesRef=collection(conversationRef,"messages");

async function ensureConversation(){
const snap=await getDoc(conversationRef);
if(!snap.exists()){
await setDoc(conversationRef,{
lastMessage:"",
lastTimestamp:serverTimestamp(),
lastTag:"general"
});
}
}
await ensureConversation();

function listenMessages(){
onSnapshot(messagesRef,(snapshot)=>{
chatBox.innerHTML="";
snapshot.forEach(docSnap=>{
const d=docSnap.data();
const div=document.createElement("div");
div.className="message "+(d.senderId===currentUser.uid?"me":"other");
div.innerHTML=`
<div class="tag ${d.tag}">${d.tag.toUpperCase()}</div>
${d.text}
`;
chatBox.appendChild(div);
});
chatBox.scrollTop=chatBox.scrollHeight;
});
}

sendBtn.onclick=async()=>{
const text=document.getElementById("messageInput").value.trim();
const tag=document.getElementById("tagSelect").value;
if(!text)return;

await addDoc(messagesRef,{
senderId:currentUser.uid,
senderName:currentUser.name,
senderRole:currentUser.role,
text,
tag,
createdAt:serverTimestamp()
});

await updateDoc(conversationRef,{
lastMessage:text,
lastTimestamp:serverTimestamp(),
lastTag:tag
});

document.getElementById("messageInput").value="";
};
</script>

</body>
</html>
