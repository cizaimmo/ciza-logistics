<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Confirmation Paiement | Ciza Logistics</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
--gold:#D4AF37;
--black:#0b0b0c;
--soft:#121214;
--border:rgba(212,175,55,0.25);
--muted:#9a9aa3;
}

*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Inter;background:var(--black);color:#fff}

/* HEADER */
.header{
display:flex;
justify-content:space-between;
align-items:center;
padding:16px 20px;
background:#000;
border-bottom:1px solid var(--border);
position:sticky;top:0;z-index:1000;
}

.logo{color:var(--gold);font-weight:900}
.header-actions{display:flex;gap:10px}

.header-btn{
background:transparent;
border:1px solid var(--border);
color:#fff;
padding:8px 14px;
border-radius:12px;
font-size:12px;
cursor:pointer;
}

.wrapper{padding:30px 20px 60px;max-width:800px;margin:auto}

.card{
background:linear-gradient(180deg,#151518,#0d0d0f);
border:1px solid rgba(212,175,55,0.4);
border-radius:28px;
padding:30px;
box-shadow:0 25px 80px rgba(0,0,0,0.7);
}

.title{text-align:center;margin-bottom:20px}
.title h1{color:var(--gold);font-size:22px;font-weight:900}

.divider{
height:1px;
background:linear-gradient(to right,transparent,rgba(212,175,55,0.6),transparent);
margin:22px 0;
}

.tracking{text-align:center}
.code{color:var(--gold);font-weight:900;font-size:16px}
.amount{font-size:34px;font-weight:900;margin-top:8px}

#qrBox{display:flex;justify-content:center;margin-top:20px}
#map{height:280px;margin-top:25px;border-radius:20px}

.route-info{text-align:center;margin-top:12px;font-size:14px;color:#ccc}

.input-group{margin-top:20px}
.input-group label{font-size:11px;color:var(--muted);font-weight:800}
.input-group input{
width:100%;
margin-top:6px;
padding:15px;
background:#101012;
border:1px solid rgba(255,255,255,0.08);
border-radius:16px;
color:#fff;
font-size:14px;
}

.btn{
width:100%;
margin-top:25px;
padding:18px;
background:var(--gold);
border:none;
border-radius:24px;
font-weight:900;
color:#000;
cursor:pointer;
font-size:15px;
}

.btn:disabled{opacity:.6;cursor:not-allowed}

.pdf-btn{
background:#000;
color:var(--gold);
border:1px solid var(--gold);
}

.status-box{
margin-top:18px;
text-align:center;
font-weight:800;
font-size:13px;
color:#D4AF37;
}
</style>
</head>

<body>

<div class="header">
<div class="logo">Ciza Logistics</div>
<div class="header-actions">
<button class="header-btn" onclick="location.href='espace-client.html'">Retour</button>
<button class="header-btn" id="logoutBtn">D√©connexion</button>
</div>
</div>

<div class="wrapper">
<div class="card">

<div class="title">
<h1>Finalisation du paiement</h1>
</div>

<div class="tracking">
<div class="code" id="trackingCode"></div>
<div class="amount" id="amountBox"></div>
</div>

<div id="qrBox"></div>

<div id="map"></div>
<div class="route-info" id="routeInfo"></div>

<button class="btn pdf-btn" id="pdfBtn">üßæ T√©l√©charger facture provisoire</button>

<div class="divider"></div>

<div class="input-group">
<label>R√©f√©rence transaction</label>
<input id="paymentReference">
</div>

<div class="input-group">
<label>Num√©ro utilis√©</label>
<input id="paymentPhone">
</div>

<button class="btn" id="submitBtn">Envoyer la r√©f√©rence</button>

<div class="status-box" id="statusBox"></div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const app = initializeApp({
apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
authDomain:"ciza-logistics.firebaseapp.com",
projectId:"ciza-logistics"
});
const db=getFirestore(app);
const auth=getAuth(app);

document.getElementById("logoutBtn").onclick=async()=>{
await signOut(auth);
location.href="login.html";
};

const tracking=new URLSearchParams(window.location.search).get("tracking");
let shipmentData=null;

onAuthStateChanged(auth,async user=>{
if(!user||!tracking){location.href="login.html";return;}

const snap=await getDoc(doc(db,"shipments",tracking));
if(!snap.exists()) return;

shipmentData=snap.data();
if(shipmentData.ownerUid!==user.uid){location.href="login.html";return;}

document.getElementById("trackingCode").innerText="Tracking : "+tracking;
document.getElementById("amountBox").innerText=(shipmentData.finalPrice||0).toLocaleString("fr-FR")+" BIF";

generateQR();
initMap();

if(shipmentData.paymentStatus==="pending_verification"){
lockForm();
}
});

function generateQR(){
new QRCode(document.getElementById("qrBox"),{
text:window.location.origin+"/tracking.html?tracking="+tracking,
width:140,height:140,colorDark:"#D4AF37",colorLight:"#0b0b0c"
});
}

async function initMap(){
if(!shipmentData.fromLat||!shipmentData.toLat) return;

const map=L.map('map').setView([shipmentData.fromLat,shipmentData.fromLng],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

L.marker([shipmentData.fromLat,shipmentData.fromLng]).addTo(map);
L.marker([shipmentData.toLat,shipmentData.toLng]).addTo(map);

const url=`https://router.project-osrm.org/route/v1/driving/${shipmentData.fromLng},${shipmentData.fromLat};${shipmentData.toLng},${shipmentData.toLat}?overview=full&geometries=geojson`;
const res=await fetch(url);
const data=await res.json();

if(data.routes.length){
const route=data.routes[0];
const coords=route.geometry.coordinates.map(c=>[c[1],c[0]]);
const line=L.polyline(coords,{color:"#D4AF37",weight:5}).addTo(map);
map.fitBounds(line.getBounds(),{padding:[20,20]});

const km=(route.distance/1000).toFixed(2);
const min=Math.round(route.duration/60);
document.getElementById("routeInfo").innerText="üöó "+km+" km ‚Ä¢ ‚è± "+min+" min estim√©";
}
}

function generateStamp(){
const random=Math.random().toString(36).substring(2,7).toUpperCase();
return "CZL-"+new Date().getFullYear()+"-"+tracking+"-"+random;
}

document.getElementById("pdfBtn").onclick=()=>{
const { jsPDF } = window.jspdf;
const pdf=new jsPDF();
const stamp=generateStamp();

pdf.setFontSize(40);
pdf.setTextColor(212,175,55);
pdf.text("PROVISOIRE",35,150,{angle:45});

pdf.setTextColor(0,0,0);
pdf.setFontSize(18);
pdf.text("Ciza Logistics",20,20);
pdf.setFontSize(12);
pdf.text("Tracking: "+tracking,20,40);
pdf.text("Montant: "+shipmentData.finalPrice+" BIF",20,50);
pdf.text("Route: "+(shipmentData.fromCity||"")+" ‚Üí "+(shipmentData.toCity||""),20,60);
pdf.text("Cachet num√©rique: "+stamp,20,75);

pdf.save("facture_provisoire_"+tracking+".pdf");
};

document.getElementById("submitBtn").onclick=async()=>{
await updateDoc(doc(db,"shipments",tracking),{
status:"payment_under_review",
paymentStatus:"pending_verification",
paymentReference:document.getElementById("paymentReference").value,
paymentPhone:document.getElementById("paymentPhone").value,
referenceSubmittedAt:serverTimestamp()
});
lockForm();
};

function lockForm(){
document.getElementById("submitBtn").disabled=true;
document.getElementById("paymentReference").disabled=true;
document.getElementById("paymentPhone").disabled=true;
document.getElementById("statusBox").innerText="R√©f√©rence envoy√©e. Paiement en cours de v√©rification.";
}
</script>

</body>
</html>
