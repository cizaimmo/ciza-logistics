<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="#000000">

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<title>Ciza Driver</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
:root{
  --gold:#D4AF37;
  --black:#000;
  --bg:#f3f4f6;
  --card:#fff;
  --muted:#6b7280;

  --ok:#16a34a;
  --warn:#f59e0b;
  --bad:#dc2626;
  --blue:#2563eb;
  --purple:#7c3aed;
}

*{box-sizing:border-box}
body{margin:0;font-family:Inter;background:var(--bg);color:#111;}

.header{
  background:rgba(0,0,0,0.96);
  color:#fff;
  padding:14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;
  top:0;
  z-index:10;
}

.brand{color:var(--gold);font-weight:900;font-size:16px;}
.driverName{font-size:12px;color:#e5e7eb;margin-top:4px;}

.header-right{
  display:flex;
  gap:14px;
  align-items:center;
  flex-wrap:wrap;
}

.badge{
  padding:6px 12px;
  border-radius:999px;
  font-weight:900;
  font-size:12px;
  background:var(--ok);
  color:#fff;
}

.logout-btn{
  background:var(--gold);
  border:none;
  padding:8px 14px;
  border-radius:12px;
  font-weight:900;
  cursor:pointer;
}

.container{width:95%;max-width:1100px;margin:16px auto 80px auto;}

.card{
  background:var(--card);
  border-radius:18px;
  padding:18px;
  margin:16px 0;
  box-shadow:0 12px 26px rgba(0,0,0,0.06);
}

.section-title{
  font-weight:900;
  margin:0 0 12px 0;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.small{font-size:12px;color:var(--muted)}
.hr{height:1px;background:rgba(0,0,0,0.08);margin:14px 0}

.grid{
  display:grid;
  grid-template-columns:1fr;
  gap:16px;
}
@media(min-width:900px){
  .grid{grid-template-columns:1.1fr 0.9fr;}
}

/* SHIPMENT CARD */
.shipment-card{
  border:1px solid rgba(212,175,55,0.35);
  border-radius:16px;
  padding:16px;
  margin:12px 0;
  background:linear-gradient(180deg,#fff,#fafafa);
  transition:all .2s ease;
}

/* SELECTION VISUELLE */
.shipment-card.active{
  border:2px solid var(--gold);
  box-shadow:0 0 0 4px rgba(212,175,55,0.25);
  transform:translateY(-2px);
}

.shipment-top{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:10px;
}

.track{font-weight:900;}
.routeLine{margin-top:4px;font-size:13px;}
.metaLine{margin-top:6px;font-size:13px;}

.actionsRow{
  display:flex;
  gap:14px;
  flex-wrap:wrap;
  margin-top:12px;
}

.btn{
  border:none;
  border-radius:14px;
  padding:13px 16px;
  font-weight:900;
  cursor:pointer;
  min-height:46px;
}

.btn.full{width:100%;}
.btn.dark{background:#111;color:#fff;}
.btn.gold{background:var(--gold);color:#000;}
.btn.ghost{background:rgba(0,0,0,0.06);color:#111;}
.btn.whatsapp{background:#25D366;color:#fff;}
.btn.red{background:var(--bad);color:#fff;}

input{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(0,0,0,0.12);
  margin-top:10px;
  font-family:Inter;
}

#map{height:280px;border-radius:16px;margin-top:10px;}

canvas{
  border:1px solid rgba(0,0,0,0.15);
  border-radius:14px;
  width:100%;
  height:160px;
  margin-top:10px;
  background:#fff;
}

/* ARCHIVES */
.archive-item{
  font-size:13px;
  padding:8px 0;
  border-bottom:1px solid rgba(0,0,0,0.08);
}

.archive-item:last-child{
  border-bottom:none;
}
</style>
</head>

<body>

<div class="header">
  <div>
    <div class="brand">üöö Ciza Driver</div>
    <div class="driverName" id="driverName">Chargement...</div>
  </div>

  <div class="header-right">
    <span class="badge" id="connectionStatus">En ligne</span>
    <span class="badge" id="gpsStatus">GPS OK</span>
    <span class="badge" id="deliveryCounter">0</span>
    <button class="logout-btn" id="logoutBtn">D√©connexion</button>
  </div>
</div>

<div class="container">
<div class="grid">

<!-- LISTES -->
<div>

<div class="card">
<div class="section-title">
<span>üü° √Ä traiter</span>
<span class="badge" id="countAssigned">0</span>
</div>
<div id="assignedList"></div>
</div>

<div class="card">
<div class="section-title">
<span>üîµ En transit</span>
<span class="badge" id="countTransit">0</span>
</div>
<div id="transitList"></div>
</div>

<div class="card">
<div class="section-title">
<span>üü¢ Livr√©s aujourd‚Äôhui</span>
<span class="badge" id="countDelivered">0</span>
</div>
<div id="deliveredList"></div>
</div>

<!-- ARCHIVES -->
<div class="card">
<div class="section-title">
<span>üóÇ Archives</span>
<span class="badge" id="countArchived">0</span>
</div>
<div id="archivedList"></div>
</div>

</div>

<!-- DETAILS -->
<div>
<div class="card" id="detailsCard">
<div class="section-title">
<span>üì¶ D√©tails & Navigation</span>
<span class="small" id="selectedHint">S√©lectionne un colis</span>
</div>

<div id="shipmentDetails">Aucun colis s√©lectionn√©</div>
<div class="hr"></div>
<div id="map"></div>

<div class="actionsRow">
<button class="btn gold full" id="mainActionBtn" style="display:none;">Action</button>
</div>
</div>

</div>

</div>
</div>
  
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, collection, query, where, onSnapshot,
  doc, getDoc, getDocs, updateDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
  authDomain:"ciza-logistics.firebaseapp.com",
  projectId:"ciza-logistics"
});

const db=getFirestore(app);
const auth=getAuth(app);

let currentUser=null;
let selectedShipmentId=null;
let selectedShipment=null;

let map=L.map('map').setView([-3.3731,29.9189],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let driverMarker=null;
let destinationMarker=null;

onAuthStateChanged(auth,async(user)=>{
  if(!user){location.href="login.html";return;}
  currentUser=user;
  listenShipments();
});

document.getElementById("logoutBtn").onclick=async()=>{
  await signOut(auth);
  location.href="login.html";
};

function listenShipments(){
  const q=query(collection(db,"shipments"),
  where("assignedDriverId","==",currentUser.uid));

  onSnapshot(q,(snap)=>{
    let assigned=[];
    let delivered=[];

    snap.forEach(docSnap=>{
      const d=docSnap.data();
      d.id=docSnap.id;
      if(d.archivedByDriver) return;
      if(d.status==="assigned") assigned.push(d);
      if(d.status==="delivered") delivered.push(d);
    });

    renderList("assignedList",assigned);
    renderList("deliveredList",delivered);
    document.getElementById("deliveryCounter").textContent=delivered.length;
  });
}

function renderList(id,list){
  const el=document.getElementById(id);
  if(!list.length){el.innerHTML="<div class='small'>Aucun colis.</div>";return;}
  el.innerHTML=list.map(d=>renderCard(d)).join("");
}

function renderCard(d){
  const activeClass=selectedShipmentId===d.id?"active":"";
  return `
  <div class="shipment-card ${activeClass}">
    <div><b>${d.trackingCode||d.id}</b></div>
    <div class="small">üìç ${d.fromCity||""} ‚Üí ${d.toCity||""}</div>
    <div class="actionsRow">
      <button class="btn dark" onclick="selectShipment('${d.id}')">Voir</button>
      ${d.status==="assigned"?`<button class="btn gold full" onclick="confirmPickup('${d.id}')">Confirmer prise en charge</button>`:""}
      ${d.status==="delivered"?`<button class="btn red full" onclick="archiveShipment('${d.id}')">üóÇ Archiver</button>`:""}
    </div>
  </div>`;
}

window.selectShipment=async function(id){
  const snap=await getDoc(doc(db,"shipments",id));
  if(!snap.exists())return;
  selectedShipmentId=id;
  selectedShipment=snap.data();
  renderAfterSelect();

  if(selectedShipment.toLat){
    if(destinationMarker){
      destinationMarker.setLatLng([selectedShipment.toLat,selectedShipment.toLng]);
    }else{
      destinationMarker=L.marker([selectedShipment.toLat,selectedShipment.toLng]).addTo(map);
    }
  }
};

function renderAfterSelect(){
  document.querySelectorAll(".shipment-card")
    .forEach(c=>c.classList.remove("active"));
  setTimeout(()=>{
    document.querySelectorAll(".shipment-card")
    .forEach(c=>{
      if(c.innerHTML.includes(selectedShipmentId))
        c.classList.add("active");
    });
  },50);
}

window.confirmPickup=async function(id){
  await updateDoc(doc(db,"shipments",id),{
    status:"picked_up",
    pickedUpAt:serverTimestamp()
  });
};

window.archiveShipment=async function(id){
  await updateDoc(doc(db,"shipments",id),{
    archivedByDriver:true,
    archivedAt:serverTimestamp()
  });
};

document.getElementById("navBtn").onclick=()=>{
  if(!selectedShipment)return alert("S√©lectionne un colis");
  window.open(`https://www.google.com/maps/dir/?api=1&destination=${selectedShipment.toLat},${selectedShipment.toLng}`,"_blank");
};

document.getElementById("notifyBtn").onclick=()=>{
  document.getElementById("assignedList").scrollIntoView({behavior:"smooth"});
};

navigator.geolocation.watchPosition(pos=>{
  const lat=pos.coords.latitude;
  const lng=pos.coords.longitude;
  if(driverMarker){
    driverMarker.setLatLng([lat,lng]);
  }else{
    driverMarker=L.marker([lat,lng]).addTo(map);
    map.setView([lat,lng],13);
  }
});

</script>
</body>
</html>
