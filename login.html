<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CizaLogistics | Espace Sécurisé</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

<style>
:root{--gold:#D4AF37;}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter;
  background:radial-gradient(circle at top,#111,#000);
  color:#fff;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.card{
  width:95%;
  max-width:450px;
  background:rgba(255,255,255,0.05);
  backdrop-filter:blur(25px);
  border-radius:30px;
  padding:45px 30px;
  border:1px solid rgba(212,175,55,0.25);
  box-shadow:0 30px 80px rgba(0,0,0,0.6);
}
.logo{text-align:center;margin-bottom:30px;}
.logo img{width:170px;}
.title{text-align:center;font-weight:900;font-size:18px;margin-bottom:6px;}
.subtitle{text-align:center;font-size:13px;color:#bbb;margin-bottom:30px;}
input{
  width:100%;
  padding:15px;
  margin-top:14px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,0.1);
  background:#111;
  color:#fff;
  font-size:14px;
}
button{
  width:100%;
  padding:16px;
  margin-top:20px;
  border-radius:18px;
  border:none;
  font-weight:900;
  cursor:pointer;
  font-size:15px;
}
.btn-login{background:var(--gold);color:#000;}
.btn-create{
  background:transparent;
  border:1px solid rgba(255,255,255,0.15);
  color:#fff;
}
#loginMessage{
  margin-top:15px;
  padding:12px;
  border-radius:14px;
  font-size:13px;
  display:none;
  text-align:center;
}
#resendBtn{
  display:none;
  margin-top:12px;
  background:transparent;
  border:1px solid rgba(212,175,55,0.4);
  color:#D4AF37;
  padding:12px;
  border-radius:14px;
  font-weight:700;
  cursor:pointer;
}
.support{
  margin-top:30px;
  font-size:12px;
  text-align:center;
  color:#aaa;
  line-height:1.7;
}
.support a{color:#25D366;font-weight:700;text-decoration:none;}
</style>
</head>

<body>

<div class="card">

<div class="logo">
<img src="https://raw.githubusercontent.com/cizaimmo/ciza-logistics/893e5582023cca6493a2a462843ad9d01286b82b/logo.png">
</div>

<div class="title">Bienvenue sur notre espace sécurisé</div>
<div class="subtitle"><b>CizaLogistics</b> | Division de Ciza Group</div>

<input type="email" id="email" placeholder="Adresse email">
<input type="password" id="password" placeholder="Mot de passe">

<button class="btn-login" id="loginBtn">Connexion</button>
<button class="btn-create" onclick="location.href='signup.html'">Créer un compte</button>

<div id="loginMessage"></div>
<button id="resendBtn">Renvoyer l'email de vérification</button>

<div class="support">
Support client WhatsApp<br><br>
International:
<a href="https://wa.me/15145029503" target="_blank">(+1) 514 502 9503</a><br>
Burundi / Rwanda:
<a href="https://wa.me/25779945007" target="_blank">(+257) 79945007</a>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, sendEmailVerification, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
  authDomain:"ciza-logistics.firebaseapp.com",
  projectId:"ciza-logistics"
});
const auth = getAuth(app);
const db = getFirestore(app);

let failedAttempts=0;
let lockUntil=null;

function showMessage(text,type="error"){
  const box=document.getElementById("loginMessage");
  box.style.display="block";
  if(type==="error"){
    box.style.background="rgba(220,38,38,0.15)";
    box.style.border="1px solid rgba(220,38,38,0.4)";
  }else{
    box.style.background="rgba(22,163,74,0.15)";
    box.style.border="1px solid rgba(22,163,74,0.4)";
  }
  box.innerHTML=text;
}

function redirectByRole(role){
  if(role==="client") location.href="espace-client.html";
  else if(role==="driver") location.href="driver-tool.html";
  else if(role==="admin") location.href="admin/admin-parcel.html";
  else if(role==="super_admin") location.href="super-admin.html";
  else location.href="espace-client.html";
}

document.getElementById("loginBtn").onclick=async()=>{

  if(lockUntil && Date.now()<lockUntil){
    showMessage("Trop de tentatives. Réessayez dans 60 secondes.","error");
    return;
  }

  const email=(document.getElementById("email").value||"").trim();
  const password=document.getElementById("password").value;

  try{

    const cred=await signInWithEmailAndPassword(auth,email,password);

    const snap=await getDoc(doc(db,"users",cred.user.uid));
    if(!snap.exists()){
      showMessage("Compte introuvable (Firestore users).","error");
      await signOut(auth);
      return;
    }

    const data=snap.data()||{};
    const role=(data.role||"").toString();

    /* ADMIN / SUPER_ADMIN : connexion directe (pas de vérif email) */
    if(role==="admin" || role==="super_admin"){
      redirectByRole(role);
      return;
    }

    /* CLIENT / DRIVER : email doit être vérifié */
    if(!cred.user.emailVerified){
      showMessage("Email non vérifié. Vérifiez votre boîte mail.","error");
      document.getElementById("resendBtn").style.display="block";
      return;
    }

    /* DRIVER : doit être approved */
    if(role==="driver" && data.accountStatus!=="approved"){
      showMessage("Compte chauffeur en attente d'approbation.","error");
      return;
    }

    /* CLIENT : (tu veux approved direct côté signup, ok) */
    if(role==="client"){
      redirectByRole("client");
      return;
    }

    /* DRIVER (approved) */
    if(role==="driver"){
      redirectByRole("driver");
      return;
    }

    /* Autre rôle : bloquer */
    showMessage("Rôle non reconnu. Contactez l'administration.","error");
    await signOut(auth);

  }catch(e){
    failedAttempts++;
    if(failedAttempts>=5){
      lockUntil=Date.now()+60000;
      failedAttempts=0;
      showMessage("Compte verrouillé 60 secondes.","error");
      return;
    }
    showMessage("Email ou mot de passe incorrect.","error");
  }
};

/* RENVOI EMAIL */
document.getElementById("resendBtn").onclick=async()=>{
  try{
    if(!auth.currentUser){
      showMessage("Reconnectez-vous puis renvoyez l'email.","error");
      return;
    }
    await sendEmailVerification(auth.currentUser);
    showMessage("Email de vérification renvoyé ✅","success");
  }catch(e){
    showMessage("Erreur lors du renvoi.","error");
  }
};
</script>

</body>
</html>
