<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CizaLogistics | Cr√©ation de Compte</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{--gold:#D4AF37;}
body{margin:0;font-family:Inter;background:radial-gradient(circle at top,#111,#000);color:#fff;display:flex;justify-content:center;align-items:center;min-height:100vh;}
.card{width:95%;max-width:460px;background:rgba(255,255,255,0.05);backdrop-filter:blur(20px);border-radius:28px;padding:40px 30px;border:1px solid rgba(212,175,55,0.25);}
.logo{text-align:center;margin-bottom:25px;}
.logo img{width:150px;}
h2{text-align:center;margin-bottom:25px;}
input,select{width:100%;padding:14px;margin-top:12px;border-radius:16px;border:1px solid rgba(255,255,255,0.1);background:#111;color:#fff;}
button{width:100%;padding:15px;margin-top:20px;border-radius:16px;border:none;font-weight:900;background:var(--gold);color:#000;cursor:pointer;}
.note{margin-top:15px;font-size:12px;color:#bbb;text-align:center;}
.small{font-size:12px;color:#bbb;margin-top:8px;}
.hidden{display:none;}
</style>
</head>

<body>
<div class="card">
  <div class="logo">
    <img src="https://raw.githubusercontent.com/cizaimmo/ciza-logistics/893e5582023cca6493a2a462843ad9d01286b82b/logo.png">
  </div>

  <h2>Cr√©er un compte s√©curis√©</h2>

  <input type="text" id="fullName" placeholder="Nom complet">
  <input type="email" id="email" placeholder="Adresse email">
  <input type="tel" id="phone" placeholder="Num√©ro de t√©l√©phone (+257XXXXXXXX)">
  <input type="password" id="password" placeholder="Mot de passe">

  <select id="role">
    <option value="client">Client</option>
    <option value="driver">Chauffeur</option>
  </select>

  <button id="signupBtn">Cr√©er le compte</button>

  <div id="otpSection" class="hidden">
    <input type="text" id="otpCode" placeholder="Entrer le code SMS">
    <button id="verifyOtpBtn">V√©rifier le code</button>
  </div>

  <div class="note">
    Les comptes Chauffeur n√©cessitent validation manuelle (pending ‚Üí approved).
  </div>

  <div id="recaptcha-container"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getAuth, 
  createUserWithEmailAndPassword, 
  sendEmailVerification,
  RecaptchaVerifier,
  signInWithPhoneNumber
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
  authDomain:"ciza-logistics.firebaseapp.com",
  projectId:"ciza-logistics"
});

const auth = getAuth(app);
const db = getFirestore(app);

let confirmationResult = null;
let tempData = null;

// Validation format t√©l√©phone Burundi/Rwanda (+257 ou +250)
function isValidPhone(phone){
  const regex = /^\+\d{8,15}$/;
  return regex.test(phone);
}

// Init reCAPTCHA invisible
window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
  size: 'invisible'
});

document.getElementById("signupBtn").onclick = async () => {

  const fullName = document.getElementById("fullName").value.trim();
  const email = document.getElementById("email").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const password = document.getElementById("password").value;
  const role = document.getElementById("role").value;

  if(!fullName || !email || !password){
    alert("Tous les champs sont obligatoires.");
    return;
  }

  // üöö Chauffeur : t√©l√©phone obligatoire + format
  if(role === "driver"){
    if(!phone){
      alert("Num√©ro obligatoire pour chauffeur.");
      return;
    }
    if(!isValidPhone(phone)){
      alert("Format invalide. Exemple: +257799000000");
      return;
    }

    try{
      // Envoyer SMS OTP
      confirmationResult = await signInWithPhoneNumber(auth, phone, window.recaptchaVerifier);
      tempData = { fullName, email, password, phone, role };
      document.getElementById("otpSection").classList.remove("hidden");
      alert("Code SMS envoy√©.");
    }catch(e){
      alert("Erreur SMS: " + e.message);
    }

    return;
  }

  // üë§ CLIENT (simple)
  try{
    const cred = await createUserWithEmailAndPassword(auth,email,password);
    await sendEmailVerification(cred.user);

    await setDoc(doc(db,"users",cred.user.uid),{
      fullName,
      email,
      phone: phone || null,
      role,
      accountStatus:"approved",
      createdAt:serverTimestamp()
    });

    alert("Compte client cr√©√©. V√©rifiez votre email.");
    location.href="login.html";

  }catch(e){
    alert("Erreur: "+e.message);
  }
};

// üîê V√©rification OTP chauffeur
document.getElementById("verifyOtpBtn").onclick = async () => {
  const code = document.getElementById("otpCode").value.trim();

  try{
    const result = await confirmationResult.confirm(code);

    // Cr√©er email/password apr√®s v√©rif t√©l√©phone
    const cred = await createUserWithEmailAndPassword(auth,tempData.email,tempData.password);
    await sendEmailVerification(cred.user);

    await setDoc(doc(db,"users",cred.user.uid),{
      fullName: tempData.fullName,
      email: tempData.email,
      phone: tempData.phone,
      role: "driver",
      accountStatus:"pending",
      createdAt:serverTimestamp()
    });

    alert("Compte chauffeur cr√©√©. En attente de validation.");
    location.href="login.html";

  }catch(e){
    alert("Code incorrect.");
  }
};
</script>

</body>
</html>
