<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ciza Parcel | Livraison Nationale</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

<style>
:root{
--gold:#D4AF37;
--black:#0b0b0c;
--softBlack:#121214;
--muted:#9a9aa3;
--border:rgba(212,175,55,0.25);
--radius:22px;
--card:#0f1012;
--field:#101012;
--danger:#ff6b6b;
--ok:#1dd1a1;
}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{font-family:'Inter',sans-serif;background:var(--black);color:#fff;overflow-x:hidden}

/* TOPBAR */
.topbar{
background:#000;
border-bottom:1px solid var(--border);
padding:9px 10px;
text-align:center;
color:var(--gold);
font-size:12px;
font-weight:700;
letter-spacing:.4px;
}

/* HEADER */
.main-header{
position:sticky;top:0;
background:rgba(0,0,0,0.92);
backdrop-filter:blur(10px);
border-bottom:1px solid var(--border);
z-index:1200;
}
.header-inner{
width:95%;
max-width:1200px;
margin:auto;
display:flex;
align-items:center;
justify-content:space-between;
padding:14px 0;
gap:12px;
}
.logo{
display:flex;align-items:center;gap:12px;
}
.logo img{
height:60px;
filter:drop-shadow(0 0 12px rgba(212,175,55,0.28));
}
.header-right{display:flex;align-items:center;gap:10px;}
.user-chip{
display:none;
align-items:center;
gap:8px;
padding:10px 12px;
border-radius:999px;
border:1px solid rgba(212,175,55,0.20);
background:rgba(255,255,255,0.04);
color:#fff;
font-size:12px;
white-space:nowrap;
}
.user-chip b{color:var(--gold)}
.nav-desktop{
display:flex;gap:22px;align-items:center;
}
.nav-desktop a{
text-decoration:none;
color:#fff;
font-size:13px;
font-weight:700;
letter-spacing:.2px;
}
.nav-desktop a:hover{color:var(--gold)}
.btn-outline{
border:1px solid var(--border);
padding:8px 12px;
border-radius:12px;
color:var(--gold)!important;
}
.logout-btn{
background:transparent;
border:1px solid var(--border);
color:var(--gold);
padding:8px 14px;
border-radius:12px;
cursor:pointer;
font-weight:800;
}
.logout-btn:hover{background:rgba(212,175,55,0.12)}

/* HAMBURGER */
.hamburger{
display:none;
flex-direction:column;
gap:4px;
background:transparent;
border:none;
cursor:pointer;
width:44px;height:44px;
border-radius:14px;
border:1px solid rgba(255,255,255,0.12);
align-items:center;
justify-content:center;
}
.hamburger span{width:20px;height:2px;background:var(--gold);display:block}

/* MOBILE MENU */
.mobile-menu{
position:fixed;
top:0;right:-100%;
width:280px;height:100%;
background:#0d0e10;
border-left:1px solid var(--border);
padding:18px;
display:flex;
flex-direction:column;
gap:10px;
transition:.35s;
z-index:2500;
}
.mm-top{
display:flex;align-items:center;justify-content:space-between;gap:10px;
padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,0.08);
}
.mm-title{color:var(--gold);font-weight:900;font-size:13px;letter-spacing:.6px}
.mm-close{
width:42px;height:42px;border-radius:14px;
border:1px solid rgba(255,255,255,0.14);
background:transparent;color:#fff;
font-size:22px;cursor:pointer;
}
.mm-user{
margin-top:8px;
padding:12px;border-radius:18px;
background:rgba(255,255,255,0.04);
border:1px solid rgba(212,175,55,0.18);
font-size:12px;line-height:1.6;
}
.mm-user b{color:var(--gold)}
.mobile-menu a{
text-decoration:none;
color:#fff;
font-weight:800;
padding:12px 14px;
border-radius:16px;
background:rgba(255,255,255,0.04);
border:1px solid rgba(255,255,255,0.06);
text-transform:uppercase;
font-size:12px;
letter-spacing:.6px;
}
.mobile-menu a:hover{background:rgba(212,175,55,0.10);color:var(--gold)}
.mm-actions{
margin-top:auto;
padding-top:12px;
border-top:1px solid rgba(255,255,255,0.08);
display:flex;flex-direction:column;gap:10px;
}
.mm-foot{color:#8b8b8b;font-size:11px;text-align:center}
.menu-overlay{
position:fixed;inset:0;
background:rgba(0,0,0,0.65);
opacity:0;pointer-events:none;
transition:.25s;
z-index:2400;
}
.menu-open .mobile-menu{right:0}
.menu-open .menu-overlay{opacity:1;pointer-events:auto}

/* HERO */
.hero{
padding:44px 0 24px;
border-bottom:1px solid var(--border);
background:linear-gradient(180deg,#0b0b0c,#101012);
text-align:center;
}
.hero h1{
color:var(--gold);
font-size:28px;
font-weight:900;
letter-spacing:.2px;
}
.hero p{
margin:10px auto 0;
max-width:900px;
font-size:13px;
line-height:1.7;
color:var(--muted);
padding:0 14px;
}

/* PAGE */
.section{padding:28px 0 52px}
.container{width:95%;max-width:1100px;margin:auto}
.form-card{
background:var(--softBlack);
border:1px solid var(--border);
border-radius:var(--radius);
padding:18px;
box-shadow:0 30px 90px rgba(0,0,0,0.35);
}
@media(min-width:720px){.form-card{padding:26px}}

.block{margin-bottom:18px}
.block-title{
color:var(--gold);
font-size:12px;
margin-bottom:12px;
font-weight:900;
text-transform:uppercase;
letter-spacing:1px;
}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
.grid.two{grid-template-columns:1fr}
.grid.three{grid-template-columns:1fr}
@media(min-width:900px){
.grid.two{grid-template-columns:1fr 1fr}
.grid.three{grid-template-columns:1fr 1fr 1fr}
.nav-desktop{display:flex}
.hamburger{display:none}
.user-chip{display:flex}
}
@media(max-width:899px){
.nav-desktop{display:none}
.hamburger{display:flex}
.user-chip{display:none}
}

/* INPUTS */
label{
display:block;
font-size:11px;
margin:0 0 6px;
color:#cfcfd4;
text-transform:uppercase;
letter-spacing:.6px;
font-weight:800;
}
input,select,textarea{
width:100%;
padding:14px 14px;
background:var(--field);
border:1px solid rgba(255,255,255,0.10);
border-radius:14px;
color:#fff;
outline:none;
transition:.2s;
}
textarea{min-height:92px;resize:none}
input:focus,select:focus,textarea:focus{
border-color:rgba(212,175,55,0.75);
box-shadow:0 0 0 2px rgba(212,175,55,0.14);
}
.small-note{
font-size:12px;
color:var(--muted);
margin-top:6px;
line-height:1.6;
}
.sep{
height:1px;
background:linear-gradient(to right,rgba(212,175,55,0),rgba(212,175,55,0.35),rgba(212,175,55,0));
margin:14px 0;
}

/* CHECKBOX */
.checkbox-line{
display:flex;gap:10px;align-items:flex-start;
padding:12px;border-radius:16px;
background:rgba(255,255,255,0.04);
border:1px solid rgba(255,255,255,0.08);
}
.checkbox-line input{width:18px;height:18px;margin-top:2px}
.checkbox-line span{font-size:13px;color:rgba(255,255,255,0.86);line-height:1.45}
.checkbox-line strong{color:var(--gold)}

/* SUMMARY */
.summary{
margin-top:10px;
background:rgba(212,175,55,0.10);
border:1px solid rgba(212,175,55,0.22);
color:#f6e7b5;
padding:12px 12px;
border-radius:14px;
font-size:13px;
line-height:1.6;
}

/* ACTIONS */
.actions{margin-top:14px;display:flex;flex-direction:column;gap:10px}
@media(min-width:720px){.actions{flex-direction:row}}
.primary-btn{
flex:1;
padding:16px;
background:var(--gold);
border:none;
border-radius:18px;
font-weight:900;
color:#000;
cursor:pointer;
font-size:14px;
}
.primary-btn:active{transform:scale(.99)}
.secondary-btn{
flex:1;
padding:16px;
background:transparent;
border:1px solid rgba(255,255,255,0.14);
border-radius:18px;
font-weight:900;
color:#fff;
cursor:pointer;
font-size:14px;
}
.secondary-btn:hover{border-color:rgba(212,175,55,0.35);color:var(--gold)}
.error{color:var(--danger);font-size:13px;margin-top:10px;font-weight:700}
.ok{color:var(--ok);font-size:13px;margin-top:10px;font-weight:800}

/* LOADER */
.loader{
display:none;
margin-top:10px;
text-align:center;
color:var(--gold);
font-weight:900;
font-size:13px;
}

/* FOOTER */
.footer{
border-top:1px solid var(--border);
padding:26px 0;
text-align:center;
color:#bdbdbd;
font-size:11px;
background:#000;
}
.footer b{color:var(--gold)}
</style>
</head>

<body>

<div class="topbar">Service 24/7 ‚Ä¢ Support WhatsApp +257 79 94 50 07</div>

<header class="main-header">
<div class="header-inner">
<div class="logo">
<img src="https://raw.githubusercontent.com/cizaimmo/ciza-logistics/4b1ea6a2d3697e3982880984ee31dca42d8c52fc/logo.png" alt="Ciza Logistics">
</div>

<nav class="nav-desktop">
<a href="index.html">Accueil</a>
<a href="parcel.html" class="btn-outline">Cr√©er envoi</a>
<a href="tracking.html">Suivi</a>
<a href="dashboard.html">Espace client</a>
</nav>

<div class="header-right">
<div class="user-chip"><span>Client :</span> <b id="clientName">‚Äî</b></div>
<button class="logout-btn" id="logoutBtn" style="display:none;">D√©connexion</button>
<button class="hamburger" id="hamburgerBtn" aria-label="Menu">
<span></span><span></span><span></span>
</button>
</div>

</div>
</header>

<div class="mobile-menu" id="mobileMenu">
<div class="mm-top">
<div class="mm-title">MENU</div>
<button class="mm-close" id="mmClose">√ó</button>
</div>

<div class="mm-user">
<div style="opacity:.85">Connect√© :</div>
<div style="margin-top:6px"><b id="mmClientName">‚Äî</b></div>
<div style="margin-top:8px;color:#cfcfcf">Espace s√©curis√© ‚Äì Parcel</div>
</div>

<a href="index.html">Accueil</a>
<a href="parcel.html">Cr√©er envoi</a>
<a href="tracking.html">Suivi</a>
<a href="dashboard.html">Espace client</a>

<div class="mm-actions">
<button class="logout-btn" id="logoutMobile" style="display:none;">D√©connexion</button>
<div class="mm-foot">¬© 2026 Ciza Logistics</div>
</div>
</div>
<div class="menu-overlay" id="menuOverlay"></div>

<section class="hero">
<h1>Ciza Parcel</h1>
<p>Formulaire intelligent multi-secteur (Particulier / Commerce / Pharmacie / Restaurant) avec localisation pr√©cise (province + quartier + rep√®re) et tarification dynamique (Firestore), pr√™t pour la s√©curit√© OTP via Espace Client.</p>
</section>

<section class="section">
<div class="container">
<div class="form-card">

<!-- PROFIL -->
<div class="block">
<div class="block-title">Profil d‚Äôexp√©dition</div>

<div class="grid three">
<div>
<label for="senderType">Type d‚Äôexp√©diteur</label>
<select id="senderType">
<option value="">S√©lectionner</option>
<option value="particulier">Particulier</option>
<option value="commerce">Commerce</option>
<option value="pharmacie">Pharmacie</option>
<option value="restaurant">Restaurant</option>
</select>
</div>

<div>
<label for="frequency">Fr√©quence d‚Äôenvoi</label>
<select id="frequency">
<option value="">S√©lectionner</option>
<option value="occasionnel">Occasionnel</option>
<option value="hebdomadaire">Hebdomadaire</option>
<option value="quotidien">Quotidien</option>
</select>
</div>

<div>
<label for="priority">Priorit√©</label>
<select id="priority">
<option value="standard">Standard</option>
<option value="express">Express</option>
</select>
</div>
</div>

<div class="grid two" style="margin-top:12px;">
<div>
<label for="internalRef">R√©f√©rence interne (optionnel)</label>
<input id="internalRef" placeholder="Ex: FACT-2026-015">
</div>

<div id="sensitivityWrap" style="display:none;">
<label>Sensibilit√© colis</label>
<div class="grid three" style="gap:10px;">
<div class="checkbox-line" style="padding:10px;border-radius:14px;">
<input type="checkbox" id="sensFragile">
<span><strong>Fragile</strong><br><span style="color:#cfcfcf;font-size:12px;">Manipulation d√©licate</span></span>
</div>
<div class="checkbox-line" style="padding:10px;border-radius:14px;">
<input type="checkbox" id="sensTemp">
<span><strong>Temp√©rature</strong><br><span style="color:#cfcfcf;font-size:12px;">Contr√¥le requis</span></span>
</div>
<div class="checkbox-line" style="padding:10px;border-radius:14px;">
<input type="checkbox" id="sensSensitive">
<span><strong>Sensible</strong><br><span style="color:#cfcfcf;font-size:12px;">Produit sensible</span></span>
</div>
</div>
</div>
</div>

<div class="small-note">Ces champs sont strat√©giques pour tes KPI, tes abonnements et l‚Äô√©volution ‚ÄúCiza Parcel Pro‚Äù.</div>
</div>

<div class="sep"></div>

<!-- ROUTE -->
<div class="block">
<div class="block-title">Route & Localisation</div>

<div class="grid three">
<div>
<label for="country">Pays</label>
<select id="country">
<option value="BI">üáßüáÆ Burundi</option>
<option value="RW">üá∑üáº Rwanda</option>
</select>
</div>

<div>
<label for="service">Service</label>
<select id="service" disabled>
<option value="parcel" selected>Parcel</option>
</select>
</div>

<div>
<label for="speedInfo">Info</label>
<input id="speedInfo" value="Province-based ‚Ä¢ 24/7" disabled>
</div>
</div>

<div class="grid two" style="margin-top:12px;">
<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:18px;padding:14px;">
<div style="color:var(--gold);font-weight:900;font-size:12px;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">D√©part</div>
<label for="originProvince">Province / Ville</label>
<select id="originProvince"></select>

<label for="originQuartier" style="margin-top:10px;">Quartier</label>
<select id="originQuartier"><option value="">‚Äî</option></select>

<label for="originLandmark" style="margin-top:10px;">Rep√®re pr√©cis</label>
<input id="originLandmark" placeholder="Ex: pr√®s de la station, portail bleu, √©cole...">
</div>

<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:18px;padding:14px;">
<div style="color:var(--gold);font-weight:900;font-size:12px;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">Destination</div>
<label for="destProvince">Province / Ville</label>
<select id="destProvince"></select>

<label for="destQuartier" style="margin-top:10px;">Quartier</label>
<select id="destQuartier"><option value="">‚Äî</option></select>

<label for="destLandmark" style="margin-top:10px;">Rep√®re pr√©cis</label>
<input id="destLandmark" placeholder="Ex: √† c√¥t√© du march√©, maison rouge, avenue...">
</div>
</div>

<div class="small-note">Si la province est <b>Bujumbura</b>, une liste compl√®te de <b>38 quartiers</b> s‚Äôaffiche automatiquement. Sinon, quartier = ‚Äú‚Äî‚Äù.</div>
</div>

<div class="sep"></div>

<!-- CONTACTS -->
<div class="block">
<div class="block-title">Contacts</div>

<div class="grid two">
<div>
<label for="senderName">Nom exp√©diteur</label>
<input id="senderName" placeholder="Ex: Ciza Market / Nom complet">
</div>

<div>
<label for="senderPhone">T√©l√©phone exp√©diteur</label>
<input id="senderPhone" inputmode="numeric" placeholder="+257XXXXXXXX" autocomplete="tel">
<div class="small-note">Num√©rique uniquement. Le pr√©fixe s‚Äôadapte au pays.</div>
</div>

<div>
<label for="receiverName">Nom destinataire</label>
<input id="receiverName" placeholder="Ex: Client / Boutique">
</div>

<div>
<label for="receiverPhone">T√©l√©phone destinataire</label>
<input id="receiverPhone" inputmode="numeric" placeholder="+257XXXXXXXX" autocomplete="tel">
</div>
</div>
</div>

<div class="sep"></div>

<!-- COLIS -->
<div class="block">
<div class="block-title">Colis & Paiement</div>

<div class="grid three">
<div>
<label for="packageType">Type d‚Äôenvoi</label>
<select id="packageType">
<option value="">S√©lectionner</option>
<option value="enveloppe">Enveloppe</option>
<option value="boite">Bo√Æte</option>
<option value="bidon">Bidon</option>
</select>
</div>

<div id="dynamicFieldWrap">
<label for="weightValue">Poids / Quantit√©</label>
<input id="weightValue" type="number" inputmode="numeric" placeholder="Kg ou quantit√©">
<div class="small-note" id="dynamicHint">Champ requis selon le type.</div>
</div>

<div>
<label for="paymentMethod">Mode de paiement</label>
<select id="paymentMethod">
<option value="">S√©lectionner</option>
<option value="Lumicash">Lumicash</option>
<option value="EcoCash">EcoCash</option>
<option value="eNoti">eNoti</option>
<option value="COD">Paiement √† la livraison</option>
</select>
</div>
</div>

<div class="grid two" style="margin-top:12px;">
<div>
<label for="declaredValue">Valeur d√©clar√©e (assurance)</label>
<input id="declaredValue" type="number" inputmode="numeric" placeholder="Ex: 50000">
<div class="small-note">Veuillez d√©clarer la valeur de votre marchandise pour assurance en cas de perte de colis.</div>
</div>

<div>
<label for="content">Contenu (description courte)</label>
<input id="content" placeholder="Ex: documents, accessoires, denr√©es...">
</div>
</div>

<div style="margin-top:12px;">
<label for="notes">Instructions (optionnel)</label>
<textarea id="notes" placeholder="Ex: fragile, appeler avant, laisser √† la r√©ception..."></textarea>
</div>

<div style="margin-top:12px;">
<div class="checkbox-line">
<input type="checkbox" id="nonDangerous">
<span><strong>Mati√®res non dangereuses</strong> : je confirme que cet envoi ne contient pas de produits interdits ou dangereux.</span>
</div>
</div>

<label style="margin-top:14px;">R√©sum√©</label>
<div class="summary" id="summaryText">Compl√®te le profil, la route, les contacts et le colis‚Ä¶</div>

</div>

<div id="errorMsg" class="error"></div>
<div id="okMsg" class="ok" style="display:none;"></div>
<div class="loader" id="loader">Traitement en cours‚Ä¶</div>

<div class="actions">
<button class="primary-btn" id="submitBtn">Continuer vers confirmation</button>
<button class="secondary-btn" id="goTrackingBtn" type="button">Aller au suivi</button>
</div>

</div>
</div>
</section>

<footer class="footer">
<b>Ciza Logistics</b> ‚Ä¢ Division de Ciza Group ‚Äî ¬© 2026
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* ================= FIREBASE ================= */
const firebaseConfig = {
apiKey: "AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
authDomain: "ciza-logistics.firebaseapp.com",
projectId: "ciza-logistics",
storageBucket: "ciza-logistics.firebasestorage.app",
messagingSenderId: "751524585771",
appId: "1:751524585771:web:6720db623a0ef70f56e56e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ================= UI REFS ================= */
const hamburgerBtn=document.getElementById("hamburgerBtn");
const menuOverlay=document.getElementById("menuOverlay");
const mmClose=document.getElementById("mmClose");

const logoutBtn=document.getElementById("logoutBtn");
const logoutMobile=document.getElementById("logoutMobile");

const clientName=document.getElementById("clientName");
const mmClientName=document.getElementById("mmClientName");

const country=document.getElementById("country");
const originProvince=document.getElementById("originProvince");
const destProvince=document.getElementById("destProvince");
const originQuartier=document.getElementById("originQuartier");
const destQuartier=document.getElementById("destQuartier");
const originLandmark=document.getElementById("originLandmark");
const destLandmark=document.getElementById("destLandmark");

const senderType=document.getElementById("senderType");
const frequency=document.getElementById("frequency");
const priority=document.getElementById("priority");
const internalRef=document.getElementById("internalRef");

const sensitivityWrap=document.getElementById("sensitivityWrap");
const sensFragile=document.getElementById("sensFragile");
const sensTemp=document.getElementById("sensTemp");
const sensSensitive=document.getElementById("sensSensitive");

const senderName=document.getElementById("senderName");
const senderPhone=document.getElementById("senderPhone");
const receiverName=document.getElementById("receiverName");
const receiverPhone=document.getElementById("receiverPhone");

const packageType=document.getElementById("packageType");
const weightValue=document.getElementById("weightValue");
const dynamicHint=document.getElementById("dynamicHint");
const paymentMethod=document.getElementById("paymentMethod");
const declaredValue=document.getElementById("declaredValue");
const content=document.getElementById("content");
const notes=document.getElementById("notes");
const nonDangerous=document.getElementById("nonDangerous");

const summaryText=document.getElementById("summaryText");
const submitBtn=document.getElementById("submitBtn");
const goTrackingBtn=document.getElementById("goTrackingBtn");
const errorMsg=document.getElementById("errorMsg");
const okMsg=document.getElementById("okMsg");
const loader=document.getElementById("loader");

let currentUser=null;
let currentUserDoc=null;

/* ================= MENU ================= */
function openMenu(){document.body.classList.add("menu-open");}
function closeMenu(){document.body.classList.remove("menu-open");}
hamburgerBtn.addEventListener("click",()=>{document.body.classList.contains("menu-open")?closeMenu():openMenu();});
menuOverlay.addEventListener("click",closeMenu);
mmClose.addEventListener("click",closeMenu);

/* ================= AUTH + ROLE GUARD ================= */
async function ensureClientRole(user){
const uSnap = await getDoc(doc(db,"users",user.uid));
if(!uSnap.exists()){
await signOut(auth);
location.href="login.html";
return false;
}
const u=uSnap.data();
currentUserDoc=u;

const nm=(u.fullName || u.name || user.email || "Client");
clientName.innerText=nm;
mmClientName.innerText=nm;

if(u.accountStatus==="suspended"){
alert("Compte suspendu.");
await signOut(auth);
location.href="login.html";
return false;
}

if(u.role!=="client"){
alert("Acc√®s refus√©.");
await signOut(auth);
location.href="login.html";
return false;
}

logoutBtn.style.display="inline-block";
logoutMobile.style.display="inline-block";
document.querySelector(".user-chip").style.display="flex";
return true;
}

onAuthStateChanged(auth, async (user)=>{
if(!user){
location.href="login.html";
return;
}
currentUser=user;
const ok = await ensureClientRole(user);
if(ok){
applyPhonePrefix(country.value);
}
});

logoutBtn.addEventListener("click",async()=>{await signOut(auth);location.href="login.html";});
logoutMobile.addEventListener("click",async()=>{await signOut(auth);location.href="login.html";});

/* ================= PHONE HELPERS ================= */
function enforceNumericPhone(input){
let v=input.value || "";
v=v.replace(/[^\d+]/g,"");
if(v.indexOf("+")>0){v=v.replace(/\+/g,"");}
input.value=v;
}
function applyPhonePrefix(cty){
const prefix = cty==="RW" ? "+250" : "+257";
if(senderPhone.value.trim()==="" || senderPhone.value.startsWith("+")) senderPhone.value=prefix;
if(receiverPhone.value.trim()==="" || receiverPhone.value.startsWith("+")) receiverPhone.value=prefix;
}
senderPhone.addEventListener("input",()=>enforceNumericPhone(senderPhone));
receiverPhone.addEventListener("input",()=>enforceNumericPhone(receiverPhone));
country.addEventListener("change",()=>applyPhonePrefix(country.value));

/* ================= PROVINCES + 38 QUARTIERS ================= */
const provincesBI=["Bujumbura","Bujumbura Rural","Gitega","Ngozi","Muyinga","Kayanza","Kirundo","Rutana","Ruyigi","Cankuzo","Makamba","Bururi","Mwaro","Muramvya","Bubanza","Cibitoke","Karusi","Rumonge"];
const provincesRW=["Kigali","Northern","Southern","Eastern","Western"];

/* 38 quartiers (Bujumbura) ‚Äî tri: ceux qui commencent par M d‚Äôabord, puis A-Z */
const quartiersBuj38=[
"Buyenzi","Bwiza","Nyakabiga","Kinama","Kamenge","Cibitoke","Jabe","Kanyosha",
"Musaga","Ngagara","Rohero I","Rohero II","Rohero III","Mutanga Nord","Mutanga Sud","Buterere",
"Gihosha","Kinanira I","Kinanira II","Carama","Kibenga","Gatumba","Ruziba","Kigobe",
"Mutakura","Kinindo","Kiriri","Sororezo","Rweza","Nyabugete","Kajaga","Kanyosha II",
"Kanyosha III","Kanyosha IV","Ngagara II","Ngagara III","Kamenge II","Buterere II"
];

function sortMFirst(list){
const m=list.filter(x=>x.trim().toLowerCase().startsWith("m")).sort((a,b)=>a.localeCompare(b,"fr"));
const rest=list.filter(x=>!x.trim().toLowerCase().startsWith("m")).sort((a,b)=>a.localeCompare(b,"fr"));
return [...m,...rest];
}

function loadProvinces(){
const c = country.value;
const list = c==="RW" ? provincesRW : provincesBI;
originProvince.innerHTML=`<option value="">S√©lectionner</option>`;
destProvince.innerHTML=`<option value="">S√©lectionner</option>`;
list.slice().sort((a,b)=>a.localeCompare(b,"fr")).forEach(p=>{
originProvince.innerHTML+=`<option value="${p}">${p}</option>`;
destProvince.innerHTML+=`<option value="${p}">${p}</option>`;
});
originQuartier.innerHTML=`<option value="">‚Äî</option>`;
destQuartier.innerHTML=`<option value="">‚Äî</option>`;
}
function bindQuartiers(provEl, qEl){
qEl.innerHTML=`<option value="">‚Äî</option>`;
if(provEl.value==="Bujumbura"){
sortMFirst(quartiersBuj38).forEach(q=>{
qEl.innerHTML+=`<option value="${q}">${q}</option>`;
});
}else{
qEl.innerHTML=`<option value="‚Äî">‚Äî</option>`;
}
}
country.addEventListener("change",()=>{
loadProvinces();
applyPhonePrefix(country.value);
updateSummary();
});
originProvince.addEventListener("change",()=>{bindQuartiers(originProvince,originQuartier);updateSummary();});
destProvince.addEventListener("change",()=>{bindQuartiers(destProvince,destQuartier);updateSummary();});
originQuartier.addEventListener("change",updateSummary);
destQuartier.addEventListener("change",updateSummary);
originLandmark.addEventListener("input",updateSummary);
destLandmark.addEventListener("input",updateSummary);

loadProvinces();

/* ================= PROFILE LOGIC ================= */
function updateSensitivityVisibility(){
const t=senderType.value;
const show = (t==="pharmacie" || t==="restaurant");
sensitivityWrap.style.display = show ? "block" : "none";
if(!show){
sensFragile.checked=false;
sensTemp.checked=false;
sensSensitive.checked=false;
}
updateSummary();
}
senderType.addEventListener("change",updateSensitivityVisibility);
frequency.addEventListener("change",updateSummary);
priority.addEventListener("change",updateSummary);
internalRef.addEventListener("input",updateSummary);

/* ================= PACKAGE TYPE HELP ================= */
function updateDynamicHint(){
const t=packageType.value;
if(t==="bidon"){
dynamicHint.innerText="Quantit√© requise (ex: 1, 2, 3‚Ä¶).";
weightValue.placeholder="Quantit√©";
}else{
dynamicHint.innerText="Poids requis (kg).";
weightValue.placeholder="Poids (kg)";
}
updateSummary();
}
packageType.addEventListener("change",updateDynamicHint);
weightValue.addEventListener("input",updateSummary);
declaredValue.addEventListener("input",updateSummary);
paymentMethod.addEventListener("change",updateSummary);
senderName.addEventListener("input",updateSummary);
receiverName.addEventListener("input",updateSummary);
content.addEventListener("input",updateSummary);
notes.addEventListener("input",updateSummary);
nonDangerous.addEventListener("change",updateSummary);

/* ================= SUMMARY ================= */
function safeVal(v){return (v===undefined||v===null||String(v).trim()==="")?"‚Äî":String(v).trim();}
function updateSummary(){
const c = country.value==="RW" ? "Rwanda" : "Burundi";
const op = safeVal(originProvince.value);
const dp = safeVal(destProvince.value);
const oq = safeVal(originQuartier.value);
const dq = safeVal(destQuartier.value);

const st = safeVal(senderType.value);
const fr = safeVal(frequency.value);
const pr = safeVal(priority.value);
const rf = safeVal(internalRef.value);

const pt = safeVal(packageType.value);
const pm = safeVal(paymentMethod.value);
const dv = declaredValue.value ? Number(declaredValue.value||0).toLocaleString("fr-FR") : "‚Äî";
const wv = weightValue.value ? String(weightValue.value) : "‚Äî";

const sens = (sensitivityWrap.style.display==="block")
? ` ‚Ä¢ Sensibilit√©: ${sensFragile.checked?"Fragile ":""}${sensTemp.checked?"Temp ":""}${sensSensitive.checked?"Sensible ":""}`.trim()
: "";

summaryText.innerText =
`${c} ‚Ä¢ ${op} (${oq}) ‚Üí ${dp} (${dq})
Profil: ${st} ‚Ä¢ ${fr} ‚Ä¢ ${pr} ‚Ä¢ Ref: ${rf}${sens}
Colis: ${pt} ‚Ä¢ Valeur d√©clar√©e: ${dv} ‚Ä¢ Poids/Qt√©: ${wv} ‚Ä¢ Paiement: ${pm}`;
}
updateSummary();

/* ================= TRACKING ================= */
function generateTracking(cty){
const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
let code="CL-"+cty+"-";
for(let i=0;i<8;i++) code+=chars[Math.floor(Math.random()*chars.length)];
return code;
}

/* ================= PRICING ================= */
async function loadPricing(cty){
/* doc pricing: parcel_bi / parcel_rw */
const id = cty==="RW" ? "parcel_rw" : "parcel_bi";
const snap = await getDoc(doc(db,"pricing",id));
if(!snap.exists()) throw new Error("Configuration tarifaire introuvable.");
return { id, data:snap.data() };
}

function num(v,def=0){const n=Number(v);return Number.isFinite(n)?n:def;}

/* ================= SUBMIT ================= */
function showError(msg){errorMsg.innerText=msg; okMsg.style.display="none"; okMsg.innerText="";}
function showOk(msg){okMsg.style.display="block"; okMsg.innerText=msg; errorMsg.innerText="";}
function setLoading(on){
loader.style.display = on ? "block" : "none";
submitBtn.disabled = on;
}

goTrackingBtn.addEventListener("click",()=>{location.href="tracking.html";});

submitBtn.addEventListener("click", async ()=>{
showError("");
setLoading(true);

try{
/* required fields */
if(!currentUser) throw new Error("Session expir√©e. Reconnectez-vous.");
if(!senderType.value) throw new Error("S√©lectionnez le type d‚Äôexp√©diteur.");
if(!frequency.value) throw new Error("S√©lectionnez la fr√©quence d‚Äôenvoi.");
if(!originProvince.value || !destProvince.value) throw new Error("S√©lectionnez la province de d√©part et destination.");
if(originProvince.value==="Bujumbura" && !originQuartier.value) throw new Error("S√©lectionnez le quartier de d√©part.");
if(destProvince.value==="Bujumbura" && !destQuartier.value) throw new Error("S√©lectionnez le quartier de destination.");
if(!senderName.value.trim() || !senderPhone.value.trim()) throw new Error("Compl√©tez les informations exp√©diteur.");
if(!receiverName.value.trim() || !receiverPhone.value.trim()) throw new Error("Compl√©tez les informations destinataire.");
if(!packageType.value) throw new Error("S√©lectionnez le type d‚Äôenvoi.");
if(!weightValue.value) throw new Error("Poids / quantit√© requis.");
if(num(weightValue.value)<=0) throw new Error("Poids / quantit√© invalide.");
if(!paymentMethod.value) throw new Error("S√©lectionnez un mode de paiement.");
if(!nonDangerous.checked) throw new Error("Veuillez confirmer 'mati√®res non dangereuses'.");

const cty = country.value || "BI";

/* pricing */
const pricingPack = await loadPricing(cty);
const pricing = pricingPack.data;

const tracking = generateTracking(cty);

const originSameDest = (originProvince.value === destProvince.value);
let base = originSameDest ? num(pricing.urbanBase) : num(pricing.interBase);

const w = num(weightValue.value,1);
const declared = num(declaredValue.value,0);

const weightExtra = w>1 ? (w-1)*num(pricing.weightMultiplier) : 0;
const insurance = declared>0 ? declared*(num(pricing.insurancePercent)/100) : 0;
const fuel = (base+weightExtra)*(num(pricing.fuelPercent)/100);

const finalPrice = Math.round(base + weightExtra + insurance + fuel);

const priceBreakdown={
base:Math.round(base),
weightExtra:Math.round(weightExtra),
insurance:Math.round(insurance),
fuel:Math.round(fuel),
pricingVersion: pricing.pricingVersion || pricingPack.id || "parcel_dynamic_v1"
};

/* senderProfile as validated */
const senderProfile={
type: senderType.value,
frequency: frequency.value,
priority: priority.value,
internalReference: internalRef.value.trim() ? internalRef.value.trim() : null,
sensitivity:{
fragile: !!sensFragile.checked,
temperatureControlled: !!sensTemp.checked,
sensitiveProduct: !!sensSensitive.checked
}
};

/* details by package type */
let details={};
if(packageType.value==="bidon"){
details.quantity = w;
}else{
details.weightKg = w;
}

await setDoc(doc(db,"shipments",tracking),{
trackingCode: tracking,
service:"parcel",
country: cty,

/* compat fields */
ownerUid: currentUser.uid,
uid: currentUser.uid,

senderProfile,

senderName: senderName.value.trim(),
senderPhone: senderPhone.value.trim(),
receiverName: receiverName.value.trim(),
receiverPhone: receiverPhone.value.trim(),

fromProvince: originProvince.value,
fromQuartier: originProvince.value==="Bujumbura" ? (originQuartier.value || "‚Äî") : "‚Äî",
fromLandmark: originLandmark.value.trim() || null,

toProvince: destProvince.value,
toQuartier: destProvince.value==="Bujumbura" ? (destQuartier.value || "‚Äî") : "‚Äî",
toLandmark: destLandmark.value.trim() || null,

packageType: packageType.value,
declaredValue: declared>0 ? declared : null,
details,

content: content.value.trim() || null,
notes: notes.value.trim() || null,

nonDangerous:true,

paymentMethod: paymentMethod.value,
paymentStatus:"unpaid",
status:"created",

priceCalculated:true,
finalPrice,
priceBreakdown,

createdAt: serverTimestamp()
});

showOk("Envoi cr√©√©. Redirection‚Ä¶");
location.href = "confirmation.html?tracking=" + encodeURIComponent(tracking);

}catch(e){
showError(e.message || "Erreur inconnue.");
setLoading(false);
}
});
</script>

</body>
</html>
