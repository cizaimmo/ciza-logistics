<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Suivi colis | Ciza Logistics</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:Arial,Helvetica,sans-serif;background:#f5f7fa;color:#111;}
.container{width:92%;max-width:1100px;margin:auto;}
html{scroll-behavior:smooth;}

.main-header{position:fixed;width:100%;background:#000;padding:22px 0;z-index:1000;}
.header-container{display:flex;justify-content:space-between;align-items:center;}
.logo img{height:90px;}
.nav-menu{display:flex;gap:22px;align-items:center;}
.nav-menu a{color:#fff;text-decoration:none;text-transform:uppercase;font-size:13px;letter-spacing:1px;}
.nav-menu a:hover{color:#D4AF37;}

.hero{padding-top:170px;padding-bottom:40px;}
.hero-box{background:#000;color:#fff;border-radius:28px;padding:35px;box-shadow:0 30px 80px rgba(0,0,0,0.2);border:1px solid rgba(212,175,55,0.3);}
.hero-box h1{font-size:32px;margin-bottom:10px;}
.hero-box p{color:#ccc;}

.track-card{background:#fff;border-radius:28px;padding:30px;margin-top:25px;box-shadow:0 30px 80px rgba(0,0,0,0.1);border:1px solid rgba(212,175,55,0.25);}
.track-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;margin-bottom:25px;}
.track-code{font-weight:900;font-size:18px;color:#D4AF37;}
.status-badge{padding:8px 16px;border-radius:999px;background:#000;color:#fff;font-size:12px;}

.timeline{position:relative;margin-top:20px;}
.timeline:before{content:"";position:absolute;left:12px;top:0;width:3px;height:100%;background:rgba(212,175,55,0.3);}
.step{position:relative;margin-left:35px;margin-bottom:35px;}
.step:before{content:"";position:absolute;left:-25px;top:4px;width:18px;height:18px;border-radius:50%;background:#fff;border:3px solid #ccc;}
.step.active:before{border-color:#D4AF37;background:#D4AF37;transition:0.4s ease;}
.step h3{font-size:14px;margin-bottom:5px;}
.step p{font-size:13px;color:#666;}

.estimate-box{margin-top:20px;padding:15px;border-radius:14px;background:rgba(212,175,55,0.1);font-size:14px;}

.driver-card{display:none;margin-top:20px;padding:18px;border-radius:20px;background:#000;color:#fff;border:1px solid rgba(212,175,55,0.25);}
.driver-photo{width:60px;height:60px;border-radius:16px;object-fit:cover;display:none;border:1px solid rgba(212,175,55,0.4);}
.driver-btn{display:block;margin-top:12px;padding:12px;border-radius:14px;background:#D4AF37;color:#000;text-align:center;font-weight:900;text-decoration:none;}

.otp-box{margin-top:20px;padding:15px;border-radius:16px;background:#000;color:#fff;font-weight:900;letter-spacing:3px;text-align:center;display:none;}
.photo-box{margin-top:20px;display:none;}
.photo-box img{width:100%;border-radius:18px;border:1px solid rgba(212,175,55,0.4);}
.pdf-btn{margin-top:20px;display:none;padding:12px 20px;background:#D4AF37;color:#000;font-weight:900;border:none;border-radius:14px;cursor:pointer;}

.footer{background:#000;color:#fff;padding:40px 0;text-align:center;margin-top:60px;}
.footer strong{color:#D4AF37;}
</style>
</head>

<body>

<section class="container" style="padding-top:180px;">
<div class="track-card">

<div class="track-header">
<div class="track-code" id="trackCode">Tracking : —</div>
<div class="status-badge" id="statusBadge">Chargement...</div>
</div>

<div class="timeline">
<div class="step" id="s1"><h3>Création</h3><p>Envoi enregistré.</p></div>
<div class="step" id="s2"><h3>Paiement</h3><p>En attente.</p></div>
<div class="step" id="s3"><h3>Ramassage</h3><p>Colis pris en charge.</p></div>
<div class="step" id="s4"><h3>En transit</h3><p>En route.</p></div>
<div class="step" id="s5"><h3>Livré</h3><p>Remis au destinataire.</p></div>
</div>

<div class="estimate-box" id="estimateBox"></div>

<div class="driver-card" id="driverCard">
<div id="driverName" style="font-weight:900;font-size:18px;"></div>
<div id="driverMeta" style="margin-top:6px;font-size:13px;color:#ccc;"></div>
<img id="driverPhoto" class="driver-photo"/>
<a id="driverCallBtn" class="driver-btn">Appeler le chauffeur</a>
</div>

<div class="otp-box" id="otpBox"></div>
<div class="photo-box" id="photoBox"><img id="deliveryPhoto"></div>
<button class="pdf-btn" id="pdfBtn">Télécharger preuve officielle (PDF)</button>

</div>
</section>

<footer class="footer">
© 2026 <strong>Ciza Logistics</strong>
</footer>

  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const { jsPDF } = window.jspdf;

const firebaseConfig = {
apiKey: "AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
authDomain: "ciza-logistics.firebaseapp.com",
projectId: "ciza-logistics"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const code = new URLSearchParams(window.location.search).get("code");
document.getElementById("trackCode").innerText="Tracking : "+code;

const ref = doc(db,"shipments",code);

onSnapshot(ref,(snap)=>{
if(!snap.exists()) return;
const data=snap.data();
const status=data.status||"created";
updateUI(status,data);
});

function updateUI(status,data){

const badge=document.getElementById("statusBadge");
const estimate=document.getElementById("estimateBox");
const steps=["s1","s2","s3","s4","s5"];
steps.forEach(id=>document.getElementById(id).classList.remove("active"));

if(status==="created"){activate(["s1"]);estimate.innerText="Livraison estimée 24-48h.";}
if(status==="payment_under_review"){activate(["s1","s2"]);document.querySelector("#s2 h3").innerText="Paiement en vérification";}
if(status==="payment_validated"){activate(["s1","s2"]);document.querySelector("#s2 h3").innerText="Paiement validé";}
if(status==="picked_up"){activate(["s1","s2","s3"]);estimate.innerText="Colis ramassé.";}
if(status==="in_transit"){activate(["s1","s2","s3","s4"]);estimate.innerText="Colis en transit.";}
if(status==="delivered"){
activate(["s1","s2","s3","s4","s5"]);
estimate.innerText="Colis livré avec succès.";
document.getElementById("pdfBtn").style.display="inline-block";
}

badge.innerText=status.toUpperCase();
badge.style.background="#000";

updateDriver(data,status);

if(data.deliveryOTP){
document.getElementById("otpBox").style.display="block";
document.getElementById("otpBox").innerText="OTP : "+data.deliveryOTP;
}

if(data.deliveryPhoto){
document.getElementById("photoBox").style.display="block";
document.getElementById("deliveryPhoto").src=data.deliveryPhoto;
}

document.getElementById("pdfBtn").onclick=function(){
generatePremiumPDF(data);
};
}

function updateDriver(data,status){
if(status!=="picked_up"&&status!=="in_transit"&&status!=="delivered"){
document.getElementById("driverCard").style.display="none";
return;
}
document.getElementById("driverCard").style.display="block";
document.getElementById("driverName").innerText=data.driverName||"Chauffeur assigné";
document.getElementById("driverMeta").innerText=
(data.driverVehicleType||"")+" • "+
(data.driverVehiclePlate||"")+" • "+
(data.driverPhone||"");

if(data.driverPhotoUrl){
document.getElementById("driverPhoto").style.display="block";
document.getElementById("driverPhoto").src=data.driverPhotoUrl;
}

if(data.driverPhone){
document.getElementById("driverCallBtn").href="tel:"+data.driverPhone;
}
}

function activate(arr){
arr.forEach(id=>document.getElementById(id).classList.add("active"));
}

/* ===============================
   PDF PREMIUM ENTREPRISE
================================ */

async function generatePremiumPDF(data){

const docPDF=new jsPDF();
const pageWidth = docPDF.internal.pageSize.getWidth();

/* HEADER */
docPDF.setFillColor(0,0,0);
docPDF.rect(0,0,pageWidth,25,"F");

docPDF.setTextColor(255,255,255);
docPDF.setFontSize(14);
docPDF.text("CIZA LOGISTICS",15,15);

docPDF.setFontSize(10);
docPDF.text("Official Proof of Delivery",pageWidth-60,15);

/* BODY */
docPDF.setTextColor(0,0,0);
docPDF.setFontSize(16);
docPDF.text("PROOF OF DELIVERY",15,40);

docPDF.setFontSize(11);
docPDF.text("Tracking Number: "+code,15,50);

const podNumber="POD-"+code+"-"+Date.now().toString().slice(-6);
docPDF.text("Document ID: "+podNumber,15,58);

/* Shipment Info */
docPDF.setFontSize(12);
docPDF.text("Shipment Information",15,75);
docPDF.setFontSize(10);

docPDF.text("Sender: "+(data.senderName||""),15,85);
docPDF.text("Receiver: "+(data.receiverNameConfirmed||data.receiverName||""),15,92);
docPDF.text("Route: "+(data.fromCity||"")+" → "+(data.toCity||""),15,99);

/* Delivery Info */
docPDF.setFontSize(12);
docPDF.text("Delivery Details",15,115);
docPDF.setFontSize(10);

if(data.deliveredAt){
docPDF.text("Delivered At: "+
new Date(data.deliveredAt.seconds*1000).toLocaleString(),
15,125);
}

docPDF.text("Delivered By: "+(data.driverName||""),15,132);
docPDF.text("Vehicle: "+(data.driverVehiclePlate||""),15,139);

/* QR */
const qrContainer=document.createElement("div");
new QRCode(qrContainer,{text:window.location.href,width:100,height:100});
const qrImg=qrContainer.querySelector("img").src;
docPDF.addImage(qrImg,"PNG",pageWidth-60,40,40,40);

/* Photo */
if(data.deliveryPhoto){
docPDF.addImage(data.deliveryPhoto,"JPEG",15,150,80,60);
}

/* Signature */
if(data.receiverSignature){
docPDF.addImage(data.receiverSignature,"PNG",110,150,60,40);
docPDF.text("Receiver Signature",110,195);
}

/* Footer */
docPDF.setFontSize(8);
docPDF.setTextColor(120);
docPDF.text(
"This document is digitally generated and serves as official confirmation of delivery by Ciza Logistics.",
15,280
);

docPDF.save("Ciza_Logistics_POD_"+code+".pdf");
}
</script>

</body>
</html>
