<!-- =========================
   CIZA DRIVER ‚Äì VERSION FINALE STABLE
   Scanner + Tracking + OSRM + OTP + Signature + KPI
   + Navigation intelligente
   + Archivage chauffeur
========================= -->
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="#000000">

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<title>Ciza Driver</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
/* === TON CSS ORIGINAL CONSERV√â === */
:root{
  --gold:#D4AF37;
  --black:#000;
  --bg:#f3f4f6;
  --card:#fff;
  --muted:#6b7280;
  --ok:#16a34a;
  --warn:#f59e0b;
  --bad:#dc2626;
  --blue:#2563eb;
  --purple:#7c3aed;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter;background:var(--bg);color:#111;}
a{color:inherit}
.header{background:rgba(0,0,0,0.96);color:#fff;padding:14px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10;}
.brand{color:var(--gold);font-weight:900;font-size:16px;}
.driverName{font-size:12px;color:#e5e7eb;margin-top:4px;}
.header-right{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end;}
.badge{padding:6px 12px;border-radius:999px;font-weight:900;font-size:12px;background:var(--ok);color:#fff;}
.badge.gold{background:var(--gold);color:#000;}
.badge.warn{background:var(--warn);color:#000;}
.badge.bad{background:var(--bad);color:#fff;}
.badge.blue{background:var(--blue);color:#fff;}
.badge.purple{background:var(--purple);color:#fff;}
.logout-btn{background:var(--gold);border:none;padding:7px 12px;border-radius:12px;font-weight:900;cursor:pointer;}
.container{width:95%;max-width:1100px;margin:16px auto 80px auto;}
.card{background:var(--card);border-radius:18px;padding:16px;margin:14px 0;box-shadow:0 12px 26px rgba(0,0,0,0.06);}
.section-title{font-weight:900;margin:0 0 10px 0;display:flex;justify-content:space-between;}
.small{font-size:12px;color:var(--muted)}
.actionsRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
.btn{border:none;border-radius:14px;padding:12px 14px;font-weight:900;cursor:pointer;}
.btn.full{width:100%;}
.btn.dark{background:#111;color:#fff;}
.btn.gold{background:var(--gold);color:#000;}
.btn.red{background:var(--bad);color:#fff;}
#map{height:280px;border-radius:16px;margin-top:10px;}
</style>
</head>

<body>

<div class="header">
  <div>
    <div class="brand">üöö Ciza Driver</div>
    <div class="driverName" id="driverName">Chargement...</div>
  </div>
  <div class="header-right">
    <span class="badge" id="connectionStatus">En ligne</span>
    <span class="badge" id="gpsStatus">GPS OK</span>
    <span class="badge gold" id="deliveryCounter">0</span>
    <button class="logout-btn" id="logoutBtn">D√©connexion</button>
  </div>
</div>

<div class="container">

<div class="card">
  <div class="section-title">
    üì¶ D√©tails & Navigation
    <span class="small" id="selectedHint">S√©lectionne un colis</span>
  </div>

  <div id="shipmentDetails">Aucun colis s√©lectionn√©</div>
  <div id="map"></div>

  <div class="actionsRow">
    <button class="btn gold full" id="mainActionBtn" style="display:none;">Action</button>
    <button class="btn dark full" id="navBtn" style="display:none;">üß≠ Ouvrir Navigation</button>
    <button class="btn red full" id="archiveBtn" style="display:none;">üì¶ Archiver</button>
  </div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, query, where, onSnapshot, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyCIUVom1diEV4ESa3QEcICOZRv0TNSydx8",
  authDomain:"ciza-logistics.firebaseapp.com",
  projectId:"ciza-logistics"
});

const db = getFirestore(app);
const auth = getAuth(app);

let selectedShipment=null;
let selectedShipmentId=null;
let lastLat=null,lastLng=null;

let map = L.map('map').setView([-3.3731,29.9189],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

navigator.geolocation.watchPosition(pos=>{
  lastLat=pos.coords.latitude;
  lastLng=pos.coords.longitude;
});

onAuthStateChanged(auth, async(user)=>{
  if(!user){location.href="login.html";return;}
});

document.getElementById("logoutBtn").onclick=async()=>{
  await signOut(auth);
  location.href="login.html";
};

/* ======================
   NAVIGATION
====================== */
document.getElementById("navBtn").onclick=function(){
  if(!selectedShipment) return alert("S√©lectionne un colis.");
  if(!lastLat || !lastLng) return alert("GPS indisponible.");
  if(!selectedShipment.toLat || !selectedShipment.toLng) return alert("Destination manquante.");

  const st=selectedShipment.status;
  if(!(st==="picked_up"||st==="in_transit")) return alert("Navigation disponible uniquement en transit.");

  window.open(`https://www.google.com/maps/dir/?api=1&origin=${lastLat},${lastLng}&destination=${selectedShipment.toLat},${selectedShipment.toLng}`,"_blank");
};

/* ======================
   ARCHIVAGE
====================== */
document.getElementById("archiveBtn").onclick=async()=>{
  if(!selectedShipmentId) return;
  await updateDoc(doc(db,"shipments",selectedShipmentId),{
    archivedByDriver:true,
    archivedAt:serverTimestamp()
  });
  alert("Colis archiv√©.");
};

/* ======================
   UI REFRESH
====================== */
function refreshUI(){
  if(!selectedShipment){
    document.getElementById("shipmentDetails").innerText="Aucun colis s√©lectionn√©";
    return;
  }

  const d=selectedShipment;

  document.getElementById("shipmentDetails").innerHTML=`
    <b>${d.trackingCode||d.id}</b><br>
    üìç ${d.fromCity||""} ‚Üí ${d.toCity||""}<br>
    üë§ ${d.receiverName||d.senderName||""}<br>
    üìû ${d.receiverPhone||d.senderPhone||""}<br>
    üè† ${d.destinationAddress||d.toAddress||""}<br>
    üìù ${d.deliveryNote||""}
  `;

  document.getElementById("navBtn").style.display=
    (d.status==="picked_up"||d.status==="in_transit")?"block":"none";

  document.getElementById("archiveBtn").style.display=
    (d.status==="delivered")?"block":"none";
}
</script>

</body>
</html>
